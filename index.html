<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>דוח של"ח</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { overflow-x: hidden; max-width: 100%; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #f0f2f5;
      color: #222;
      direction: rtl;
      overflow-x: hidden;
    }

    header {
      background: #000000;
      color: white;
      padding: 18px 36px;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.3px;
    }

    .tabs {
      display: flex;
      background: #111111;
      padding: 0 36px;
    }

    .tab {
      padding: 14px 28px;
      color: #888;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-size: 14px;
      transition: all 0.2s;
    }

    .tab.active {
      color: #ffffff;
      border-bottom-color: #2ecc71;
    }

    .page { display: none; padding: 36px; }
    .page.active { display: block; }

    .card {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 720px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.08);
      border: 1px solid #e8e8e8;
    }

    .card h2 {
      font-size: 18px;
      color: #111111;
      border-bottom: 2px solid #2ecc71;
      padding-bottom: 12px;
      margin-bottom: 28px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-group.full {
      grid-column: 1 / -1;
    }

    label {
      font-size: 12px;
      color: #666;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input {
      border: 1.5px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 15px;
      font-family: inherit;
      direction: rtl;
      transition: border-color 0.2s;
    }

    input:focus {
      outline: none;
      border-color: #2ecc71;
      box-shadow: 0 0 0 3px rgba(46,204,113,0.15);
    }

    .section-title {
      font-size: 11px;
      font-weight: 700;
      color: #2ecc71;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin: 24px 0 14px;
      grid-column: 1 / -1;
    }

    .hours-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      grid-column: 1 / -1;
    }

    .hours-grid .day-label {
      text-align: center;
      font-size: 13px;
      font-weight: 700;
      color: #333;
    }

    .hours-grid input {
      text-align: center;
      padding: 8px 4px;
    }

    .btn-save {
      margin-top: 24px;
      background: #111111;
      color: white;
      border: none;
      padding: 12px 36px;
      font-size: 15px;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
      transition: background 0.2s;
    }

    .btn-save:hover { background: #2ecc71; color: #111; }

    .save-msg {
      display: inline-block;
      margin-right: 12px;
      color: #2ecc71;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .save-msg.show { opacity: 1; }

    .btn-print {
      margin-right: auto;
      background: #2ecc71;
      color: #111111;
      border: none;
      padding: 9px 22px;
      font-size: 15px;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 700;
    }
    .btn-print:hover { background: #27ae60; }

    .btn-clear {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 9px 22px;
      font-size: 15px;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
    }
    .btn-clear:hover { background: #c0392b; }

    .btn-excel {
      background: #1d6f42;
      color: white;
      border: none;
      padding: 9px 22px;
      font-size: 15px;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
    }
    .btn-excel:hover { background: #155232; }

    .btn-sign {
      background: #7d3c98;
      color: white;
      border: none;
      padding: 9px 22px;
      font-size: 15px;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
    }
    .btn-sign:hover { background: #6c3483; }

    /* מודל שיתוף לינק חתימה */
    #signModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    #signModal.open { display: flex; }
    .sign-modal-box {
      background: white;
      border-radius: 16px;
      padding: 28px;
      width: 92%;
      max-width: 500px;
      direction: rtl;
      box-shadow: 0 8px 40px rgba(0,0,0,0.25);
    }
    .sign-modal-box h2 { margin: 0 0 8px; font-size: 18px; }
    .sign-modal-box p  { color: #555; font-size: 14px; margin: 0 0 20px; }
    #signLink {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 13px;
      direction: ltr;
      text-align: left;
      background: #f8f8f8;
      box-sizing: border-box;
      margin-bottom: 12px;
    }
    #signCopyBtn {
      background: #7d3c98;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 22px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      margin-left: 10px;
    }
    #signCopyBtn:hover { background: #6c3483; }
    .sign-status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 16px;
    }
    .sign-status-badge.pending  { background: #fff3cd; color: #856404; }
    .sign-status-badge.signed   { background: #d4edda; color: #155724; }

    /* עמוד חתימת מנהל */
    #principalPage {
      display: none;
      min-height: 100vh;
      background: #f0f2f5;
      padding: 24px 16px;
      box-sizing: border-box;
    }
    #principalPage.active { display: block; }
    .principal-card {
      background: white;
      border-radius: 14px;
      padding: 24px;
      max-width: 500px;
      margin: 0 auto 20px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      direction: rtl;
    }
    .principal-card h1 { font-size: 20px; margin: 0 0 6px; color: #222; }
    .principal-card .subtitle { color: #666; font-size: 14px; margin: 0 0 20px; }
    .principal-info-row { font-size: 15px; margin-bottom: 8px; color: #333; }
    .principal-info-row strong { color: #111; }
    #principalSigCanvas {
      width: 100%;
      height: 160px;
      border: 2px dashed #bbb;
      border-radius: 10px;
      cursor: crosshair;
      background: #fafafa;
      display: block;
      touch-action: none;
    }
    .principal-sig-label {
      font-size: 14px;
      color: #555;
      margin: 18px 0 8px;
      font-weight: 600;
    }
    #principalSubmitBtn {
      width: 100%;
      background: #7d3c98;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 14px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      margin-top: 14px;
    }
    #principalSubmitBtn:hover { background: #6c3483; }
    #principalClearBtn {
      background: none;
      border: none;
      color: #999;
      font-size: 13px;
      cursor: pointer;
      font-family: inherit;
      padding: 4px 0;
      margin-top: 6px;
    }
    #principalSuccess {
      display: none;
      text-align: center;
      padding: 30px 20px;
    }
    #principalSuccess .success-icon { font-size: 56px; margin-bottom: 12px; }
    #principalSuccess h2 { color: #155724; font-size: 22px; margin: 0 0 8px; }
    #principalSuccess p  { color: #555; font-size: 15px; margin: 0; }
    .principal-report-wrap {
      overflow-x: auto;
      margin-top: 16px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .principal-report-wrap table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      direction: rtl;
      min-width: 520px;
    }
    .principal-report-wrap th {
      background: #f5f5f5;
      padding: 7px 8px;
      border: 1px solid #ddd;
      font-weight: 600;
      white-space: nowrap;
      text-align: center;
    }
    .principal-report-wrap td {
      padding: 6px 8px;
      border: 1px solid #eee;
      text-align: center;
    }
    .principal-report-wrap tr:nth-child(even) td { background: #fafafa; }

    /* עמוד PDF — ממוקם מחוץ למסך, ייצואלי בלבד */
    #pdfPage {
      position: fixed;
      left: -9999px;
      top: 0;
      width: 794px;
      min-height: 1123px;
      background: white;
      font-family: 'Times New Roman', Times, serif;
      direction: rtl;
      padding: 20px 23px 20px 78px;
      box-sizing: border-box;
      color: #000;
      font-size: 8.5pt;
    }

    .pdf-tbl {
      width: 100%;
      border-collapse: collapse;
      margin-top: 3px;
    }

    .pdf-tbl th, .pdf-tbl td {
      border: 1px solid #000;
      padding: 2px 3px;
      font-size: 8.5pt;
    }

    /* טבלה חודשית */
    .report-card {
      padding: 28px 36px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.08);
      border: 1px solid #e8e8e8;
    }

    .month-selector {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 24px;
    }

    .month-selector select {
      border: 1.5px solid #e0e0e0;
      border-radius: 8px;
      padding: 8px 14px;
      font-size: 15px;
      font-family: inherit;
      direction: rtl;
    }

    .report-table-wrap {
      overflow-x: auto;
    }

    .report-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    }

    .report-table th {
      background: #111111;
      color: white;
      padding: 11px 8px;
      text-align: center;
      font-weight: 600;
      white-space: nowrap;
      font-size: 13px;
    }

    .report-table td {
      border: 1px solid #ececec;
      padding: 3px 4px;
      text-align: center;
      vertical-align: middle;
    }

    .report-table tbody tr:nth-child(even) {
      background: #fafafa;
    }

    .report-table tbody tr:hover {
      background: #f0fff4;
    }

    .report-table tfoot td {
      background: #111111;
      color: white;
      font-weight: bold;
      padding: 10px 8px;
      border-top: none;
    }

    .report-table input[type="text"] {
      border: none;
      background: transparent;
      width: 100%;
      text-align: center;
      font-size: 14px;
      font-family: inherit;
      padding: 4px 2px;
      direction: rtl;
    }

    .report-table input[type="number"] {
      border: none;
      background: transparent;
      width: 48px;
      text-align: center;
      font-size: 14px;
      font-family: inherit;
      padding: 4px 2px;
    }

    .report-table input:focus {
      outline: 2px solid #2ecc71;
      border-radius: 3px;
      background: #f0fff4;
    }

    /* שורת שבת — מוסתרת */
    .row-shabbat { display: none; }

    /* קו עבה מתחת לשישי — הפרדת שבועות */
    .row-week-end td { border-bottom: 2px solid #ccc !important; }

    /* שורת חג */
    .row-vacation {
      background: #f8f8f8 !important;
      color: #aaa;
    }

    .row-vacation input {
      background: transparent !important;
      color: #aaa;
      font-style: italic;
    }

    /* עמודות צרות — ימים, היעדרות, ש"נ, כיתה */
    .report-table th:nth-child(1), .report-table td:nth-child(1),
    .report-table th:nth-child(2), .report-table td:nth-child(2),
    .report-table th:nth-child(3), .report-table td:nth-child(3),
    .report-table th:nth-child(4), .report-table td:nth-child(4),
    .report-table th:nth-child(5), .report-table td:nth-child(5) {
      width: 52px;
      min-width: 52px;
    }

    /* עמודת תיאור רחבה יותר */
    .report-table th:nth-child(6),
    .report-table td:nth-child(6) {
      width: 220px;
    }

    .report-table th:nth-child(7),
    .report-table td:nth-child(7) {
      width: 180px;
    }

    /* חלק נושאים */
    .notes-section {
      background: white;
      border-radius: 16px;
      padding: 24px 28px;
      margin-top: 24px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.08);
      border: 1px solid #e8e8e8;
    }

    .notes-section h3 {
      font-size: 16px;
      color: #111;
      margin-bottom: 18px;
      border-bottom: 2px solid #2ecc71;
      padding-bottom: 10px;
      font-weight: 700;
    }

    .notes-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
    }

    .notes-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .notes-item label {
      font-size: 12px;
      color: #666;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .notes-item textarea {
      border: 1.5px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 14px;
      font-family: inherit;
      direction: rtl;
      resize: vertical;
      min-height: 80px;
      line-height: 1.5;
    }

    .notes-item textarea:focus {
      outline: none;
      border-color: #2ecc71;
      box-shadow: 0 0 0 3px rgba(46,204,113,0.15);
    }

  /* ===== מובייל ===== */
  @media (max-width: 600px) {

    header {
      padding: 12px 16px;
      font-size: 16px;
    }

    .tabs { padding: 0; }
    .tab {
      flex: 1;
      text-align: center;
      padding: 11px 6px;
      font-size: 13px;
    }

    .page { padding: 14px; }
    .card { padding: 18px; }
    .report-card { padding: 14px; }

    .form-grid { grid-template-columns: 1fr; }
    .form-group.full { grid-column: 1; }

    .card { width: 100%; max-width: 100%; }
    .hours-grid { gap: 4px; grid-template-columns: repeat(3, 1fr); }
    /* סידור: כל לייבל מעל האינפוט שלו — שורה 1: א ב ג, שורה 2: inputs, שורה 3: ד ה ו, שורה 4: inputs */
    .hours-grid > .day-label:nth-child(1) { order: 1; }
    .hours-grid > .day-label:nth-child(2) { order: 2; }
    .hours-grid > .day-label:nth-child(3) { order: 3; }
    .hours-grid > .day-label:nth-child(4) { order: 7; }
    .hours-grid > .day-label:nth-child(5) { order: 8; }
    .hours-grid > .day-label:nth-child(6) { order: 9; }
    .hours-grid > input:nth-child(7)  { order: 4; }
    .hours-grid > input:nth-child(8)  { order: 5; }
    .hours-grid > input:nth-child(9)  { order: 6; }
    .hours-grid > input:nth-child(10) { order: 10; }
    .hours-grid > input:nth-child(11) { order: 11; }
    .hours-grid > input:nth-child(12) { order: 12; }

    input, textarea, select { font-size: 16px !important; }

    .btn-save {
      width: 100%;
      padding: 14px;
      font-size: 16px;
    }

    .month-selector { flex-wrap: wrap; }
    .btn-print {
      width: 100%;
      margin-right: 0;
      padding: 12px;
      font-size: 16px;
    }

    .report-table th {
      padding: 8px 3px;
      font-size: 11px;
    }

    .report-table th:nth-child(1), .report-table td:nth-child(1),
    .report-table th:nth-child(2), .report-table td:nth-child(2),
    .report-table th:nth-child(3), .report-table td:nth-child(3),
    .report-table th:nth-child(4), .report-table td:nth-child(4),
    .report-table th:nth-child(5), .report-table td:nth-child(5) {
      width: 40px;
      min-width: 40px;
    }

    .report-table input {
      min-height: 40px;
      padding: 4px 2px;
    }

    .notes-grid { grid-template-columns: 1fr; }
    .notes-item textarea { min-height: 90px; }

    .notes-section { padding: 14px; }

    .sig-row { flex-direction: column; }
    .sig-date { flex: none; width: 100%; }
  }

  /* חתימה ותאריך */
  .sig-row {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
    align-items: flex-start;
  }
  .sig-date {
    display: flex;
    flex-direction: column;
    gap: 6px;
    flex: 0 0 180px;
  }
  .sig-date input[type="date"] {
    padding: 9px 12px;
    font-size: 15px;
    border: 1.5px solid #e0e0e0;
    border-radius: 8px;
    font-family: inherit;
  }
  .sig-canvas-wrap {
    flex: 1;
    min-width: 240px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  #signatureCanvas {
    border: 1.5px solid #e0e0e0;
    border-radius: 8px;
    background: white;
    cursor: crosshair;
    touch-action: none;
    display: block;
    width: 100%;
    height: 110px;
  }
  .btn-clear-sig {
    border: 1.5px solid #ddd;
    border-radius: 8px;
    background: #f8f8f8;
    color: #666;
    padding: 6px 16px;
    font-size: 13px;
    cursor: pointer;
    align-self: flex-start;
    font-family: inherit;
  }
  .btn-clear-sig:hover { background: #eee; }

  /* ===== אש"ל ===== */
  .eshel-info-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
    margin-bottom: 4px;
  }
  .eshel-info-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .eshel-info-item .info-value {
    font-size: 15px;
    color: #111;
    padding: 8px 0;
    border-bottom: 1.5px solid #e0e0e0;
    min-height: 36px;
  }
  .eshel-info-item .info-value-input {
    font-size: 15px;
    color: #111;
    padding: 6px 6px;
    border: none;
    border-bottom: 2px solid #4a90d9;
    border-radius: 3px;
    background: #f5f8ff;
    width: 100%;
    box-sizing: border-box;
    outline: none;
  }
  .eshel-info-item .info-value-input:focus {
    background: #e8f0fe;
    border-bottom-color: #1a6dd4;
  }
  .eshel-table-wrap {
    overflow-x: auto;
  }
  .eshel-table {
    border-collapse: collapse;
    font-size: 13px;
    background: white;
    min-width: 980px;
    width: 100%;
  }
  .eshel-table th {
    background: #111111;
    color: white;
    padding: 8px 3px;
    text-align: center;
    font-weight: 600;
    font-size: 11px;
    white-space: nowrap;
  }
  .eshel-table td {
    border: 1px solid #ececec;
    padding: 2px 1px;
    text-align: center;
    vertical-align: middle;
  }
  .eshel-table tbody tr:nth-child(even) { background: #fafafa; }
  .eshel-table tbody tr:hover { background: #f0fff4; }
  .eshel-table input[type="text"] {
    border: none;
    background: transparent;
    width: 100%;
    text-align: center;
    font-size: 13px;
    font-family: inherit;
    padding: 3px 1px;
    direction: rtl;
  }
  .eshel-table input[type="date"] {
    border: none;
    background: transparent;
    font-size: 11px;
    font-family: inherit;
    padding: 2px;
    width: 118px;
  }
  .eshel-table input:focus {
    outline: 2px solid #2ecc71;
    border-radius: 3px;
    background: #f0fff4;
  }
  .eshel-table input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: #2ecc71;
  }
  #eshelSigCanvas {
    border: 1.5px solid #e0e0e0;
    border-radius: 8px;
    background: white;
    cursor: crosshair;
    touch-action: none;
    display: block;
    width: 100%;
    height: 110px;
  }
  #eshelPdfPage {
    position: fixed;
    left: -9999px;
    top: 0;
    width: 1122px;
    min-height: 794px;
    background: white;
    font-family: 'Times New Roman', Times, serif;
    direction: rtl;
    padding: 10px 14px;
    box-sizing: border-box;
    color: #000;
    font-size: 8pt;
  }
  /* תאי טבלת ה-PDF הסטטיים */
  #eshelPdfPage .epd-c {
    border: 1px solid #000;
    padding: 4px 2px;
    background: #ffffff;
    text-align: center;
    vertical-align: middle;
    font-size: 8pt;
    height: 26px;
  }
  #eshelPdfPage .epd-c-l {
    border: 1px solid #000;
    padding: 4px 3px;
    background: #ffffff;
    text-align: right;
    vertical-align: middle;
    font-size: 8pt;
    height: 26px;
  }
  @media (max-width: 600px) {
    .eshel-info-grid { grid-template-columns: 1fr 1fr; }
  }

  /* ===== Login Screen ===== */
  #loginOverlay {
    position: fixed; inset: 0;
    background: #0a0a0a;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    z-index: 9999; gap: 0;
  }
  #loginOverlay h1 { color: #fff; font-size: 22px; font-weight: 700; margin-bottom: 10px; text-align: center; padding: 0 20px; }
  #loginOverlay p  { color: #888; font-size: 14px; margin-bottom: 36px; text-align: center; }
  #googleSignInBtn {
    display: flex; align-items: center; gap: 12px;
    background: #fff; color: #333;
    border: none; border-radius: 8px;
    padding: 13px 28px; font-size: 16px; font-weight: 600;
    cursor: pointer; font-family: inherit;
    box-shadow: 0 2px 16px rgba(255,255,255,0.1);
    transition: background 0.15s;
  }
  #googleSignInBtn:hover { background: #f0f0f0; }
  #googleSignInBtn svg { width: 22px; height: 22px; flex-shrink: 0; }
  #loginError { color: #e74c3c; font-size: 13px; margin-top: 18px; display: none; }

  /* ===== User info in header ===== */
  header { display: flex; align-items: center; justify-content: space-between; }
  #headerTitle { flex: 1; }
  #userInfo { display: none; align-items: center; gap: 10px; flex-shrink: 0; }
  #userAvatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.4); object-fit: cover; }
  #userName { font-size: 13px; color: #ccc; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  #logoutBtn {
    background: rgba(255,255,255,0.1); color: #fff;
    border: 1px solid rgba(255,255,255,0.2); border-radius: 6px;
    padding: 5px 12px; font-size: 13px; cursor: pointer; font-family: inherit;
  }
  #logoutBtn:hover { background: rgba(255,255,255,0.2); }
  @media (max-width: 600px) { #userName { display: none; } }
  </style>
</head>
<body>

<!-- עמוד חתימת מנהל (מוצג רק כש-URL מכיל ?sign=) -->
<div id="principalPage">
  <div class="principal-card">
    <h1>✍ חתימת מנהל/ת</h1>
    <p class="subtitle">דוח פעילות ונוכחות — מורה של"ח</p>
    <div id="principalInfo">
      <div class="principal-info-row">טוען פרטים...</div>
    </div>
  </div>

  <div class="principal-card" id="principalReportCard" style="display:none;">
    <strong style="font-size:15px;">פירוט חודשי:</strong>
    <div id="principalReport" class="principal-report-wrap"></div>
  </div>

  <div class="principal-card">
    <div class="principal-sig-label">חתימה:</div>
    <canvas id="principalSigCanvas" width="600" height="200"></canvas>
    <div style="text-align:left;">
      <button id="principalClearBtn" onclick="clearPrincipalSig()">נקה חתימה</button>
    </div>
    <button id="principalSubmitBtn" onclick="submitPrincipalSignature()">חתום ושלח ✓</button>
  </div>
  <div class="principal-card" id="principalSuccess">
    <div class="success-icon">✅</div>
    <h2>החתימה נשלחה בהצלחה!</h2>
    <p>הדוח נחתם ויופיע אצל המורה.</p>
  </div>
</div>

<!-- מסך כניסה -->
<div id="loginOverlay">
  <h1>דוח פעילות ונוכחות — מורה של"ח</h1>
  <p>יש להתחבר עם חשבון Google כדי להמשיך</p>
  <button id="googleSignInBtn" onclick="handleSignIn()">
    <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
      <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
      <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
      <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
      <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
    </svg>
    התחבר עם Google
  </button>
  <div id="loginError">ההתחברות נכשלה. נסה שוב.</div>
</div>

<header>
  <span id="headerTitle">דוח פעילות ונוכחות — מורה של"ח</span>
  <div id="userInfo">
    <img id="userAvatar" src="" alt="">
    <span id="userName"></span>
    <button id="logoutBtn" onclick="handleSignOut()">יציאה</button>
  </div>
</header>

<div class="tabs">
  <div class="tab active" onclick="showPage('settings')">פרטים אישיים</div>
  <div class="tab" onclick="showPage('report')">דוח חודשי</div>
  <div class="tab" onclick="showPage('eshel')">אש"ל</div>
</div>

<!-- דף הגדרות -->
<div class="page active" id="page-settings">
  <div class="card">
    <h2>פרטים קבועים</h2>

    <div class="form-grid">

      <div class="form-group full section-title">פרטי מורה</div>

      <div class="form-group">
        <label>שם פרטי</label>
        <input type="text" id="firstName" placeholder="שם פרטי">
      </div>

      <div class="form-group">
        <label>שם משפחה</label>
        <input type="text" id="lastName" placeholder="שם משפחה">
      </div>

      <div class="form-group">
        <label>מספר זהות</label>
        <input type="text" id="idNumber" placeholder="מספר זהות">
      </div>

      <div class="form-group">
        <label>היקף משרה</label>
        <input type="text" id="jobScope" placeholder="(אופציונלי)">
      </div>

      <div class="form-group">
        <label>כתובת פרטית</label>
        <input type="text" id="address" placeholder="כתובת מגורים">
      </div>

      <div class="form-group">
        <label>במקום מדריך</label>
        <input type="text" id="substituteFor" placeholder="(אופציונלי)">
      </div>

      <div class="form-group">
        <label>מקום מגורים</label>
        <input type="text" id="homeCity" placeholder="עיר / יישוב">
      </div>

      <div class="form-group">
        <label>מקום עבודה</label>
        <input type="text" id="workplace" placeholder="עיר / יישוב">
      </div>

      <div class="form-group full section-title">בית הספר</div>

      <div class="form-group">
        <label>שם בית הספר</label>
        <input type="text" id="schoolName" placeholder="שם בית הספר">
      </div>

      <div class="form-group">
        <label>מחוז</label>
        <input type="text" id="district" placeholder="מחוז">
      </div>

      <div class="form-group full section-title">שעות עבודה שבועיות — מסל של"ח</div>

      <div class="hours-grid">
        <div class="day-label">א'</div>
        <div class="day-label">ב'</div>
        <div class="day-label">ג'</div>
        <div class="day-label">ד'</div>
        <div class="day-label">ה'</div>
        <div class="day-label">ו'</div>
        <input type="number" id="shelach_sun" min="0" max="12" placeholder="0">
        <input type="number" id="shelach_mon" min="0" max="12" placeholder="0">
        <input type="number" id="shelach_tue" min="0" max="12" placeholder="0">
        <input type="number" id="shelach_wed" min="0" max="12" placeholder="0">
        <input type="number" id="shelach_thu" min="0" max="12" placeholder="0">
        <input type="number" id="shelach_fri" min="0" max="12" placeholder="0">
      </div>

      <div class="form-group full section-title">שעות עבודה שבועיות — מסל בי"ס</div>

      <div class="hours-grid">
        <div class="day-label">א'</div>
        <div class="day-label">ב'</div>
        <div class="day-label">ג'</div>
        <div class="day-label">ד'</div>
        <div class="day-label">ה'</div>
        <div class="day-label">ו'</div>
        <input type="number" id="school_sun" min="0" max="12" placeholder="0">
        <input type="number" id="school_mon" min="0" max="12" placeholder="0">
        <input type="number" id="school_tue" min="0" max="12" placeholder="0">
        <input type="number" id="school_wed" min="0" max="12" placeholder="0">
        <input type="number" id="school_thu" min="0" max="12" placeholder="0">
        <input type="number" id="school_fri" min="0" max="12" placeholder="0">
      </div>

      <div class="form-group full section-title">פרטים נוספים לטופס</div>

      <div class="form-group full">
        <label>השעות השבועיות ניתנות בימים</label>
        <input type="text" id="workDays" placeholder="למשל: א׳, ב׳, ד׳">
      </div>

    </div>

    <div style="margin-top: 24px;">
      <button class="btn-save" onclick="saveSettings()">שמור פרטים</button>
      <span class="save-msg" id="saveMsg">✓ נשמר בהצלחה!</span>
    </div>
  </div>
</div>

<!-- דף דוח חודשי -->
<div class="page" id="page-report">
  <div class="report-card">

    <div class="month-selector">
      <label>חודש:</label>
      <select id="selectMonth" onchange="updateCalendar()">

        <option value="8">ספטמבר</option>
        <option value="9">אוקטובר</option>
        <option value="10">נובמבר</option>
        <option value="11">דצמבר</option>
        <option value="0">ינואר</option>
        <option value="1">פברואר</option>
        <option value="2">מרץ</option>
        <option value="3">אפריל</option>
        <option value="4">מאי</option>
        <option value="5">יוני</option>
      </select>
      <label>שנה:</label>
      <select id="selectYear" onchange="updateCalendar()">
        <option value="2025">2025</option>
        <option value="2026">2026</option>
      </select>
      <button class="btn-print" onclick="printReport()">ייצא PDF ⬇</button>
      <button class="btn-excel" onclick="exportReportToExcel()">ייצא אקסל ⬇</button>
      <button class="btn-sign" onclick="createSignatureRequest()">שלח לחתימת מנהל/ת ✍</button>
      <button class="btn-clear" onclick="clearReport()">נקה נתונים</button>
    </div>

    <div class="report-table-wrap">
      <table class="report-table">
        <thead>
          <tr>
            <th>היום<br>בחודש</th>
            <th>היום<br>בשבוע</th>
            <th>שעות<br>היעדרות</th>
            <th>ש"נ/<br>מ"מ</th>
            <th>הכיתה</th>
            <th>תיאור הפעולה</th>
            <th>סיבה להיעדרות<br>או שעות נוספות</th>
          </tr>
        </thead>
        <tbody id="reportBody">
          <tr data-day="1"><td>1</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="2"><td>2</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="3"><td>3</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="4"><td>4</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="5"><td>5</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="6"><td>6</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="7"><td>7</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="8"><td>8</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="9"><td>9</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="10"><td>10</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="11"><td>11</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="12"><td>12</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="13"><td>13</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="14"><td>14</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="15"><td>15</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="16"><td>16</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="17"><td>17</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="18"><td>18</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="19"><td>19</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="20"><td>20</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="21"><td>21</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="22"><td>22</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="23"><td>23</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="24"><td>24</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="25"><td>25</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="26"><td>26</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="27"><td>27</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="28"><td>28</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="29"><td>29</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="30"><td>30</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="31"><td>31</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="2" style="font-weight:bold;">סה"כ שעות:</td>
            <td id="totalHours">0</td>
            <td colspan="4"></td>
          </tr>
        </tfoot>
      </table>
    </div>

  </div>

  <!-- חלק הערות: נושאים, דרכי ביצוע -->
  <div class="notes-section">
    <h3>פרט נושאים, דרכי ביצוע ודרכי פעולה</h3>
    <div class="notes-grid">
      <div class="notes-item">
        <label for="note-chet">שכבת כיתות ח</label>
        <textarea id="note-chet" placeholder="הכנס תוכן..."></textarea>
      </div>
      <div class="notes-item">
        <label for="note-tet">שכבת כיתות ט</label>
        <textarea id="note-tet" placeholder="הכנס תוכן..."></textarea>
      </div>
      <div class="notes-item">
        <label for="note-masaot">מסעות ומפעלים</label>
        <textarea id="note-masaot" placeholder="הכנס תוכן..."></textarea>
      </div>
      <div class="notes-item">
        <label for="note-mishatzim">מש"צים</label>
        <textarea id="note-mishatzim" placeholder="הכנס תוכן..."></textarea>
      </div>
    </div>
  </div>

  <!-- חתימה ותאריך -->
  <div class="notes-section">
    <h3>חתימה ותאריך</h3>
    <div class="sig-row">
      <div class="sig-date">
        <label for="reportDate">תאריך מילוי</label>
        <input type="date" id="reportDate">
      </div>
      <div class="sig-canvas-wrap">
        <label>חתימת המורה (צייר עם האצבע או העכבר)</label>
        <canvas id="signatureCanvas" width="600" height="110"></canvas>
        <button type="button" class="btn-clear-sig" onclick="clearSignature()">✕ נקה חתימה</button>
      </div>
    </div>
    <div id="principalSigStatus" style="margin-top:18px;padding-top:16px;border-top:1px solid #eee;"></div>
  </div>

</div>

<!-- דף אש"ל -->
<div class="page" id="page-eshel">

  <!-- בחירת חודש/שנה -->
  <div class="report-card" style="margin-bottom:20px;">
    <div class="month-selector">
      <label>חודש:</label>
      <select id="eshelMonth" onchange="loadEshel(parseInt(this.value), parseInt(document.getElementById('eshelYear').value))">
        <option value="8">ספטמבר</option>
        <option value="9">אוקטובר</option>
        <option value="10">נובמבר</option>
        <option value="11">דצמבר</option>
        <option value="0">ינואר</option>
        <option value="1">פברואר</option>
        <option value="2">מרץ</option>
        <option value="3">אפריל</option>
        <option value="4">מאי</option>
        <option value="5">יוני</option>
      </select>
      <label>שנה:</label>
      <select id="eshelYear" onchange="loadEshel(parseInt(document.getElementById('eshelMonth').value), parseInt(this.value))">
        <option value="2025">2025</option>
        <option value="2026">2026</option>
      </select>
      <button class="btn-print" onclick="printEshel()">ייצא PDF ⬇</button>
      <button class="btn-excel" onclick="exportEshelToExcel()">ייצא אקסל ⬇</button>
      <button class="btn-clear" onclick="clearEshel()">נקה נתונים</button>
    </div>
  </div>

  <!-- פרטים קבועים (מהגדרות) -->
  <div class="card" style="margin-bottom:20px;max-width:none;">
    <h2>פרטים קבועים</h2>
    <div class="eshel-info-grid">
      <div class="eshel-info-item">
        <label>מספר זהות</label>
        <div class="info-value" id="eshel-info-id"></div>
      </div>
      <div class="eshel-info-item">
        <label>שם פרטי</label>
        <div class="info-value" id="eshel-info-firstname"></div>
      </div>
      <div class="eshel-info-item">
        <label>שם משפחה</label>
        <div class="info-value" id="eshel-info-lastname"></div>
      </div>
      <div class="eshel-info-item">
        <label>מקום מגורים</label>
        <div class="info-value" id="eshel-info-homecity"></div>
      </div>
      <div class="eshel-info-item">
        <label>מקום עבודה</label>
        <div class="info-value" id="eshel-info-workplace"></div>
      </div>
    </div>
  </div>

  <!-- טבלת פעילות -->
  <div class="report-card" style="margin-bottom:20px;">
    <div class="eshel-table-wrap">
      <table class="eshel-table">
        <thead>
          <tr>
            <th>תאריך</th>
            <th>יום<br>בשבוע</th>
            <th>משעה</th>
            <th>עד שעה</th>
            <th>ממקום</th>
            <th>למקום</th>
            <th>מטרת הפעולה</th>
            <th>בין<br>עירוני</th>
            <th>עירוני</th>
            <th>בוקר</th>
            <th>צהריים</th>
            <th>ערב</th>
            <th>לינה<br>במבנה/שטח</th>
            <th>סה"כ</th>
          </tr>
        </thead>
        <tbody id="eshelBody">
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><input type="checkbox" class="eshel-lina"></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><input type="checkbox" class="eshel-lina"></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><input type="checkbox" class="eshel-lina"></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><input type="checkbox" class="eshel-lina"></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><input type="checkbox" class="eshel-lina"></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><input type="checkbox" class="eshel-lina"></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><input type="checkbox" class="eshel-lina"></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><input type="checkbox" class="eshel-lina"></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><input type="checkbox" class="eshel-lina"></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><input type="checkbox" class="eshel-lina"></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><input type="checkbox" class="eshel-lina"></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><input type="checkbox" class="eshel-lina"></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><input type="checkbox" class="eshel-lina"></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><input type="checkbox" class="eshel-lina"></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><input type="checkbox" class="eshel-lina"></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><input type="checkbox" class="eshel-lina"></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><input type="checkbox" class="eshel-lina"></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><input type="checkbox" class="eshel-lina"></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><input type="checkbox" class="eshel-lina"></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><input type="checkbox" class="eshel-lina"></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- חתימה ותאריך -->
  <div class="notes-section" style="margin-bottom:20px;">
    <h3>חתימה ותאריך</h3>
    <div class="sig-row">
      <div class="sig-date">
        <label for="eshelDate">תאריך מילוי</label>
        <input type="date" id="eshelDate">
      </div>
      <div class="sig-canvas-wrap">
        <label>חתימת העובד (צייר עם האצבע או העכבר)</label>
        <canvas id="eshelSigCanvas" width="600" height="110"></canvas>
        <button type="button" class="btn-clear-sig" onclick="clearEshelSignature()">✕ נקה חתימה</button>
      </div>
    </div>
  </div>

</div>

<!-- עמוד PDF — מחוץ למסך, נוצר דינמית -->
<div id="pdfPage">

  <!-- כותרת עליונה: ימין=שם המשרד, שמאל=פרטי ביה"ס -->
  <!-- בטבלת RTL: עמודה ראשונה = ימין, עמודה שנייה = שמאל -->
  <table style="width:100%;border-collapse:collapse;border:1px solid #000;">
    <tr>
      <td style="text-align:right;padding:6px 10px;vertical-align:top;line-height:1.8;">
        <div style="font-size:14pt;font-weight:bold;">משרד החינוך התרבות, והספורט</div>
        <div style="font-size:11pt;font-weight:bold;">מינהל חברה ונוער</div>
        <div style="font-size:11pt;font-weight:bold;">גף של"ח וידיעת הארץ</div>
      </td>
      <td style="text-align:right;padding:6px 10px;vertical-align:top;border-right:1px solid #000;width:200px;font-size:9pt;line-height:1.9;">
        <div>מחוז: <span id="pdf-district"></span></div>
        <div>שם ביה"ס: <span id="pdf-school"></span></div>
        <div>חודש: <span id="pdf-month"></span></div>
        <div>שנה: <span id="pdf-year"></span></div>
      </td>
    </tr>
  </table>

  <!-- כותרת ראשית -->
  <div style="text-align:center;font-weight:bold;font-size:15pt;border:1px solid #000;border-top:none;padding:5px;">
    דוח פעילות ונוכחות של מורה של"ח בעבודה
  </div>

  <!-- פרטי מורה -->
  <div style="font-weight:bold;font-size:9pt;margin-top:5px;margin-bottom:2px;">פרטי המורה</div>
  <table class="pdf-tbl">
    <tr>
      <th style="width:95px;">מספר זהות</th>
      <th>שם משפחה</th>
      <th>שם פרטי</th>
      <th style="width:95px;">היקף משרה</th>
      <td rowspan="4" style="width:88px;font-size:7.5pt;vertical-align:top;text-align:right;padding:3px;">
        האפשרויות<br>ב"תיאור הפעולה":<br>
        יום שדה, גיחה,<br>
        שירות לאומי, מסע<br>
        ביס"ש
      </td>
    </tr>
    <tr>
      <td id="pdf-id" style="text-align:center;height:22px;"></td>
      <td id="pdf-lastname" style="text-align:center;"></td>
      <td id="pdf-firstname" style="text-align:center;"></td>
      <td id="pdf-jobscope" style="text-align:center;"></td>
    </tr>
    <tr>
      <th colspan="2">כתובת פרטית</th>
      <th>במקום מדריך</th>
      <th></th>
    </tr>
    <tr>
      <td colspan="2" id="pdf-address" style="height:22px;"></td>
      <td id="pdf-substitute"></td>
      <td></td>
    </tr>
  </table>

  <!-- שעות עבודה -->
  <table class="pdf-tbl">
    <tr>
      <td style="text-align:right;width:210px;">שעות העבודה מסל של"ח (כולל שהייה ופרטני)</td>
      <th style="width:38px;text-align:center;">א</th>
      <th style="width:38px;text-align:center;">ב</th>
      <th style="width:38px;text-align:center;">ג</th>
      <th style="width:38px;text-align:center;">ד</th>
      <th style="width:38px;text-align:center;">ה</th>
      <th style="width:38px;text-align:center;">ו</th>
      <td rowspan="2" style="font-size:7.5pt;text-align:right;vertical-align:top;padding:3px;">השעות השבועיות ניתנות בימים:<br><span id="pdf-workdays"></span></td>
    </tr>
    <tr>
      <td style="height:20px;"></td>
      <td id="pdf-sh0" style="text-align:center;"></td>
      <td id="pdf-sh1" style="text-align:center;"></td>
      <td id="pdf-sh2" style="text-align:center;"></td>
      <td id="pdf-sh3" style="text-align:center;"></td>
      <td id="pdf-sh4" style="text-align:center;"></td>
      <td id="pdf-sh5" style="text-align:center;"></td>
    </tr>
    <tr>
      <td style="text-align:right;">שעות העבודה מסל ביה"ס (כולל שהייה ופרטני)</td>
      <td id="pdf-sc0" style="text-align:center;"></td>
      <td id="pdf-sc1" style="text-align:center;"></td>
      <td id="pdf-sc2" style="text-align:center;"></td>
      <td id="pdf-sc3" style="text-align:center;"></td>
      <td id="pdf-sc4" style="text-align:center;"></td>
      <td id="pdf-sc5" style="text-align:center;"></td>
      <td></td>
    </tr>
  </table>

  <!-- טבלת ימים -->
  <table class="pdf-tbl" style="margin-top:4px;table-layout:fixed;direction:rtl;">
    <colgroup>
      <col style="width:50px;">
      <col style="width:47px;">
      <col style="width:56px;">
      <col style="width:32px;">
      <col style="width:53px;">
      <col style="width:86px;">
      <col style="width:107px;">
      <col>
    </colgroup>
    <thead>
      <tr style="background:#e0e0e0;">
        <th style="text-align:center;">היום<br>בחודש</th>
        <th style="text-align:center;">היום<br>בשבוע</th>
        <th style="text-align:center;">שעות<br>היעדרות</th>
        <th style="text-align:center;">ש"נ/<br>מ"מ</th>
        <th style="text-align:center;">הכיתה</th>
        <th style="text-align:center;">תיאור<br>הפעולה</th>
        <th style="text-align:center;">סיבה להיעדרות<br>או שעות נוספות</th>
        <th style="text-align:center;"></th>
      </tr>
    </thead>
    <tbody id="pdf-body"></tbody>
    <tfoot>
      <tr>
        <td colspan="2" style="font-weight:bold;text-align:right;">סה"כ שעות:</td>
        <td id="pdf-total" style="text-align:center;"></td>
        <td colspan="4" style="text-align:right;">חתימת המנהל: ___________________________</td>
        <td></td>
      </tr>
    </tfoot>
  </table>

  <!-- כותרת תחתונה -->
  <div style="margin-top:8px;font-size:8.5pt;line-height:2;">
    <div>מצ"ב המסמכים הבאים: א.__________________ ב.__________________ ג.__________________</div>
    <div>אני מצהיר בזה שהפרטים לעיל נכונים.</div>
  </div>
  <!-- שורת חתימה — טבלה כדי להימנע מבעיות RTL/flex -->
  <table style="width:100%;margin-top:10px;font-size:8.5pt;">
    <tr>
      <!-- ימין: חתימת המורה (עמודה ראשונה = ימין ב-RTL) -->
      <td style="text-align:right;vertical-align:middle;" id="pdf-sig-cell">חתימת המורה: ____________________</td>
      <!-- שמאל: תאריך -->
      <td style="text-align:left;width:160px;" id="pdf-date-cell">תאריך: ___________</td>
    </tr>
  </table>

</div>

<!-- עמוד PDF אש"ל — לרוחב (Landscape A4 = 1122×794px), מחוץ למסך -->
<div id="eshelPdfPage">

  <!-- שורת כותרת + פרטי עובד (הכל בשורה אחת) -->
  <table style="width:100%;border-collapse:collapse;margin-bottom:32px;table-layout:fixed;">
    <colgroup>
      <col style="width:170px;">
      <col style="width:110px;">
      <col style="width:148px;">
      <col style="width:110px;">
      <col style="width:200px;">
      <col style="width:200px;">
      <col style="width:178px;">
    </colgroup>
    <tr>
      <td rowspan="2" style="border:2px solid #000;padding:4px 6px;text-align:center;background:#e8e8e8;vertical-align:middle;">
        <div style="font-size:10pt;font-weight:bold;line-height:1.3;">טופס אש"ל</div>
        <div style="font-size:7pt;margin-top:2px;">משרד החינוך / מינהל חברה ונוער / מורי של"ח</div>
      </td>
      <th style="border:1px solid #000;padding:2px 4px;text-align:center;font-size:7.5pt;background:#e8e8e8;">מ.זהות</th>
      <th style="border:1px solid #000;padding:2px 4px;text-align:center;font-size:7.5pt;background:#e8e8e8;">שם משפחה</th>
      <th style="border:1px solid #000;padding:2px 4px;text-align:center;font-size:7.5pt;background:#e8e8e8;">שם פרטי</th>
      <th style="border:1px solid #000;padding:2px 4px;text-align:center;font-size:7.5pt;background:#e8e8e8;">מקום מגורים</th>
      <th style="border:1px solid #000;padding:2px 4px;text-align:center;font-size:7.5pt;background:#e8e8e8;">מקום עבודה</th>
      <th style="border:1px solid #000;padding:2px 4px;text-align:center;font-size:7.5pt;background:#e8e8e8;">חודש / שנה</th>
    </tr>
    <tr>
      <td id="eshel-pdf-id"        style="border:1px solid #000;padding:3px 4px;text-align:center;font-size:9pt;height:24px;background:#fff;"></td>
      <td id="eshel-pdf-lastname"  style="border:1px solid #000;padding:3px 4px;text-align:center;font-size:9pt;background:#fff;"></td>
      <td id="eshel-pdf-firstname" style="border:1px solid #000;padding:3px 4px;text-align:center;font-size:9pt;background:#fff;"></td>
      <td id="eshel-pdf-homecity"  style="border:1px solid #000;padding:3px 4px;text-align:center;font-size:9pt;background:#fff;"></td>
      <td id="eshel-pdf-workplace" style="border:1px solid #000;padding:3px 4px;text-align:center;font-size:9pt;background:#fff;"></td>
      <td style="border:1px solid #000;padding:3px 4px;text-align:center;font-size:9pt;background:#fff;">
        <span id="eshel-pdf-month"></span> / <span id="eshel-pdf-year"></span>
      </td>
    </tr>
  </table>

  <!-- טבלת פעולות — 20 שורות סטטיות (נמלאות ב-JS) -->
  <table style="width:calc(100% - 64px);margin:0 32px;border-collapse:collapse;table-layout:fixed;">
    <colgroup>
      <col style="width:80px;">
      <col style="width:36px;">
      <col style="width:40px;">
      <col style="width:40px;">
      <col style="width:108px;">
      <col style="width:108px;">
      <col style="width:255px;">
      <col style="width:48px;">
      <col style="width:42px;">
      <col style="width:38px;">
      <col style="width:44px;">
      <col style="width:38px;">
      <col style="width:53px;">
      <col style="width:38px;">
    </colgroup>
    <thead>
      <tr style="background:#d0d0d0;">
        <th style="border:1px solid #000;padding:3px 2px;text-align:center;font-size:7.5pt;">תאריך</th>
        <th style="border:1px solid #000;padding:3px 1px;text-align:center;font-size:7.5pt;">יום</th>
        <th style="border:1px solid #000;padding:3px 1px;text-align:center;font-size:7.5pt;">משעה</th>
        <th style="border:1px solid #000;padding:3px 1px;text-align:center;font-size:7.5pt;">עד שעה</th>
        <th style="border:1px solid #000;padding:3px 2px;text-align:center;font-size:7.5pt;">ממקום</th>
        <th style="border:1px solid #000;padding:3px 2px;text-align:center;font-size:7.5pt;">למקום</th>
        <th style="border:1px solid #000;padding:3px 2px;text-align:center;font-size:7.5pt;">מטרת הפעולה</th>
        <th style="border:1px solid #000;padding:3px 1px;text-align:center;font-size:6.5pt;">בין עירוני</th>
        <th style="border:1px solid #000;padding:3px 1px;text-align:center;font-size:7.5pt;">עירוני</th>
        <th style="border:1px solid #000;padding:3px 1px;text-align:center;font-size:7.5pt;">בוקר</th>
        <th style="border:1px solid #000;padding:3px 1px;text-align:center;font-size:7.5pt;">צהריים</th>
        <th style="border:1px solid #000;padding:3px 1px;text-align:center;font-size:7.5pt;">ערב</th>
        <th style="border:1px solid #000;padding:3px 1px;text-align:center;font-size:6.5pt;">לינה במבנה/ שטח</th>
        <th style="border:1px solid #000;padding:3px 1px;text-align:center;font-size:7.5pt;">סה"כ</th>
      </tr>
    </thead>
    <tbody>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
    </tbody>
  </table>

  <!-- תחתית: הצהרה + חתימות + 3 ריבועי אישור (זה לצד זה) -->
  <table style="width:calc(100% - 64px);margin:4px 32px 0 32px;border-collapse:collapse;">
    <tr>
      <!-- הצהרת עובד -->
      <td style="border:1px solid #000;padding:5px 7px;width:32%;vertical-align:top;background:#fff;">
        <div style="font-weight:bold;font-size:8pt;text-align:center;margin-bottom:3px;">הצהרת עובד</div>
        <div style="font-size:7pt;line-height:1.4;">אני הח"מ מצהיר/ה בזה כי עבדתי בשעות ולנתי במקומות המפורטים לעיל וכי הפרטים הנ"ל נכונים ומדויקים. ידוע לי כי אם אמסור פרטים כוזבים אהיה צפוי/ה לאחריות פלילית.</div>
        <div id="eshel-pdf-sig-cell" style="margin-top:8px;font-size:7.5pt;">חתימת העובד: ____________________________</div>
        <div id="eshel-pdf-date-cell" style="margin-top:5px;font-size:7.5pt;">תאריך: _______________</div>
      </td>
      <!-- אישור ממונה ישיר -->
      <td style="border:1px solid #000;padding:5px 7px;width:26%;vertical-align:top;background:#fff;">
        <div style="font-weight:bold;font-size:8pt;text-align:center;margin-bottom:3px;">אישור ממונה ישיר</div>
        <div style="font-size:7pt;line-height:1.4;">הריני מאשר/ת בזה כי:</div>
        <div style="font-size:7pt;margin-top:3px;">☐ הפעולות המפורטות לעיל בוצעו בפועל ע"י העובד/ת</div>
        <div style="font-size:7pt;margin-top:2px;">☐ ביצוע הפעולות היה הכרחי לצורך התפקיד</div>
        <div style="margin-top:6px;font-size:7.5pt;">שם: ____________________</div>
        <div style="margin-top:4px;font-size:7.5pt;">חתימה: _________________</div>
        <div style="margin-top:4px;font-size:7.5pt;">תאריך: _______________</div>
      </td>
      <!-- אישור אמרכל היחידה -->
      <td style="border:1px solid #000;padding:5px 7px;width:26%;vertical-align:top;background:#fff;">
        <div style="font-weight:bold;font-size:8pt;text-align:center;margin-bottom:3px;">אישור אמרכל היחידה</div>
        <div style="font-size:7pt;line-height:1.4;">בדקתי את הרישומים ומצאתי אותם תואמים את הדיווח.</div>
        <div style="font-size:7pt;margin-top:3px;line-height:1.4;">לעובד/ת אושר לתשלום: _________ ₪</div>
        <div style="margin-top:6px;font-size:7.5pt;">שם: ____________________</div>
        <div style="margin-top:4px;font-size:7.5pt;">חתימה: _________________</div>
        <div style="margin-top:4px;font-size:7.5pt;">תאריך: _______________</div>
      </td>
      <!-- אישור בוחן חשבות -->
      <td style="border:1px solid #000;padding:5px 7px;width:16%;vertical-align:top;background:#fff;">
        <div style="font-weight:bold;font-size:8pt;text-align:center;margin-bottom:3px;">אישור בוחן חשבות</div>
        <div style="margin-top:8px;font-size:7.5pt;">שם: ____________________</div>
        <div style="margin-top:4px;font-size:7.5pt;">חתימה: _________________</div>
        <div style="margin-top:4px;font-size:7.5pt;">תאריך: _______________</div>
      </td>
    </tr>
  </table>

</div>

<script>
  // --- Firebase Auth ---
  const firebaseConfig = {
    apiKey: "AIzaSyDpmHADZLmgJsPBUmpa3_lfeMjtVE1f8Ws",
    authDomain: "shelach-reports.firebaseapp.com",
    projectId: "shelach-reports",
    storageBucket: "shelach-reports.firebasestorage.app",
    messagingSenderId: "890845711067",
    appId: "1:890845711067:web:746dde4901125d1acf9afe"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const provider = new firebase.auth.GoogleAuthProvider();
  const db = firebase.firestore();

  auth.onAuthStateChanged(function(user) {
    if (user) {
      document.getElementById('loginOverlay').style.display = 'none';
      document.getElementById('userInfo').style.display = 'flex';
      document.getElementById('userName').textContent = user.displayName || '';
      const avatar = document.getElementById('userAvatar');
      if (user.photoURL) {
        avatar.src = user.photoURL;
        avatar.style.display = 'block';
      } else {
        avatar.style.display = 'none';
      }
      // Load user data from Firestore after sign-in
      loadSettings();
    } else {
      document.getElementById('loginOverlay').style.display = 'flex';
      document.getElementById('userInfo').style.display = 'none';
    }
  });

  function handleSignIn() {
    document.getElementById('loginError').style.display = 'none';
    auth.signInWithPopup(provider).catch(function(error) {
      console.error('Sign-in error:', error);
      document.getElementById('loginError').style.display = 'block';
    });
  }

  function handleSignOut() {
    auth.signOut();
  }

  // --- Firestore helpers ---
  async function saveToCloud(collection, docId, data) {
    if (!auth.currentUser) return;
    const uid = auth.currentUser.uid;
    await db.collection('users').doc(uid).collection(collection).doc(docId).set(data);
  }

  async function loadFromCloud(collection, docId) {
    if (!auth.currentUser) return null;
    const uid = auth.currentUser.uid;
    const snap = await db.collection('users').doc(uid).collection(collection).doc(docId).get();
    return snap.exists ? snap.data() : null;
  }

  // מעבר בין דפים
  function showPage(name) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('page-' + name).classList.add('active');
    event.target.classList.add('active');
    if (name === 'eshel') refreshEshelInfo();
  }

  // שמירה ב-localStorage
  function saveSettings() {
    const data = {
      firstName:     document.getElementById('firstName').value,
      lastName:      document.getElementById('lastName').value,
      idNumber:      document.getElementById('idNumber').value,
      jobScope:      document.getElementById('jobScope').value,
      address:       document.getElementById('address').value,
      substituteFor: document.getElementById('substituteFor').value,
      homeCity:      document.getElementById('homeCity').value,
      workplace:     document.getElementById('workplace').value,
      schoolName:    document.getElementById('schoolName').value,
      district:      document.getElementById('district').value,
      shelach: [
        document.getElementById('shelach_sun').value,
        document.getElementById('shelach_mon').value,
        document.getElementById('shelach_tue').value,
        document.getElementById('shelach_wed').value,
        document.getElementById('shelach_thu').value,
        document.getElementById('shelach_fri').value,
      ],
      school: [
        document.getElementById('school_sun').value,
        document.getElementById('school_mon').value,
        document.getElementById('school_tue').value,
        document.getElementById('school_wed').value,
        document.getElementById('school_thu').value,
        document.getElementById('school_fri').value,
      ],
      workDays: document.getElementById('workDays').value,
    };

    localStorage.setItem('shelach_settings', JSON.stringify(data));
    saveToCloud('settings', 'main', data);

    const msg = document.getElementById('saveMsg');
    msg.classList.add('show');
    setTimeout(() => msg.classList.remove('show'), 2500);
  }

  // ברירות מחדל
  const DEFAULTS = {
    firstName:     '',
    lastName:      '',
    idNumber:      '',
    jobScope:      '',
    address:       '',
    substituteFor: '',
    homeCity:      '',
    workplace:     '',
    schoolName:    '',
    district:      '',
    shelach:       ['', '', '', '', '', ''],
    school:        ['', '', '', '', '', ''],
  };

  function applySettings(d) {
    document.getElementById('firstName').value     = d.firstName     ?? '';
    document.getElementById('lastName').value      = d.lastName      ?? '';
    document.getElementById('idNumber').value      = d.idNumber      ?? '';
    document.getElementById('jobScope').value      = d.jobScope      ?? '';
    document.getElementById('address').value       = d.address       ?? '';
    document.getElementById('substituteFor').value = d.substituteFor ?? '';
    document.getElementById('homeCity').value      = d.homeCity      ?? '';
    document.getElementById('workplace').value     = d.workplace     ?? '';
    document.getElementById('schoolName').value    = d.schoolName    ?? '';
    document.getElementById('district').value      = d.district      ?? '';

    const days = ['sun','mon','tue','wed','thu','fri'];
    days.forEach((day, i) => {
      document.getElementById('shelach_' + day).value = d.shelach?.[i] ?? '';
      document.getElementById('school_'  + day).value = d.school?.[i]  ?? '';
    });
    document.getElementById('workDays').value = d.workDays ?? '';
  }

  async function loadSettings() {
    // Try Firestore first; fall back to localStorage
    const cloud = await loadFromCloud('settings', 'main');
    if (cloud) {
      applySettings(cloud);
      localStorage.setItem('shelach_settings', JSON.stringify(cloud));
    } else {
      const raw = localStorage.getItem('shelach_settings');
      applySettings(raw ? JSON.parse(raw) : DEFAULTS);
    }
  }

  // שמות ימי שבוע בעברית (0=ראשון, 6=שבת)
  const dayNames = ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'];

  // חופשות משרד החינוך תשפ"ו — חטיבות עליונות
  const VACATIONS = [
    { start: new Date(2025,  8, 22), end: new Date(2025,  8, 24), label: 'ראש השנה' },
    { start: new Date(2025,  9,  1), end: new Date(2025,  9,  2), label: 'יום כיפור' },
    { start: new Date(2025,  9,  3), end: new Date(2025,  9,  5), label: 'גשר' },
    { start: new Date(2025,  9,  6), end: new Date(2025,  9, 14), label: 'סוכות' },
    { start: new Date(2025,  9, 15), end: new Date(2025,  9, 15), label: 'אסרו חג סוכות' },
    { start: new Date(2025, 11, 16), end: new Date(2025, 11, 22), label: 'חנוכה' },
    { start: new Date(2026,  2,  3), end: new Date(2026,  2,  4), label: 'פורים' },
    { start: new Date(2026,  2, 24), end: new Date(2026,  3,  8), label: 'פסח' },
    { start: new Date(2026,  3, 22), end: new Date(2026,  3, 22), label: 'יום העצמאות' },
    { start: new Date(2026,  4,  5), end: new Date(2026,  4,  5), label: 'ל"ג בעומר' },
    { start: new Date(2026,  4, 21), end: new Date(2026,  4, 22), label: 'שבועות' },
    { start: new Date(2026,  5, 20), end: new Date(2026,  7, 31), label: 'חופשת קיץ' },
  ];

  function getVacationLabel(date) {
    const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    for (const v of VACATIONS) {
      if (d >= v.start && d <= v.end) return v.label;
    }
    return null;
  }

  function updateCalendar() {
    const month = parseInt(document.getElementById('selectMonth').value);
    const year  = parseInt(document.getElementById('selectYear').value);

    const daysInMonth = new Date(year, month + 1, 0).getDate();

    document.querySelectorAll('#reportBody tr').forEach(row => {
      const day = parseInt(row.dataset.day);

      if (day > daysInMonth) { row.style.display = 'none'; return; }

      const date    = new Date(year, month, day);
      const weekday = date.getDay();

      if (weekday === 6) { row.style.display = 'none'; return; }

      row.style.display = '';
      row.querySelector('.weekday').textContent = dayNames[weekday];
      weekday === 5 ? row.classList.add('row-week-end') : row.classList.remove('row-week-end');

      const vacation = getVacationLabel(date);
      const inputs   = row.querySelectorAll('input');
      const descInput = inputs[3]; // עמודת "תיאור הפעולה" (אחרי שעות, ש"נ, כיתה)

      if (vacation) {
        row.classList.add('row-vacation');
        row.dataset.vacationLabel = vacation;
      } else {
        row.classList.remove('row-vacation');
        row.dataset.vacationLabel = '';
      }
    });

    loadReport(month, year);
  }

  // --- שמירה וטעינה של נתוני הדוח החודשי ---

  function reportKey(month, year) {
    return 'shelach_report_' + year + '_' + month;
  }

  function saveReport() {
    const month = parseInt(document.getElementById('selectMonth').value);
    const year  = parseInt(document.getElementById('selectYear').value);
    const data  = {};

    document.querySelectorAll('#reportBody tr').forEach(row => {
      if (row.style.display === 'none') return;
      const day    = row.dataset.day;
      const inputs = row.querySelectorAll('input');
      data[day] = {
        hours:       inputs[0].value,
        substitute:  inputs[1].value,
        kita:        inputs[2].value,
        description: inputs[3].value,
        reason:      inputs[4].value,
      };
    });

    data['_notes'] = {
      chet:      document.getElementById('note-chet').value,
      tet:       document.getElementById('note-tet').value,
      masaot:    document.getElementById('note-masaot').value,
      mishatzim: document.getElementById('note-mishatzim').value,
    };
    data['_date']      = document.getElementById('reportDate').value;
    data['_signature'] = sigIsEmpty() ? '' : sigCanvas.toDataURL();

    localStorage.setItem(reportKey(month, year), JSON.stringify(data));
    saveToCloud('reports', reportKey(month, year), data);
  }

  function clearReport() {
    const month = parseInt(document.getElementById('selectMonth').value);
    const year  = parseInt(document.getElementById('selectYear').value);
    const monthName = document.getElementById('selectMonth').selectedOptions[0].text;
    if (!confirm('למחוק את כל הנתונים של ' + monthName + ' ' + year + '?')) return;
    localStorage.removeItem(reportKey(month, year));
    if (auth.currentUser) {
      const uid = auth.currentUser.uid;
      db.collection('users').doc(uid).collection('reports').doc(reportKey(month, year)).delete();
    }
    loadReport(month, year);
  }

  function applyReport(data) {
    document.querySelectorAll('#reportBody tr').forEach(row => {
      const day = row.dataset.day;
      if (!data[day]) return;
      const inputs = row.querySelectorAll('input');
      inputs[0].value = data[day].hours       || '';
      inputs[1].value = data[day].substitute  || '';
      inputs[2].value = data[day].kita        || '';
      inputs[3].value = data[day].description || (row.dataset.vacationLabel || '');
      inputs[4].value = data[day].reason      || '';
    });
    if (data['_notes']) {
      document.getElementById('note-chet').value      = data['_notes'].chet      || '';
      document.getElementById('note-tet').value       = data['_notes'].tet       || '';
      document.getElementById('note-masaot').value    = data['_notes'].masaot    || '';
      document.getElementById('note-mishatzim').value = data['_notes'].mishatzim || '';
    }
    if (data['_date']) document.getElementById('reportDate').value = data['_date'];
    if (data['_signature']) {
      const img = new Image();
      img.onload = () => sigCtx.drawImage(img, 0, 0);
      img.src = data['_signature'];
    }
    updateTotal();
  }

  async function loadReport(month, year) {
    // Clear everything first
    document.querySelectorAll('#reportBody tr').forEach(row => {
      row.querySelectorAll('input').forEach(inp => { inp.value = ''; });
      if (row.dataset.vacationLabel) row.querySelectorAll('input')[3].value = row.dataset.vacationLabel;
    });
    document.getElementById('note-chet').value      = '';
    document.getElementById('note-tet').value       = '';
    document.getElementById('note-masaot').value    = '';
    document.getElementById('note-mishatzim').value = '';
    document.getElementById('reportDate').value     = '';
    sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);

    // Try Firestore first, fall back to localStorage
    const cloud = await loadFromCloud('reports', reportKey(month, year));
    if (cloud) {
      localStorage.setItem(reportKey(month, year), JSON.stringify(cloud));
      applyReport(cloud);
    } else {
      const raw = localStorage.getItem(reportKey(month, year));
      if (!raw) { updateTotal(); }
      else applyReport(JSON.parse(raw));
    }

    // Load principal signature status for this month
    loadPrincipalSignature(month, year);
  }

  // עדכון סה"כ שעות — מסכם את עמודת ש"נ/מ"מ
  function updateTotal() {
    let total = 0;
    document.querySelectorAll('#reportBody tr').forEach(row => {
      if (row.style.display === 'none') return;
      const v = parseFloat(row.querySelectorAll('input')[1].value) || 0;
      total += v;
    });
    document.getElementById('totalHours').textContent = total || 0;
  }

  // שמירה אוטומטית + עדכון סה"כ בכל שינוי
  document.getElementById('reportBody').addEventListener('input', () => {
    saveReport();
    updateTotal();
  });

  // שמירה אוטומטית של הערות הנושאים
  ['note-chet', 'note-tet', 'note-masaot', 'note-mishatzim'].forEach(id => {
    document.getElementById(id).addEventListener('input', saveReport);
  });

  // שמירה אוטומטית של תאריך
  document.getElementById('reportDate').addEventListener('change', saveReport);

  // --- חתימה ---
  const sigCanvas = document.getElementById('signatureCanvas');
  const sigCtx    = sigCanvas.getContext('2d');
  let isDrawing = false, lastX = 0, lastY = 0;

  function sigPos(e) {
    const rect = sigCanvas.getBoundingClientRect();
    const src  = e.touches ? e.touches[0] : e;
    return {
      x: (src.clientX - rect.left) * (sigCanvas.width  / rect.width),
      y: (src.clientY - rect.top)  * (sigCanvas.height / rect.height),
    };
  }

  function sigIsEmpty() {
    return !sigCtx.getImageData(0, 0, sigCanvas.width, sigCanvas.height).data.some(v => v !== 0);
  }

  function clearSignature() {
    sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
    saveReport();
  }

  sigCanvas.addEventListener('mousedown',  e => { isDrawing = true;  const p = sigPos(e); lastX = p.x; lastY = p.y; });
  sigCanvas.addEventListener('mousemove',  e => {
    if (!isDrawing) return;
    const p = sigPos(e);
    sigCtx.beginPath(); sigCtx.moveTo(lastX, lastY); sigCtx.lineTo(p.x, p.y);
    sigCtx.strokeStyle = '#000'; sigCtx.lineWidth = 2; sigCtx.lineCap = 'round';
    sigCtx.stroke();
    lastX = p.x; lastY = p.y;
  });
  sigCanvas.addEventListener('mouseup',    () => { if (isDrawing) { isDrawing = false; saveReport(); } });
  sigCanvas.addEventListener('mouseleave', () => { if (isDrawing) { isDrawing = false; saveReport(); } });

  sigCanvas.addEventListener('touchstart', e => { e.preventDefault(); isDrawing = true;  const p = sigPos(e); lastX = p.x; lastY = p.y; }, { passive: false });
  sigCanvas.addEventListener('touchmove',  e => {
    e.preventDefault();
    if (!isDrawing) return;
    const p = sigPos(e);
    sigCtx.beginPath(); sigCtx.moveTo(lastX, lastY); sigCtx.lineTo(p.x, p.y);
    sigCtx.strokeStyle = '#000'; sigCtx.lineWidth = 2.5; sigCtx.lineCap = 'round';
    sigCtx.stroke();
    lastX = p.x; lastY = p.y;
  }, { passive: false });
  sigCanvas.addEventListener('touchend', () => { if (isDrawing) { isDrawing = false; saveReport(); } });

  // ניווט מקלדת בטבלה
  document.getElementById('reportBody').addEventListener('keydown', function(e) {
    if (!['Enter','ArrowDown','ArrowUp','ArrowLeft','ArrowRight'].includes(e.key)) return;

    // כל ה-inputs הנראים ולא מושבתים — לפי סדר הטאב
    const allInputs = Array.from(
      document.querySelectorAll('#reportBody tr:not(.row-vacation) input:not(:disabled)')
    ).filter(inp => inp.closest('tr').style.display !== 'none');

    const idx = allInputs.indexOf(e.target);
    if (idx === -1) return;

    // ---- חץ שמאל: עבור לתא הבא (שמאלה בדף RTL) רק אם הסמן בסוף הטקסט ----
    if (e.key === 'ArrowLeft') {
      const atEnd = e.target.selectionStart === e.target.value.length
                 && e.target.selectionEnd   === e.target.value.length;
      if (!atEnd) return;
      e.preventDefault();
      const next = allInputs[idx + 1];
      if (next) { next.focus(); next.select(); }
      return;
    }

    // ---- חץ ימין: עבור לתא הקודם (ימינה בדף RTL) רק אם הסמן בתחילת הטקסט ----
    if (e.key === 'ArrowRight') {
      const atStart = e.target.selectionStart === 0
                   && e.target.selectionEnd   === 0;
      if (!atStart) return;
      e.preventDefault();
      const prev = allInputs[idx - 1];
      if (prev) { prev.focus(); prev.select(); }
      return;
    }

    // ---- Enter: תא הבא ----
    if (e.key === 'Enter') {
      e.preventDefault();
      const next = allInputs[idx + 1];
      if (next) next.focus();
      return;
    }

    // ---- חץ למטה / למעלה: אותה עמודה בשורה הסמוכה ----
    e.preventDefault();
    const currentRow = e.target.closest('tr');
    const colIdx     = Array.from(currentRow.querySelectorAll('input')).indexOf(e.target);

    const visibleRows = Array.from(document.querySelectorAll('#reportBody tr'))
      .filter(r => r.style.display !== 'none' && !r.classList.contains('row-vacation'));
    const rowIdx       = visibleRows.indexOf(currentRow);
    const targetRowIdx = e.key === 'ArrowDown' ? rowIdx + 1 : rowIdx - 1;

    if (targetRowIdx < 0 || targetRowIdx >= visibleRows.length) return;
    const destInputs = Array.from(
      visibleRows[targetRowIdx].querySelectorAll('input:not(:disabled)')
    );
    const dest = destInputs[Math.min(colIdx, destInputs.length - 1)];
    if (dest) { dest.focus(); dest.select(); }
  });

  // --- ייצוא PDF ---

  const MONTH_NAMES = {
    8:'ספטמבר', 9:'אוקטובר', 10:'נובמבר', 11:'דצמבר',
    0:'ינואר', 1:'פברואר', 2:'מרץ', 3:'אפריל', 4:'מאי', 5:'יוני'
  };

  // הערות צד ימין לפי מספר יום
  const RIGHT_NOTES = {
    1:  'פרט נושאים, דרכי ביצוע ודרכי פעולה',
    2:  'שכבת כתות: ח',
    7:  'שכבת כתות: ט',
    11: 'שכבת כתות: ___',
    16: 'מסעות ומפעלים',
    21: 'מש"צים',
    24: 'הערות המנחה _______________________',
    27: 'חתימה ___________________________',
    28: 'הערות ממונה מחוזי ________________',
    30: 'חתימה ___________________________',
  };

  async function printReport() {
    const btn = document.querySelector('.btn-print');
    btn.textContent = '⏳ מכין...';
    btn.disabled = true;

    try {
      const month = parseInt(document.getElementById('selectMonth').value);
      const year  = parseInt(document.getElementById('selectYear').value);
      const raw   = localStorage.getItem('shelach_settings');
      const s     = raw ? JSON.parse(raw) : DEFAULTS;

      // מילוי כותרת
      document.getElementById('pdf-district').textContent  = s.district   || '';
      document.getElementById('pdf-school').textContent    = s.schoolName || '';
      document.getElementById('pdf-month').textContent     = MONTH_NAMES[month];
      document.getElementById('pdf-year').textContent      = year;

      // פרטי מורה
      document.getElementById('pdf-id').textContent         = s.idNumber      || '';
      document.getElementById('pdf-lastname').textContent   = s.lastName      || '';
      document.getElementById('pdf-firstname').textContent  = s.firstName     || '';
      document.getElementById('pdf-jobscope').textContent   = s.jobScope      || '';
      document.getElementById('pdf-address').textContent    = s.address       || '';
      document.getElementById('pdf-substitute').textContent = s.substituteFor || '';
      document.getElementById('pdf-workdays').textContent   = s.workDays      || '___________________________';

      // שעות
      [0,1,2,3,4,5].forEach(i => {
        document.getElementById('pdf-sh' + i).textContent = s.shelach?.[i] || '';
        document.getElementById('pdf-sc' + i).textContent = s.school?.[i]  || '';
      });

      // חתימה ותאריך
      const sigDataUrl  = sigIsEmpty() ? '' : sigCanvas.toDataURL();
      const rawDate     = document.getElementById('reportDate').value;
      const dateDisplay = rawDate
        ? new Date(rawDate + 'T00:00:00').toLocaleDateString('he-IL')
        : '___________';

      // קריאת הערות הנושאים
      const pdfNotes = {
        chet:      document.getElementById('note-chet').value,
        tet:       document.getElementById('note-tet').value,
        masaot:    document.getElementById('note-masaot').value,
        mishatzim: document.getElementById('note-mishatzim').value,
      };

      // בניית שורות הטבלה
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const tbody = document.getElementById('pdf-body');
      tbody.innerHTML = '';
      let totalHours = 0;

      for (let day = 1; day <= daysInMonth; day++) {
        const date    = new Date(year, month, day);
        const weekday = date.getDay();
        if (weekday === 6) continue;

        const vacation  = getVacationLabel(date);
        const reportRow = document.querySelector(`#reportBody tr[data-day="${day}"]`);
        const inputs    = reportRow ? reportRow.querySelectorAll('input') : [];

        const hours   = inputs[0]?.value || '';
        const shanan  = inputs[1]?.value || '';
        const kita    = inputs[2]?.value || '';
        const desc    = inputs[3]?.value || '';
        const reason  = inputs[4]?.value || '';
        let note = RIGHT_NOTES[day] || '';
        // הוסף תוכן הערות שמולא על ידי המשתמש
        if (day === 2  && pdfNotes.chet)      note += '<br>' + pdfNotes.chet;
        if (day === 7  && pdfNotes.tet)       note += '<br>' + pdfNotes.tet;
        if (day === 16 && pdfNotes.masaot)    note += '<br>' + pdfNotes.masaot;
        if (day === 21 && pdfNotes.mishatzim) note += '<br>' + pdfNotes.mishatzim;
        // חתימת מנהל/ת בשורה 27
        if (day === 27 && _principalSigData) {
          note = 'חתימת מנהל/ת:<br><img src="' + _principalSigData + '" style="max-height:22px;vertical-align:middle;">';
        }

        if (shanan) totalHours += parseFloat(shanan) || 0;

        const bg = vacation ? '#f0f0f0' : 'transparent';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="border:1px solid #000;padding:1px 2px;text-align:center;background:${bg};">${day}</td>
          <td style="border:1px solid #000;padding:1px 2px;text-align:center;background:${bg};">${dayNames[weekday]}</td>
          <td style="border:1px solid #000;padding:1px 2px;text-align:center;background:${bg};">${hours}</td>
          <td style="border:1px solid #000;padding:1px 2px;text-align:center;background:${bg};">${shanan}</td>
          <td style="border:1px solid #000;padding:1px 2px;text-align:center;background:${bg};">${kita}</td>
          <td colspan="2" style="border:1px solid #000;padding:1px 4px;text-align:right;background:${bg};">${desc}${reason ? ' — ' + reason : ''}</td>
          <td style="border:1px solid #000;padding:1px 4px;text-align:right;font-size:7pt;background:${bg};vertical-align:top;">${note}</td>
        `;
        tbody.appendChild(tr);
      }

      document.getElementById('pdf-total').textContent = totalHours || 0;

      // חתימה ותאריך בתחתית ה-PDF
      const sigCell  = document.getElementById('pdf-sig-cell');
      const dateCell = document.getElementById('pdf-date-cell');
      if (sigDataUrl) {
        sigCell.innerHTML = 'חתימת המורה: <img src="' + sigDataUrl + '" style="height:28px;vertical-align:middle;margin-right:4px;">';
      } else {
        sigCell.textContent = 'חתימת המורה: ____________________';
      }
      dateCell.textContent = 'תאריך: ' + dateDisplay;

      // צילום עם html2canvas
      const canvas = await html2canvas(document.getElementById('pdfPage'), {
        scale: 2,
        useCORS: true,
        logging: false,
        backgroundColor: '#ffffff',
      });

      // יצירת PDF
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
      pdf.addImage(imgData, 'PNG', 0, 0, 210, 297);
      pdf.save(`דוח-שלח-${MONTH_NAMES[month]}-${year}.pdf`);

    } catch(e) {
      alert('שגיאה בייצוא PDF: ' + e.message);
    } finally {
      btn.textContent = 'ייצא PDF ⬇';
      btn.disabled = false;
    }
  }


  // הפעלה ראשונית בטעינת הדף
  updateCalendar();

  // ===== אש"ל =====

  function eshelKey(month, year) {
    return 'eshel_report_' + year + '_' + month;
  }

  // עדכון תצוגת פרטים קבועים מההגדרות
  function refreshEshelInfo() {
    document.getElementById('eshel-info-id').textContent        = document.getElementById('idNumber').value;
    document.getElementById('eshel-info-firstname').textContent = document.getElementById('firstName').value;
    document.getElementById('eshel-info-lastname').textContent  = document.getElementById('lastName').value;
    document.getElementById('eshel-info-homecity').textContent  = document.getElementById('homeCity').value;
    document.getElementById('eshel-info-workplace').textContent = document.getElementById('workplace').value;
  }

  function saveEshel() {
    const month = parseInt(document.getElementById('eshelMonth').value);
    const year  = parseInt(document.getElementById('eshelYear').value);
    const rows  = [];
    document.querySelectorAll('#eshelBody tr').forEach(row => {
      rows.push({
        date:      row.querySelector('.eshel-date').value,
        dayname:   row.querySelector('.eshel-dayname').value,
        fromTime:  row.querySelector('.eshel-from-time').value,
        toTime:    row.querySelector('.eshel-to-time').value,
        fromPlace: row.querySelector('.eshel-from-place').value,
        toPlace:   row.querySelector('.eshel-to-place').value,
        purpose:   row.querySelector('.eshel-purpose').value,
        beinIri:   row.querySelector('.eshel-bein-iri').checked,
        iri:       row.querySelector('.eshel-iri').checked,
        boker:     row.querySelector('.eshel-boker').checked,
        tsaharaim: row.querySelector('.eshel-tsaharaim').checked,
        erev:      row.querySelector('.eshel-erev').checked,
        lina:      row.querySelector('.eshel-lina').checked,
        total:     row.querySelector('.eshel-total').value,
      });
    });
    const data = {
      rows,
      date:      document.getElementById('eshelDate').value,
      signature: eshelSigIsEmpty() ? '' : eshelSigCanvas.toDataURL(),
    };
    localStorage.setItem(eshelKey(month, year), JSON.stringify(data));
    saveToCloud('eshel', eshelKey(month, year), data);
  }

  function applyEshel(data) {
    const rows = document.querySelectorAll('#eshelBody tr');
    (data.rows || []).forEach((rd, i) => {
      if (i >= rows.length) return;
      const row = rows[i];
      row.querySelector('.eshel-date').value        = rd.date      || '';
      row.querySelector('.eshel-dayname').value     = rd.dayname   || '';
      row.querySelector('.eshel-from-time').value   = rd.fromTime  || '';
      row.querySelector('.eshel-to-time').value     = rd.toTime    || '';
      row.querySelector('.eshel-from-place').value  = rd.fromPlace || '';
      row.querySelector('.eshel-to-place').value    = rd.toPlace   || '';
      row.querySelector('.eshel-purpose').value     = rd.purpose   || '';
      row.querySelector('.eshel-bein-iri').checked  = rd.beinIri   || false;
      row.querySelector('.eshel-iri').checked       = rd.iri       || false;
      row.querySelector('.eshel-boker').checked     = rd.boker     || false;
      row.querySelector('.eshel-tsaharaim').checked = rd.tsaharaim || false;
      row.querySelector('.eshel-erev').checked      = rd.erev      || false;
      row.querySelector('.eshel-lina').checked      = rd.lina      || false;
      row.querySelector('.eshel-total').value       = rd.total     || '';
    });
    if (data.date) document.getElementById('eshelDate').value = data.date;
    if (data.signature) {
      const img = new Image();
      img.onload = () => eshelSigCtx.drawImage(img, 0, 0);
      img.src = data.signature;
    }
  }

  async function loadEshel(month, year) {
    // Clear everything first
    document.querySelectorAll('#eshelBody tr').forEach(row => {
      row.querySelector('.eshel-date').value        = '';
      row.querySelector('.eshel-dayname').value     = '';
      row.querySelector('.eshel-from-time').value   = '';
      row.querySelector('.eshel-to-time').value     = '';
      row.querySelector('.eshel-from-place').value  = '';
      row.querySelector('.eshel-to-place').value    = '';
      row.querySelector('.eshel-purpose').value     = '';
      row.querySelector('.eshel-bein-iri').checked  = false;
      row.querySelector('.eshel-iri').checked       = false;
      row.querySelector('.eshel-boker').checked     = false;
      row.querySelector('.eshel-tsaharaim').checked = false;
      row.querySelector('.eshel-erev').checked      = false;
      row.querySelector('.eshel-lina').checked      = false;
      row.querySelector('.eshel-total').value       = '';
    });
    document.getElementById('eshelDate').value = '';
    eshelSigCtx.clearRect(0, 0, eshelSigCanvas.width, eshelSigCanvas.height);

    // Try Firestore first, fall back to localStorage
    const cloud = await loadFromCloud('eshel', eshelKey(month, year));
    if (cloud) {
      localStorage.setItem(eshelKey(month, year), JSON.stringify(cloud));
      applyEshel(cloud);
    } else {
      const raw = localStorage.getItem(eshelKey(month, year));
      if (!raw) return;
      applyEshel(JSON.parse(raw));
    }
  }

  function clearEshel() {
    const month = parseInt(document.getElementById('eshelMonth').value);
    const year  = parseInt(document.getElementById('eshelYear').value);
    const monthName = document.getElementById('eshelMonth').selectedOptions[0].text;
    if (!confirm('למחוק את כל נתוני האש"ל של ' + monthName + ' ' + year + '?')) return;
    localStorage.removeItem(eshelKey(month, year));
    if (auth.currentUser) {
      const uid = auth.currentUser.uid;
      db.collection('users').doc(uid).collection('eshel').doc(eshelKey(month, year)).delete();
    }
    loadEshel(month, year);
  }

  // מילוי אוטומטי של יום בשבוע לפי תאריך
  function fillEshelDay(dateInput) {
    const row = dateInput.closest('tr');
    const dayField = row.querySelector('.eshel-dayname');
    if (!dateInput.value) { dayField.value = ''; saveEshel(); return; }
    const d = new Date(dateInput.value + 'T00:00:00');
    dayField.value = ['ראשון','שני','שלישי','רביעי','חמישי','שישי','שבת'][d.getDay()];
    saveEshel();
  }

  // --- חתימה — אש"ל ---
  const eshelSigCanvas = document.getElementById('eshelSigCanvas');
  const eshelSigCtx    = eshelSigCanvas.getContext('2d');
  let eshelIsDrawing = false, eshelLastX = 0, eshelLastY = 0;

  function eshelSigPos(e) {
    const rect = eshelSigCanvas.getBoundingClientRect();
    const src  = e.touches ? e.touches[0] : e;
    return {
      x: (src.clientX - rect.left) * (eshelSigCanvas.width  / rect.width),
      y: (src.clientY - rect.top)  * (eshelSigCanvas.height / rect.height),
    };
  }

  function eshelSigIsEmpty() {
    return !eshelSigCtx.getImageData(0, 0, eshelSigCanvas.width, eshelSigCanvas.height).data.some(v => v !== 0);
  }

  function clearEshelSignature() {
    eshelSigCtx.clearRect(0, 0, eshelSigCanvas.width, eshelSigCanvas.height);
    saveEshel();
  }

  eshelSigCanvas.addEventListener('mousedown',  e => { eshelIsDrawing = true; const p = eshelSigPos(e); eshelLastX = p.x; eshelLastY = p.y; });
  eshelSigCanvas.addEventListener('mousemove',  e => {
    if (!eshelIsDrawing) return;
    const p = eshelSigPos(e);
    eshelSigCtx.beginPath(); eshelSigCtx.moveTo(eshelLastX, eshelLastY); eshelSigCtx.lineTo(p.x, p.y);
    eshelSigCtx.strokeStyle = '#000'; eshelSigCtx.lineWidth = 2; eshelSigCtx.lineCap = 'round';
    eshelSigCtx.stroke();
    eshelLastX = p.x; eshelLastY = p.y;
  });
  eshelSigCanvas.addEventListener('mouseup',    () => { if (eshelIsDrawing) { eshelIsDrawing = false; saveEshel(); } });
  eshelSigCanvas.addEventListener('mouseleave', () => { if (eshelIsDrawing) { eshelIsDrawing = false; saveEshel(); } });

  eshelSigCanvas.addEventListener('touchstart', e => { e.preventDefault(); eshelIsDrawing = true; const p = eshelSigPos(e); eshelLastX = p.x; eshelLastY = p.y; }, { passive: false });
  eshelSigCanvas.addEventListener('touchmove',  e => {
    e.preventDefault();
    if (!eshelIsDrawing) return;
    const p = eshelSigPos(e);
    eshelSigCtx.beginPath(); eshelSigCtx.moveTo(eshelLastX, eshelLastY); eshelSigCtx.lineTo(p.x, p.y);
    eshelSigCtx.strokeStyle = '#000'; eshelSigCtx.lineWidth = 2.5; eshelSigCtx.lineCap = 'round';
    eshelSigCtx.stroke();
    eshelLastX = p.x; eshelLastY = p.y;
  }, { passive: false });
  eshelSigCanvas.addEventListener('touchend', () => { if (eshelIsDrawing) { eshelIsDrawing = false; saveEshel(); } });

  // שמירה אוטומטית בכל שינוי
  document.getElementById('eshelBody').addEventListener('input', saveEshel);
  document.getElementById('eshelBody').addEventListener('change', saveEshel);
  document.getElementById('eshelDate').addEventListener('change', saveEshel);

  // --- ייצוא PDF — אש"ל ---
  async function printEshel() {
    const btn = document.querySelector('#page-eshel .btn-print');
    btn.textContent = '⏳ מכין...';
    btn.disabled = true;

    try {
      const month = parseInt(document.getElementById('eshelMonth').value);
      const year  = parseInt(document.getElementById('eshelYear').value);
      const raw   = localStorage.getItem('shelach_settings');
      const s     = raw ? JSON.parse(raw) : {};

      // מילוי פרטי עובד
      document.getElementById('eshel-pdf-id').textContent        = s.idNumber  || '';
      document.getElementById('eshel-pdf-lastname').textContent  = s.lastName  || '';
      document.getElementById('eshel-pdf-firstname').textContent = s.firstName || '';
      document.getElementById('eshel-pdf-homecity').textContent  = s.homeCity  || '';
      document.getElementById('eshel-pdf-workplace').textContent = s.workplace || '';
      document.getElementById('eshel-pdf-month').textContent     = MONTH_NAMES[month];
      document.getElementById('eshel-pdf-year').textContent      = year;

      // מילוי שורות הטבלה הסטטיות
      const pdfRows    = document.querySelectorAll('#eshelPdfPage .epd-row');
      const screenRows = document.querySelectorAll('#eshelBody tr');
      pdfRows.forEach((pdfRow, i) => {
        const screenRow = screenRows[i];
        let dt='', dy='', ft='', tt='', fp='', tp='', pu='', bi='', ir='', bk='', ts='', ev='', ln='', tot='';
        if (screenRow) {
          const dateVal = screenRow.querySelector('.eshel-date').value;
          if (dateVal) {
            const d = new Date(dateVal + 'T00:00:00');
            dt = d.toLocaleDateString('he-IL');
          }
          dy  = screenRow.querySelector('.eshel-dayname').value;
          ft  = screenRow.querySelector('.eshel-from-time').value;
          tt  = screenRow.querySelector('.eshel-to-time').value;
          fp  = screenRow.querySelector('.eshel-from-place').value;
          tp  = screenRow.querySelector('.eshel-to-place').value;
          pu  = screenRow.querySelector('.eshel-purpose').value;
          bi  = screenRow.querySelector('.eshel-bein-iri').checked  ? '✓' : '';
          ir  = screenRow.querySelector('.eshel-iri').checked        ? '✓' : '';
          bk  = screenRow.querySelector('.eshel-boker').checked      ? '✓' : '';
          ts  = screenRow.querySelector('.eshel-tsaharaim').checked  ? '✓' : '';
          ev  = screenRow.querySelector('.eshel-erev').checked       ? '✓' : '';
          ln  = screenRow.querySelector('.eshel-lina').checked       ? '✓' : '';
          tot = screenRow.querySelector('.eshel-total').value;
        }
        pdfRow.querySelector('.epd-dt').textContent  = dt  || '\u00A0';
        pdfRow.querySelector('.epd-dy').textContent  = dy  || '\u00A0';
        pdfRow.querySelector('.epd-ft').textContent  = ft  || '\u00A0';
        pdfRow.querySelector('.epd-tt').textContent  = tt  || '\u00A0';
        pdfRow.querySelector('.epd-fp').textContent  = fp  || '\u00A0';
        pdfRow.querySelector('.epd-tp').textContent  = tp  || '\u00A0';
        pdfRow.querySelector('.epd-pu').textContent  = pu  || '\u00A0';
        pdfRow.querySelector('.epd-bi').textContent  = bi  || '\u00A0';
        pdfRow.querySelector('.epd-ir').textContent  = ir  || '\u00A0';
        pdfRow.querySelector('.epd-bk').textContent  = bk  || '\u00A0';
        pdfRow.querySelector('.epd-ts').textContent  = ts  || '\u00A0';
        pdfRow.querySelector('.epd-ev').textContent  = ev  || '\u00A0';
        pdfRow.querySelector('.epd-ln').textContent  = ln  || '\u00A0';
        pdfRow.querySelector('.epd-tot').textContent = tot || '\u00A0';
      });

      // חתימה ותאריך
      const sigDataUrl  = eshelSigIsEmpty() ? '' : eshelSigCanvas.toDataURL();
      const rawDate     = document.getElementById('eshelDate').value;
      const dateDisplay = rawDate
        ? new Date(rawDate + 'T00:00:00').toLocaleDateString('he-IL')
        : '_______________';

      const sigCell  = document.getElementById('eshel-pdf-sig-cell');
      const dateCell = document.getElementById('eshel-pdf-date-cell');
      if (sigDataUrl) {
        sigCell.innerHTML = 'חתימת העובד: <img src="' + sigDataUrl + '" style="height:26px;vertical-align:middle;margin-right:4px;">';
      } else {
        sigCell.textContent = 'חתימת העובד: ________________________________';
      }
      dateCell.textContent = 'תאריך: ' + dateDisplay;

      // צילום עם html2canvas (הדיב הוא 1122×794px — A4 לרוחב)
      const canvas = await html2canvas(document.getElementById('eshelPdfPage'), {
        scale: 2,
        useCORS: true,
        logging: false,
        backgroundColor: '#ffffff',
        width:  1122,
        height: 794,
      });

      // יצירת PDF לרוחב (Landscape A4 = 297×210mm)
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
      pdf.addImage(imgData, 'PNG', 0, 0, 297, 210);
      pdf.save(`אשל-${MONTH_NAMES[month]}-${year}.pdf`);

    } catch(e) {
      alert('שגיאה בייצוא PDF: ' + e.message);
    } finally {
      btn.textContent = 'ייצא PDF ⬇';
      btn.disabled = false;
    }
  }

  // --- ייצוא אקסל ---

  function exportReportToExcel() {
    const month = parseInt(document.getElementById('selectMonth').value);
    const year  = parseInt(document.getElementById('selectYear').value);
    const monthName = MONTH_NAMES[month];

    const s = {
      firstName:  document.getElementById('firstName').value,
      lastName:   document.getElementById('lastName').value,
      idNumber:   document.getElementById('idNumber').value,
      schoolName: document.getElementById('schoolName').value,
    };

    const rows = [['יום בחודש','יום בשבוע','שעות היעדרות','ש"נ/מ"מ','כיתה','תיאור פעילות','סיבת היעדרות']];
    document.querySelectorAll('#reportBody tr').forEach(row => {
      if (row.style.display === 'none') return;
      const inputs = row.querySelectorAll('input');
      rows.push([
        row.dataset.day,
        row.cells[1]?.textContent || '',
        inputs[0]?.value || '',
        inputs[1]?.value || '',
        inputs[2]?.value || '',
        inputs[3]?.value || '',
        inputs[4]?.value || '',
      ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(rows);
    ws['!cols'] = [8,10,14,10,10,30,20].map(w => ({ wch: w }));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, monthName);
    XLSX.writeFile(wb, `דוח-שלח-${monthName}-${year}.xlsx`);
  }

  function exportEshelToExcel() {
    const month = parseInt(document.getElementById('eshelMonth').value);
    const year  = parseInt(document.getElementById('eshelYear').value);
    const monthName = MONTH_NAMES[month];

    const rows = [['תאריך','יום','משעה','עד שעה','ממקום','למקום','מטרת הפעולה','בין-עירוני','עירוני','בוקר','צהריים','ערב','לינה','סה"כ']];
    document.querySelectorAll('#eshelBody tr').forEach(row => {
      rows.push([
        row.querySelector('.eshel-date').value,
        row.querySelector('.eshel-dayname').value,
        row.querySelector('.eshel-from-time').value,
        row.querySelector('.eshel-to-time').value,
        row.querySelector('.eshel-from-place').value,
        row.querySelector('.eshel-to-place').value,
        row.querySelector('.eshel-purpose').value,
        row.querySelector('.eshel-bein-iri').checked  ? 'כן' : '',
        row.querySelector('.eshel-iri').checked        ? 'כן' : '',
        row.querySelector('.eshel-boker').checked      ? 'כן' : '',
        row.querySelector('.eshel-tsaharaim').checked  ? 'כן' : '',
        row.querySelector('.eshel-erev').checked       ? 'כן' : '',
        row.querySelector('.eshel-lina').checked       ? 'כן' : '',
        row.querySelector('.eshel-total').value,
      ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(rows);
    ws['!cols'] = [12,8,8,8,14,14,24,10,8,8,8,8,8,8].map(w => ({ wch: w }));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, monthName);
    XLSX.writeFile(wb, `אשל-${monthName}-${year}.xlsx`);
  }

  // --- חתימת מנהל — טעינה לדוח ---

  let _principalSigData = null; // base64 of principal signature, or null

  async function loadPrincipalSignature(month, year) {
    _principalSigData = null;
    const statusDiv = document.getElementById('principalSigStatus');
    if (!statusDiv) return;

    if (!auth.currentUser) {
      statusDiv.innerHTML = '';
      return;
    }

    statusDiv.innerHTML = '<span style="color:#aaa;font-size:13px;">בודק חתימת מנהל/ת...</span>';

    const uid = auth.currentUser.uid;
    const snap = await db.collection('signature_requests')
      .where('teacherUid', '==', uid)
      .where('year', '==', year)
      .where('month', '==', month)
      .get();

    if (snap.empty || snap.docs[0].data().status !== 'signed') {
      statusDiv.innerHTML = snap.empty
        ? '<span style="color:#aaa;font-size:13px;">חתימת מנהל/ת: טרם נשלחה לחתימה</span>'
        : '<span style="color:#b7860b;font-size:13px;">⏳ ממתין לחתימת מנהל/ת</span>';
      return;
    }

    const sig = snap.docs[0].data().principalSignature;
    _principalSigData = sig;
    statusDiv.innerHTML = `
      <div style="font-size:13px;font-weight:600;color:#155724;margin-bottom:8px;">✓ חתימת מנהל/ת התקבלה</div>
      <img src="${sig}" style="max-height:60px;border:1px solid #ddd;border-radius:6px;padding:4px;background:#fff;">
    `;
  }

  // --- חתימת מנהל ---

  async function createSignatureRequest() {
    if (!auth.currentUser) { alert('יש להתחבר תחילה'); return; }

    const month = parseInt(document.getElementById('selectMonth').value);
    const year  = parseInt(document.getElementById('selectYear').value);
    const monthName = MONTH_NAMES[month];

    const teacherName = [
      document.getElementById('firstName').value,
      document.getElementById('lastName').value,
    ].filter(Boolean).join(' ') || 'מורה';
    const schoolName = document.getElementById('schoolName').value || '';

    // Save current report state first
    saveReport();

    // Collect a snapshot of the report rows for the principal to review
    const reportSnapshot = {};
    const hebDays = ['ראשון','שני','שלישי','רביעי','חמישי','שישי','שבת'];
    document.querySelectorAll('#reportBody tr').forEach(row => {
      if (row.style.display === 'none') return;
      const day = row.dataset.day;
      const inputs = row.querySelectorAll('input');
      const hours = inputs[0]?.value || '';
      const sub   = inputs[1]?.value || '';
      const kita  = inputs[2]?.value || '';
      const desc  = inputs[3]?.value || '';
      const rsn   = inputs[4]?.value || '';
      if (!hours && !sub && !kita && !desc && !rsn) return; // skip empty rows
      const weekday = new Date(year, month, parseInt(day)).getDay();
      reportSnapshot[day] = { hours, substitute: sub, kita, description: desc, reason: rsn, weekday: hebDays[weekday] };
    });

    // Check if a request already exists for this month
    const uid = auth.currentUser.uid;
    const existing = await db.collection('signature_requests')
      .where('teacherUid', '==', uid)
      .where('year', '==', year)
      .where('month', '==', month)
      .get();

    let docId;
    if (!existing.empty) {
      // Reuse existing request — update snapshot to keep it fresh
      docId = existing.docs[0].id;
      await db.collection('signature_requests').doc(docId).update({
        teacherName, schoolName, reportSnapshot,
      });
    } else {
      // Create new request
      const ref = await db.collection('signature_requests').add({
        teacherUid:  uid,
        teacherName: teacherName,
        schoolName:  schoolName,
        month:       month,
        year:        year,
        status:      'pending',
        principalSignature: '',
        reportSnapshot,
        createdAt:   firebase.firestore.FieldValue.serverTimestamp(),
      });
      docId = ref.id;
    }

    const link = window.location.origin + window.location.pathname + '?sign=' + docId;
    document.getElementById('signLink').value = link;

    const status = existing.empty ? 'pending' : existing.docs[0].data().status;
    const badge = document.getElementById('signStatusWrap');
    if (status === 'signed') {
      badge.innerHTML = '<span class="sign-status-badge signed">✓ הדוח נחתם על ידי המנהל/ת</span>';
    } else {
      badge.innerHTML = '<span class="sign-status-badge pending">ממתין לחתימה</span>';
    }

    document.getElementById('signModal').classList.add('open');
  }

  function closeSignModal() {
    document.getElementById('signModal').classList.remove('open');
    document.getElementById('signCopyBtn').textContent = 'העתק לינק';
  }

  function copySignLink() {
    const link = document.getElementById('signLink').value;
    navigator.clipboard.writeText(link).then(() => {
      document.getElementById('signCopyBtn').textContent = '✓ הועתק!';
      setTimeout(() => {
        document.getElementById('signCopyBtn').textContent = 'העתק לינק';
      }, 2000);
    });
  }

  // --- עמוד חתימת מנהל ---

  let _principalDocId = null;
  let _principalIsDrawing = false, _principalLastX = 0, _principalLastY = 0;

  function principalSigPos(e) {
    const canvas = document.getElementById('principalSigCanvas');
    const rect = canvas.getBoundingClientRect();
    const src  = e.touches ? e.touches[0] : e;
    return {
      x: (src.clientX - rect.left) * (canvas.width  / rect.width),
      y: (src.clientY - rect.top)  * (canvas.height / rect.height),
    };
  }

  function principalSigIsEmpty() {
    const canvas = document.getElementById('principalSigCanvas');
    return !canvas.getContext('2d').getImageData(0, 0, canvas.width, canvas.height).data.some(v => v !== 0);
  }

  function clearPrincipalSig() {
    const canvas = document.getElementById('principalSigCanvas');
    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
  }

  function initPrincipalSigCanvas() {
    const canvas = document.getElementById('principalSigCanvas');
    const ctx = canvas.getContext('2d');

    canvas.addEventListener('mousedown', e => {
      _principalIsDrawing = true;
      const p = principalSigPos(e); _principalLastX = p.x; _principalLastY = p.y;
    });
    canvas.addEventListener('mousemove', e => {
      if (!_principalIsDrawing) return;
      const p = principalSigPos(e);
      ctx.beginPath(); ctx.moveTo(_principalLastX, _principalLastY); ctx.lineTo(p.x, p.y);
      ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.stroke();
      _principalLastX = p.x; _principalLastY = p.y;
    });
    canvas.addEventListener('mouseup',    () => { _principalIsDrawing = false; });
    canvas.addEventListener('mouseleave', () => { _principalIsDrawing = false; });
    canvas.addEventListener('touchstart', e => {
      e.preventDefault(); _principalIsDrawing = true;
      const p = principalSigPos(e); _principalLastX = p.x; _principalLastY = p.y;
    }, { passive: false });
    canvas.addEventListener('touchmove', e => {
      e.preventDefault();
      if (!_principalIsDrawing) return;
      const p = principalSigPos(e);
      ctx.beginPath(); ctx.moveTo(_principalLastX, _principalLastY); ctx.lineTo(p.x, p.y);
      ctx.strokeStyle = '#000'; ctx.lineWidth = 2.5; ctx.lineCap = 'round'; ctx.stroke();
      _principalLastX = p.x; _principalLastY = p.y;
    }, { passive: false });
    canvas.addEventListener('touchend', () => { _principalIsDrawing = false; });
  }

  async function initPrincipalPage(docId) {
    _principalDocId = docId;

    // Hide normal app UI, show principal page
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('principalPage').classList.add('active');
    const header = document.querySelector('header');
    const tabs   = document.querySelector('.tabs');
    if (header) header.style.display = 'none';
    if (tabs)   tabs.style.display   = 'none';
    document.querySelectorAll('.page').forEach(p => p.style.display = 'none');

    initPrincipalSigCanvas();

    // Load the request from Firestore
    const snap = await db.collection('signature_requests').doc(docId).get();
    if (!snap.exists) {
      document.getElementById('principalInfo').innerHTML =
        '<div style="color:#c00;">הלינק אינו תקף או פג תוקף.</div>';
      document.getElementById('principalSubmitBtn').style.display = 'none';
      return;
    }

    const data = snap.data();
    const monthName = ['ינואר','פברואר','מרץ','אפריל','מאי','יוני','יולי','אוגוסט','ספטמבר','אוקטובר','נובמבר','דצמבר'][data.month];

    document.getElementById('principalInfo').innerHTML = `
      <div class="principal-info-row">מורה: <strong>${data.teacherName || ''}</strong></div>
      <div class="principal-info-row">בית ספר: <strong>${data.schoolName || ''}</strong></div>
      <div class="principal-info-row">חודש: <strong>${monthName} ${data.year}</strong></div>
    `;

    // Render report snapshot table
    const snapshot = data.reportSnapshot || {};
    const days = Object.keys(snapshot).map(Number).sort((a, b) => a - b);
    if (days.length > 0) {
      let rows = '';
      days.forEach(day => {
        const r = snapshot[day];
        rows += `<tr>
          <td>${day}</td>
          <td>${r.weekday || ''}</td>
          <td>${r.hours || ''}</td>
          <td>${r.substitute || ''}</td>
          <td>${r.kita || ''}</td>
          <td style="text-align:right;">${r.description || ''}</td>
          <td style="text-align:right;">${r.reason || ''}</td>
        </tr>`;
      });
      document.getElementById('principalReport').innerHTML = `
        <table>
          <thead><tr>
            <th>יום</th><th>יום בשבוע</th><th>שעות היעדרות</th><th>ש"נ/מ"מ</th><th>כיתה</th><th>תיאור פעולה</th><th>סיבה</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
      document.getElementById('principalReportCard').style.display = 'block';
    }

    // If already signed, show the existing signature
    if (data.status === 'signed' && data.principalSignature) {
      const canvas = document.getElementById('principalSigCanvas');
      const img = new Image();
      img.onload = () => canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
      img.src = data.principalSignature;
      document.getElementById('principalSubmitBtn').textContent = 'עדכן חתימה ✓';
    }
  }

  async function submitPrincipalSignature() {
    if (principalSigIsEmpty()) {
      alert('יש לחתום לפני השליחה');
      return;
    }

    const canvas = document.getElementById('principalSigCanvas');
    const sigData = canvas.toDataURL();
    const btn = document.getElementById('principalSubmitBtn');
    btn.textContent = '⏳ שולח...';
    btn.disabled = true;

    try {
      await db.collection('signature_requests').doc(_principalDocId).update({
        principalSignature: sigData,
        status:    'signed',
        signedAt:  firebase.firestore.FieldValue.serverTimestamp(),
      });

      // Show success
      document.querySelector('.principal-card:first-of-type').style.display = 'none';
      document.getElementById('principalSuccess').style.display = 'block';
    } catch(e) {
      alert('שגיאה בשליחה: ' + e.message);
      btn.textContent = 'חתום ושלח ✓';
      btn.disabled = false;
    }
  }

  // Check URL for ?sign= param
  (function() {
    const params = new URLSearchParams(window.location.search);
    const signId = params.get('sign');
    if (signId) {
      // Wait for DOM then init principal page (no auth needed)
      document.addEventListener('DOMContentLoaded', () => initPrincipalPage(signId));
      // If DOM is already ready
      if (document.readyState !== 'loading') initPrincipalPage(signId);
    }
  })();

  // הפעלה ראשונית של אש"ל
  loadEshel(
    parseInt(document.getElementById('eshelMonth').value),
    parseInt(document.getElementById('eshelYear').value)
  );
</script>

<!-- מודל שיתוף לינק חתימת מנהל -->
<div id="signModal">
  <div class="sign-modal-box">
    <h2>✍ שלח לחתימת מנהל/ת</h2>
    <p>שלח את הלינק הבא למנהל/ת. הם יוכלו לפתוח אותו, לראות את הדוח ולחתום.</p>
    <div id="signStatusWrap" style="margin-bottom:14px;"></div>
    <input id="signLink" type="text" readonly>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button id="signCopyBtn" onclick="copySignLink()">העתק לינק</button>
      <button onclick="closeSignModal()"
        style="background:#eee;border:none;border-radius:8px;padding:10px 18px;font-size:14px;cursor:pointer;font-family:inherit;">
        סגור
      </button>
    </div>
  </div>
</div>

</body>
</html>
