<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××™×œ×•×™ ×“×•×—×•×ª ×¤×¢×™×œ×•×ª - ××•×¨×™× ×•××•×¨×•×ª ×œ×©×œ"×—</title>
  <meta name="description" content="××™×œ×•×™ ×“×•×—×•×ª ×¤×¢×™×œ×•×ª ×•× ×•×›×—×•×ª ×—×•×“×©×™×™× ×œ××•×¨×™ ×©×œ×´×—">
  <meta property="og:title" content='××™×œ×•×™ ×“×•×—×•×ª ×¤×¢×™×œ×•×ª - ××•×¨×™× ×•××•×¨×•×ª ×œ×©×œ"×—'>
  <meta property="og:description" content="××™×œ×•×™ ×“×•×—×•×ª ×¤×¢×™×œ×•×ª ×•× ×•×›×—×•×ª ×—×•×“×©×™×™× ×œ××•×¨×™ ×©×œ×´×—">
  <meta property="og:type" content="website">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { overflow-x: hidden; max-width: 100%; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #f0f2f5;
      color: #222;
      direction: rtl;
      overflow-x: hidden;
    }

    header {
      background: #000000;
      color: white;
      padding: 18px 36px;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.3px;
    }

    .tabs {
      display: flex;
      background: #111111;
      padding: 0 36px;
    }

    .tab {
      padding: 14px 28px;
      color: #888;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-size: 14px;
      transition: all 0.2s;
    }

    .tab.active {
      color: #ffffff;
      border-bottom-color: #2ecc71;
    }

    .page { display: none; padding: 36px; }
    .page.active { display: block; }

    .card {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 720px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.08);
      border: 1px solid #e8e8e8;
    }

    .card h2 {
      font-size: 18px;
      color: #111111;
      border-bottom: 2px solid #2ecc71;
      padding-bottom: 12px;
      margin-bottom: 28px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-group.full {
      grid-column: 1 / -1;
    }

    label {
      font-size: 12px;
      color: #666;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input {
      border: 1.5px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 15px;
      font-family: inherit;
      direction: rtl;
      transition: border-color 0.2s;
    }

    input:focus {
      outline: none;
      border-color: #2ecc71;
      box-shadow: 0 0 0 3px rgba(46,204,113,0.15);
    }

    .section-title {
      font-size: 11px;
      font-weight: 700;
      color: #2ecc71;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin: 24px 0 14px;
      grid-column: 1 / -1;
    }

    .hours-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      grid-column: 1 / -1;
    }

    .hours-grid .day-label {
      text-align: center;
      font-size: 13px;
      font-weight: 700;
      color: #333;
    }

    .hours-grid input {
      text-align: center;
      padding: 8px 4px;
    }

    .btn-save {
      margin-top: 24px;
      background: #111111;
      color: white;
      border: none;
      padding: 12px 36px;
      font-size: 15px;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
      transition: background 0.2s;
    }

    .btn-save:hover { background: #2ecc71; color: #111; }

    .save-msg {
      display: inline-block;
      margin-right: 12px;
      color: #2ecc71;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .save-msg.show { opacity: 1; }

    .btn-print {
      margin-right: auto;
      background: #2ecc71;
      color: #111111;
      border: none;
      padding: 9px 22px;
      font-size: 15px;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 700;
    }
    .btn-print:hover { background: #27ae60; }

    .btn-clear {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 9px 22px;
      font-size: 15px;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
    }
    .btn-clear:hover { background: #c0392b; }

    .btn-excel {
      background: #1d6f42;
      color: white;
      border: none;
      padding: 9px 22px;
      font-size: 15px;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
    }
    .btn-excel:hover { background: #155232; }

    .btn-sign {
      background: #7d3c98;
      color: white;
      border: none;
      padding: 9px 22px;
      font-size: 15px;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
    }
    .btn-sign:hover { background: #6c3483; }

    /* ××•×“×œ ×ª×¦×•×’×” ××§×“×™××” ×©×œ PDF */
    #pdfPreviewModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    #pdfPreviewModal.open { display: flex; }
    .pdf-preview-box {
      background: #333;
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
      max-width: 95vw;
      max-height: 92vh;
    }
    #pdfPreviewImg {
      max-width: 100%;
      max-height: calc(92vh - 80px);
      border-radius: 4px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.5);
    }
    .pdf-preview-btns {
      display: flex;
      gap: 12px;
    }
    .btn-pdf-download {
      background: #2ecc71;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 28px;
      font-size: 15px;
      font-family: inherit;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-pdf-cancel {
      background: #555;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 15px;
      font-family: inherit;
      cursor: pointer;
    }

    /* ××•×“×œ ×©×™×ª×•×£ ×œ×™× ×§ ×—×ª×™××” */
    #signModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    #signModal.open { display: flex; }
    .sign-modal-box {
      background: white;
      border-radius: 16px;
      padding: 28px;
      width: 92%;
      max-width: 500px;
      direction: rtl;
      box-shadow: 0 8px 40px rgba(0,0,0,0.25);
    }
    .sign-modal-box h2 { margin: 0 0 8px; font-size: 18px; }
    .sign-modal-box p  { color: #555; font-size: 14px; margin: 0 0 20px; }
    #signLink {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 13px;
      direction: ltr;
      text-align: left;
      background: #f8f8f8;
      box-sizing: border-box;
      margin-bottom: 12px;
    }
    #signCopyBtn {
      background: #7d3c98;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 22px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      margin-left: 10px;
    }
    #signCopyBtn:hover { background: #6c3483; }
    .sign-share-row {
      display: flex;
      gap: 10px;
      margin-top: 14px;
      flex-wrap: wrap;
    }
    .sign-share-row span {
      font-size: 13px;
      color: #666;
      align-self: center;
      flex-shrink: 0;
    }
    .btn-share-wa {
      background: #25d366;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      display: flex;
      align-items: center;
      gap: 7px;
    }
    .btn-share-wa:hover { background: #1ebe5d; }
    .btn-share-gmail {
      background: #ea4335;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      display: flex;
      align-items: center;
      gap: 7px;
    }
    .btn-share-gmail:hover { background: #d33426; }
    .sign-status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 16px;
    }
    .sign-status-badge.pending  { background: #fff3cd; color: #856404; }
    .sign-status-badge.signed   { background: #d4edda; color: #155724; }

    /* ×¢××•×“ ×—×ª×™××ª ×× ×”×œ */
    #principalPage {
      display: none;
      min-height: 100vh;
      background: #f0f2f5;
      padding: 24px 16px;
      box-sizing: border-box;
    }
    #principalPage.active { display: block; }
    .principal-card {
      background: white;
      border-radius: 14px;
      padding: 24px;
      max-width: 500px;
      margin: 0 auto 20px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      direction: rtl;
    }
    .principal-card h1 { font-size: 20px; margin: 0 0 6px; color: #222; }
    .principal-card .subtitle { color: #666; font-size: 14px; margin: 0 0 20px; }
    .principal-info-row { font-size: 15px; margin-bottom: 8px; color: #333; }
    .principal-info-row strong { color: #111; }
    #principalSigCanvas {
      width: 100%;
      height: 160px;
      border: 2px dashed #bbb;
      border-radius: 10px;
      cursor: crosshair;
      background: #fafafa;
      display: block;
      touch-action: none;
    }
    .principal-sig-label {
      font-size: 14px;
      color: #555;
      margin: 18px 0 8px;
      font-weight: 600;
    }
    #principalSubmitBtn {
      width: 100%;
      background: #7d3c98;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 14px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      margin-top: 14px;
    }
    #principalSubmitBtn:hover { background: #6c3483; }
    #principalClearBtn {
      background: none;
      border: none;
      color: #999;
      font-size: 13px;
      cursor: pointer;
      font-family: inherit;
      padding: 4px 0;
      margin-top: 6px;
    }
    #principalSuccess {
      display: none;
      text-align: center;
      padding: 30px 20px;
    }
    #principalSuccess .success-icon { font-size: 56px; margin-bottom: 12px; }
    #principalSuccess h2 { color: #155724; font-size: 22px; margin: 0 0 8px; }
    #principalSuccess p  { color: #555; font-size: 15px; margin: 0; }
    .principal-report-wrap {
      overflow-x: auto;
      margin-top: 16px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .principal-report-wrap table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      direction: rtl;
      min-width: 520px;
    }
    .principal-report-wrap th {
      background: #f5f5f5;
      padding: 7px 8px;
      border: 1px solid #ddd;
      font-weight: 600;
      white-space: nowrap;
      text-align: center;
    }
    .principal-report-wrap td {
      padding: 6px 8px;
      border: 1px solid #eee;
      text-align: center;
    }
    .principal-report-wrap tr:nth-child(even) td { background: #fafafa; }

    /* ×¢××•×“ PDF â€” ×××•×§× ××—×•×¥ ×œ××¡×š, ×™×™×¦×•××œ×™ ×‘×œ×‘×“ */
    #pdfPage {
      position: fixed;
      left: -9999px;
      top: 0;
      width: 794px;
      min-height: 1123px;
      background: white;
      font-family: 'Times New Roman', Times, serif;
      direction: rtl;
      padding: 20px 23px 20px 78px;
      box-sizing: border-box;
      color: #000;
      font-size: 8.5pt;
    }

    .pdf-tbl {
      width: 100%;
      border-collapse: collapse;
      margin-top: 3px;
    }

    .pdf-tbl th, .pdf-tbl td {
      border: 1px solid #000;
      padding: 2px 3px;
      font-size: 8.5pt;
    }

    /* ×˜×‘×œ×” ×—×•×“×©×™×ª */
    .report-card {
      padding: 28px 36px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.08);
      border: 1px solid #e8e8e8;
    }

    .month-selector {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 24px;
    }

    .month-selector select {
      border: 1.5px solid #e0e0e0;
      border-radius: 8px;
      padding: 8px 14px;
      font-size: 15px;
      font-family: inherit;
      direction: rtl;
    }

    .report-table-wrap {
      overflow-x: auto;
    }

    .report-table {
      width: auto;
      margin: 0 auto;
      border-collapse: collapse;
      font-size: 14px;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    }

    .report-table th {
      background: #111111;
      color: white;
      padding: 11px 8px;
      text-align: center;
      font-weight: 600;
      white-space: nowrap;
      font-size: 13px;
    }

    .report-table td {
      border: 1px solid #ececec;
      padding: 3px 4px;
      text-align: center;
      vertical-align: middle;
    }

    .report-table tbody tr:nth-child(even) {
      background: #fafafa;
    }

    .report-table tbody tr:hover {
      background: #f0fff4;
    }

    .report-table tfoot td {
      background: #111111;
      color: white;
      font-weight: bold;
      padding: 10px 8px;
      border-top: none;
    }

    .report-table input[type="text"] {
      border: none;
      background: transparent;
      width: 100%;
      text-align: center;
      font-size: 14px;
      font-family: inherit;
      padding: 4px 2px;
      direction: rtl;
    }

    .report-table input[type="number"] {
      border: none;
      background: transparent;
      width: 48px;
      text-align: center;
      font-size: 14px;
      font-family: inherit;
      padding: 4px 2px;
    }

    .report-table input:focus {
      outline: 2px solid #2ecc71;
      border-radius: 3px;
      background: #f0fff4;
    }

    /* ×©×•×¨×ª ×©×‘×ª â€” ××•×¡×ª×¨×ª */
    .row-shabbat { display: none; }

    /* ×§×• ×¢×‘×” ××ª×—×ª ×œ×©×™×©×™ â€” ×”×¤×¨×“×ª ×©×‘×•×¢×•×ª */
    .row-week-end td { border-bottom: 2px solid #ccc !important; }

    /* ×©×•×¨×ª ×—×’ */
    .row-vacation {
      background: #f8f8f8 !important;
      color: #aaa;
    }

    .row-vacation input {
      background: transparent !important;
      color: #aaa;
      font-style: italic;
    }

    /* ×¢××•×“×•×ª ×¦×¨×•×ª â€” ×™××™×, ×”×™×¢×“×¨×•×ª, ×©"× , ×›×™×ª×” */
    .report-table th:nth-child(1), .report-table td:nth-child(1),
    .report-table th:nth-child(2), .report-table td:nth-child(2),
    .report-table th:nth-child(3), .report-table td:nth-child(3),
    .report-table th:nth-child(4), .report-table td:nth-child(4),
    .report-table th:nth-child(5), .report-table td:nth-child(5) {
      width: 62px;
      min-width: 62px;
    }

    /* ×¢××•×“×ª ×ª×™××•×¨ */
    .report-table th:nth-child(6),
    .report-table td:nth-child(6) {
      width: 198px;
      min-width: 198px;
    }

    .report-table th:nth-child(7),
    .report-table td:nth-child(7) {
      width: 162px;
      min-width: 162px;
    }

    /* ×—×œ×§ × ×•×©××™× */
    .notes-section {
      background: white;
      border-radius: 16px;
      padding: 24px 28px;
      margin-top: 24px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.08);
      border: 1px solid #e8e8e8;
    }

    .notes-section h3 {
      font-size: 16px;
      color: #111;
      margin-bottom: 18px;
      border-bottom: 2px solid #2ecc71;
      padding-bottom: 10px;
      font-weight: 700;
    }

    .notes-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 12px;
    }

    .notes-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .notes-item label {
      font-size: 12px;
      color: #666;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .notes-item textarea {
      border: 1.5px solid #e0e0e0;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 13px;
      font-family: inherit;
      direction: rtl;
      resize: vertical;
      min-height: 55px;
      line-height: 1.5;
    }

    .notes-item textarea:focus {
      outline: none;
      border-color: #2ecc71;
      box-shadow: 0 0 0 3px rgba(46,204,113,0.15);
    }

  /* ===== ××•×‘×™×™×œ ===== */
  @media (max-width: 600px) {

    header {
      padding: 12px 16px;
      font-size: 16px;
    }

    .tabs { padding: 0; }
    .tab {
      flex: 1;
      text-align: center;
      padding: 11px 6px;
      font-size: 13px;
    }

    .page { padding: 14px; }
    .card { padding: 18px; }
    .report-card { padding: 14px; }

    .form-grid { grid-template-columns: 1fr; }
    .form-group.full { grid-column: 1; }

    .card { width: 100%; max-width: 100%; }
    .hours-grid { gap: 4px; grid-template-columns: repeat(3, 1fr); }
    /* ×¡×™×“×•×¨: ×›×œ ×œ×™×™×‘×œ ××¢×œ ×”××™× ×¤×•×˜ ×©×œ×• â€” ×©×•×¨×” 1: × ×‘ ×’, ×©×•×¨×” 2: inputs, ×©×•×¨×” 3: ×“ ×” ×•, ×©×•×¨×” 4: inputs */
    .hours-grid > .day-label:nth-child(1) { order: 1; }
    .hours-grid > .day-label:nth-child(2) { order: 2; }
    .hours-grid > .day-label:nth-child(3) { order: 3; }
    .hours-grid > .day-label:nth-child(4) { order: 7; }
    .hours-grid > .day-label:nth-child(5) { order: 8; }
    .hours-grid > .day-label:nth-child(6) { order: 9; }
    .hours-grid > input:nth-child(7)  { order: 4; }
    .hours-grid > input:nth-child(8)  { order: 5; }
    .hours-grid > input:nth-child(9)  { order: 6; }
    .hours-grid > input:nth-child(10) { order: 10; }
    .hours-grid > input:nth-child(11) { order: 11; }
    .hours-grid > input:nth-child(12) { order: 12; }

    input, textarea, select { font-size: 16px !important; }

    .btn-save {
      width: 100%;
      padding: 14px;
      font-size: 16px;
    }

    .month-selector { flex-wrap: wrap; }
    .btn-print, .btn-excel, .btn-sign, .btn-clear {
      width: 100%;
      margin: 0;
      padding: 14px;
      font-size: 16px;
      box-sizing: border-box;
    }

    .report-table th {
      padding: 8px 3px;
      font-size: 11px;
    }

    .report-table th:nth-child(1), .report-table td:nth-child(1),
    .report-table th:nth-child(2), .report-table td:nth-child(2),
    .report-table th:nth-child(3), .report-table td:nth-child(3),
    .report-table th:nth-child(4), .report-table td:nth-child(4),
    .report-table th:nth-child(5), .report-table td:nth-child(5) {
      width: 40px;
      min-width: 40px;
    }

    .report-table input {
      min-height: 40px;
      padding: 4px 2px;
    }

    .notes-grid { grid-template-columns: 1fr; }
    .notes-item textarea { min-height: 90px; }

    .notes-section { padding: 14px; }

    .sig-row { flex-direction: column; }
    .sig-date { flex: none; width: 100%; }
  }

  /* ×—×ª×™××” ×•×ª××¨×™×š */
  .sig-row {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
    align-items: flex-start;
  }
  .sig-date {
    display: flex;
    flex-direction: column;
    gap: 6px;
    flex: 0 0 180px;
  }
  .sig-date input[type="date"] {
    padding: 9px 12px;
    font-size: 15px;
    border: 1.5px solid #e0e0e0;
    border-radius: 8px;
    font-family: inherit;
  }
  .sig-canvas-wrap {
    flex: 1;
    min-width: 240px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  #signatureCanvas {
    border: 1.5px solid #e0e0e0;
    border-radius: 8px;
    background: white;
    cursor: crosshair;
    touch-action: none;
    display: block;
    width: 50%;
    height: 110px;
  }
  .btn-clear-sig {
    border: 1.5px solid #ddd;
    border-radius: 8px;
    background: #f8f8f8;
    color: #666;
    padding: 6px 16px;
    font-size: 13px;
    cursor: pointer;
    align-self: flex-start;
    font-family: inherit;
  }
  .btn-clear-sig:hover { background: #eee; }

  /* ===== ××©"×œ ===== */
  .eshel-info-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
    margin-bottom: 4px;
  }
  .eshel-info-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .eshel-info-item .info-value {
    font-size: 15px;
    color: #111;
    padding: 8px 0;
    border-bottom: 1.5px solid #e0e0e0;
    min-height: 36px;
  }
  .eshel-info-item .info-value-input {
    font-size: 15px;
    color: #111;
    padding: 6px 6px;
    border: none;
    border-bottom: 2px solid #4a90d9;
    border-radius: 3px;
    background: #f5f8ff;
    width: 100%;
    box-sizing: border-box;
    outline: none;
  }
  .eshel-info-item .info-value-input:focus {
    background: #e8f0fe;
    border-bottom-color: #1a6dd4;
  }
  .eshel-table-wrap {
    overflow-x: auto;
  }
  .eshel-table {
    border-collapse: collapse;
    font-size: 13px;
    background: white;
    min-width: 980px;
    width: 100%;
  }
  .eshel-table th {
    background: #111111;
    color: white;
    padding: 8px 3px;
    text-align: center;
    font-weight: 600;
    font-size: 11px;
    white-space: nowrap;
  }
  .eshel-table td {
    border: 1px solid #ececec;
    padding: 2px 1px;
    text-align: center;
    vertical-align: middle;
  }
  .eshel-table tbody tr:nth-child(even) { background: #fafafa; }
  .eshel-table tbody tr:hover { background: #f0fff4; }
  .eshel-table input[type="text"] {
    border: none;
    background: transparent;
    width: 100%;
    text-align: center;
    font-size: 13px;
    font-family: inherit;
    padding: 3px 1px;
    direction: rtl;
  }
  .eshel-table input[type="date"] {
    border: none;
    background: transparent;
    font-size: 11px;
    font-family: inherit;
    padding: 2px;
    width: 118px;
  }
  .eshel-table input:focus {
    outline: 2px solid #2ecc71;
    border-radius: 3px;
    background: #f0fff4;
  }
  .eshel-table input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: #2ecc71;
  }
  #eshelSigCanvas {
    border: 1.5px solid #e0e0e0;
    border-radius: 8px;
    background: white;
    cursor: crosshair;
    touch-action: none;
    display: block;
    width: 50%;
    height: 110px;
  }
  #eshelPdfPage {
    position: fixed;
    left: -9999px;
    top: 0;
    width: 1122px;
    min-height: 794px;
    background: white;
    font-family: 'Times New Roman', Times, serif;
    direction: rtl;
    padding: 10px 14px;
    box-sizing: border-box;
    color: #000;
    font-size: 8pt;
  }
  /* ×ª××™ ×˜×‘×œ×ª ×”-PDF ×”×¡×˜×˜×™×™× */
  #eshelPdfPage .epd-c {
    border: 1px solid #000;
    padding: 4px 2px;
    background: #ffffff;
    text-align: center;
    vertical-align: middle;
    font-size: 8pt;
    height: 26px;
  }
  #eshelPdfPage .epd-c-l {
    border: 1px solid #000;
    padding: 4px 3px;
    background: #ffffff;
    text-align: right;
    vertical-align: middle;
    font-size: 8pt;
    height: 26px;
  }
  @media (max-width: 600px) {
    .eshel-info-grid { grid-template-columns: 1fr 1fr; }
  }

  /* ===== Mode Toggle ===== */
  .mode-toggle {
    display: flex;
    gap: 0;
    margin: 16px 0 20px;
    background: #f0f2f5;
    border-radius: 10px;
    padding: 4px;
    width: fit-content;
  }
  .mode-btn {
    background: transparent;
    border: none;
    border-radius: 7px;
    padding: 8px 18px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    font-family: inherit;
    color: #666;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .mode-btn.active {
    background: #fff;
    color: #111;
    font-weight: 700;
    box-shadow: 0 1px 6px rgba(0,0,0,0.12);
  }
  .mode-btn:hover:not(.active) { color: #333; }

  /* ===== Calendar View ===== */
  .cal-multiselect-bar {
    display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 14px;
  }
  .btn-multiselect {
    background: #f0f2f5; color: #333; border: 2px solid #ddd;
    border-radius: 8px; padding: 8px 16px; font-size: 13px;
    font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.15s;
  }
  .btn-multiselect.active { background: #2980b9; color: #fff; border-color: #2980b9; }
  .btn-multiselect-apply {
    background: #2ecc71; color: #fff; border: none;
    border-radius: 8px; padding: 8px 16px; font-size: 13px;
    font-weight: 600; cursor: pointer; font-family: inherit;
  }
  #multiselect-count { font-size: 13px; color: #666; }
  .cal-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 8px;
    direction: rtl;
  }
  .cal-header {
    text-align: center; font-weight: 700; font-size: 12px; color: #888; padding: 4px 0 8px;
  }
  .cal-day {
    background: #f8f9fa; border-radius: 10px;
    padding: 10px 8px 8px; cursor: pointer;
    min-height: 62px; position: relative;
    border: 2px solid transparent; transition: background 0.12s, border-color 0.12s;
  }
  .cal-day:hover { background: #eafaf1; border-color: #2ecc71; }
  .cal-day.has-data { background: #eafaf1; border-color: #27ae60; }
  .cal-day.vacation { background: #f0f0f0; cursor: pointer; }
  .cal-day.selected { background: #dbeafe; border-color: #2980b9; }
  .cal-day-num { font-size: 17px; font-weight: 700; line-height: 1; color: #222; }
  .cal-day.vacation .cal-day-num { color: #aaa; }
  .cal-vacation-label { font-size: 9px; color: #aaa; margin-top: 3px; line-height: 1.3; }
  .cal-day-dot {
    width: 7px; height: 7px; border-radius: 50%; background: #27ae60;
    position: absolute; bottom: 8px; left: 8px;
  }

  /* ===== Day Panel (slide-up) ===== */
  #day-panel {
    display: none; position: fixed; inset: 0; z-index: 600;
    background: rgba(0,0,0,0.45); align-items: flex-end; justify-content: center;
  }
  #day-panel.open { display: flex; }
  .day-panel-box {
    background: #fff; border-radius: 20px 20px 0 0;
    padding: 24px 24px 32px; width: 100%; max-width: 600px;
    direction: rtl; max-height: 88vh; overflow-y: auto;
    box-shadow: 0 -4px 30px rgba(0,0,0,0.15);
  }
  .day-panel-header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
  }
  .day-panel-header h3 { margin: 0; font-size: 18px; }
  .day-panel-close {
    background: #f0f2f5; border: none; border-radius: 50%;
    width: 34px; height: 34px; font-size: 16px; cursor: pointer; flex-shrink: 0;
  }
  .day-panel-fields { display: grid; gap: 14px; margin-bottom: 20px; }
  .day-panel-fields label { font-size: 13px; font-weight: 600; color: #555; display: block; margin-bottom: 4px; }
  .day-panel-fields input {
    width: 100%; padding: 12px; border: 1.5px solid #ddd;
    border-radius: 8px; font-size: 16px; font-family: inherit; box-sizing: border-box;
  }
  .day-panel-fields input:focus { outline: none; border-color: #2ecc71; }
  .day-panel-actions { display: flex; gap: 10px; }
  .btn-panel-save {
    flex: 1; background: #2ecc71; color: #fff; border: none;
    border-radius: 10px; padding: 14px; font-size: 16px; font-weight: 700; cursor: pointer; font-family: inherit;
  }
  .btn-panel-save:hover { background: #27ae60; }
  .btn-panel-clear {
    background: #fff0f0; color: #e74c3c; border: 1.5px solid #f5c6c6;
    border-radius: 10px; padding: 14px 18px; font-size: 14px; cursor: pointer; font-family: inherit; font-weight: 600;
  }
  .btn-panel-close {
    background: #f0f2f5; color: #555; border: none;
    border-radius: 10px; padding: 14px 18px; font-size: 14px; cursor: pointer; font-family: inherit;
  }

  /* ===== Eshel Wizard ===== */
  .wizard-wrap { padding: 2px 0; }
  .wizard-dots {
    display: flex; gap: 6px; flex-wrap: wrap;
    justify-content: center; margin-bottom: 6px;
  }
  .wizard-dot {
    width: 11px; height: 11px; border-radius: 50%;
    background: #ddd; cursor: pointer; transition: all 0.15s; flex-shrink: 0;
  }
  .wizard-dot.filled  { background: #27ae60; }
  .wizard-dot.current { background: #2980b9; transform: scale(1.3); }
  .wizard-counter {
    text-align: center; font-size: 13px; color: #888;
    font-weight: 600; margin-bottom: 10px;
  }
  .wizard-card {
    background: #fff; border-radius: 14px; padding: 14px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.07);
    margin-bottom: 14px; display: grid; gap: 10px;
  }
  .wz-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .wz-3col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
  .wz-field label, .wz-2col label, .wz-3col label {
    font-size: 12px; font-weight: 600; color: #666; display: block; margin-bottom: 3px;
  }
  .wz-field input, .wz-2col input[type="text"], .wz-2col input[type="date"],
  .wz-3col input[type="text"], .wz-field select, .wz-2col select, .wz-3col select {
    width: 100%; padding: 9px 10px; border: 1.5px solid #ddd;
    border-radius: 8px; font-size: 14px; font-weight: 400; font-family: inherit;
    box-sizing: border-box; background: #fff; color: #222;
  }
  .wz-field input:focus, .wz-2col input:focus, .wz-3col input:focus,
  .wz-field select:focus, .wz-2col select:focus, .wz-3col select:focus { outline: none; border-color: #2ecc71; }
  .wz-2col input[readonly] { background: #f8f9fa; color: #777; }
  .wz-checkboxes {
    display: flex; flex-wrap: wrap; gap: 8px 14px;
    padding: 10px 12px; background: #f8f9fa; border-radius: 10px;
  }
  .wz-checkboxes label {
    display: flex; align-items: center; gap: 6px;
    font-size: 14px; font-weight: 500; cursor: pointer;
  }
  .wz-checkboxes input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: #27ae60; }
  .wizard-nav { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
  .btn-wz-nav {
    background: #f0f2f5; color: #333; border: none;
    border-radius: 10px; padding: 11px 22px; font-size: 14px;
    font-weight: 600; cursor: pointer; font-family: inherit; transition: background 0.15s;
  }
  .btn-wz-nav:hover:not(:disabled) { background: #e0e4ea; }
  .btn-wz-nav:disabled { opacity: 0.3; cursor: default; }
  .btn-wz-save {
    background: #2ecc71; color: #fff; border: none;
    border-radius: 10px; padding: 11px 28px; font-size: 14px;
    font-weight: 700; cursor: pointer; font-family: inherit;
  }
  .btn-wz-save:hover { background: #27ae60; }

  /* ===== Login Screen ===== */
  #loginOverlay {
    position: fixed; inset: 0;
    background: #0a0a0a;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    z-index: 9999; gap: 0;
  }
  #loginOverlay h1 { color: #fff; font-size: 22px; font-weight: 700; margin-bottom: 10px; text-align: center; padding: 0 20px; }
  #loginOverlay p  { color: #888; font-size: 14px; margin-bottom: 36px; text-align: center; }
  #googleSignInBtn {
    display: flex; align-items: center; gap: 12px;
    background: #fff; color: #333;
    border: none; border-radius: 8px;
    padding: 13px 28px; font-size: 16px; font-weight: 600;
    cursor: pointer; font-family: inherit;
    box-shadow: 0 2px 16px rgba(255,255,255,0.1);
    transition: background 0.15s;
  }
  #googleSignInBtn:hover { background: #f0f0f0; }
  #googleSignInBtn svg { width: 22px; height: 22px; flex-shrink: 0; }
  #loginError { color: #e74c3c; font-size: 13px; margin-top: 18px; display: none; }

  /* ===== User info in header ===== */
  header { display: flex; align-items: center; justify-content: space-between; position: relative; }
  #headerTitle { flex: 1; }
  #headerLogo { position: absolute; left: 50%; transform: translateX(-50%); background: #000; padding: 5px 10px; border-radius: 6px; display: flex; align-items: center; pointer-events: none; }
  #headerLogo img { height: 40px; display: block; }
  #userInfo { display: none; align-items: center; gap: 10px; flex-shrink: 0; }
  #userAvatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.4); object-fit: cover; }
  #userName { font-size: 13px; color: #ccc; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  #logoutBtn {
    background: rgba(255,255,255,0.1); color: #fff;
    border: 1px solid rgba(255,255,255,0.2); border-radius: 6px;
    padding: 5px 12px; font-size: 13px; cursor: pointer; font-family: inherit;
  }
  #logoutBtn:hover { background: rgba(255,255,255,0.2); }
  @media (max-width: 600px) { #userName { display: none; } #headerLogo { display: none; } }
  </style>
</head>
<body>

<!-- ×¢××•×“ ×—×ª×™××ª ×× ×”×œ (××•×¦×’ ×¨×§ ×›×©-URL ××›×™×œ ?sign=) -->
<div id="principalPage">
  <div class="principal-card">
    <h1>âœ ×—×ª×™××ª ×× ×”×œ/×ª</h1>
    <p class="subtitle">×“×•×— ×¤×¢×™×œ×•×ª ×•× ×•×›×—×•×ª â€” ××•×¨×” ×©×œ"×—</p>
    <div id="principalInfo">
      <div class="principal-info-row">×˜×•×¢×Ÿ ×¤×¨×˜×™×...</div>
    </div>
  </div>

  <div class="principal-card" id="principalReportCard" style="display:none;">
    <strong style="font-size:15px;">×¤×™×¨×•×˜ ×—×•×“×©×™:</strong>
    <div id="principalReport" class="principal-report-wrap"></div>
  </div>

  <div class="principal-card">
    <div class="principal-sig-label">×—×ª×™××”:</div>
    <canvas id="principalSigCanvas" width="600" height="200"></canvas>
    <div style="text-align:left;">
      <button id="principalClearBtn" onclick="clearPrincipalSig()">× ×§×” ×—×ª×™××”</button>
    </div>
    <button id="principalSubmitBtn" onclick="submitPrincipalSignature()">×—×ª×•× ×•×©×œ×— âœ“</button>
  </div>
  <div class="principal-card" id="principalSuccess">
    <div class="success-icon">âœ…</div>
    <h2>×”×—×ª×™××” × ×©×œ×—×” ×‘×”×¦×œ×—×”!</h2>
    <p>×”×“×•×— × ×—×ª× ×•×™×•×¤×™×¢ ××¦×œ ×”××•×¨×”.</p>
  </div>
</div>

<!-- ××¡×š ×›× ×™×¡×” -->
<div id="loginOverlay">
  <div style="background:#000;padding:14px 24px;border-radius:10px;margin-bottom:20px;">
    <img src="https://www.moked-shelach.co.il/tiyulim/Images/shelach.gif" alt='×œ×•×’×• ×©×œ"×—' style="height:80px;display:block;">
  </div>
  <h1>××™×œ×•×™ ×“×•×—×•×ª ×¤×¢×™×œ×•×ª - ××•×¨×™× ×•××•×¨×•×ª ×œ×©×œ"×—</h1>
  <p>×™×© ×œ×”×ª×—×‘×¨ ×¢× ×—×©×‘×•×Ÿ Google ×›×“×™ ×œ×”××©×™×š</p>
  <button id="googleSignInBtn" onclick="handleSignIn()">
    <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
      <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
      <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
      <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
      <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
    </svg>
    ×”×ª×—×‘×¨ ×¢× Google
  </button>
  <div id="loginError">×”×”×ª×—×‘×¨×•×ª × ×›×©×œ×”. × ×¡×” ×©×•×‘.</div>
</div>

<header>
  <span id="headerTitle">×“×•×— ×¤×¢×™×œ×•×ª ×•× ×•×›×—×•×ª â€” ××•×¨×” ×©×œ"×—</span>
  <div id="headerLogo">
    <img src="https://www.moked-shelach.co.il/tiyulim/Images/shelach.gif" alt='×œ×•×’×• ×©×œ"×—'>
  </div>
  <div id="userInfo">
    <img id="userAvatar" src="" alt="">
    <span id="userName"></span>
    <button id="logoutBtn" onclick="handleSignOut()">×™×¦×™××”</button>
  </div>
</header>

<div class="tabs">
  <div class="tab active" onclick="showPage('settings')">×¤×¨×˜×™× ××™×©×™×™×</div>
  <div class="tab" onclick="showPage('report')">×“×•×— ×—×•×“×©×™</div>
  <div class="tab" onclick="showPage('eshel')">××©"×œ</div>
</div>

<!-- ×“×£ ×”×’×“×¨×•×ª -->
<div class="page active" id="page-settings">
  <div class="card">
    <h2>×¤×¨×˜×™× ×§×‘×•×¢×™×</h2>

    <div class="form-grid">

      <div class="form-group full section-title">×¤×¨×˜×™ ××•×¨×”</div>

      <div class="form-group">
        <label>×©× ×¤×¨×˜×™</label>
        <input type="text" id="firstName" placeholder="×©× ×¤×¨×˜×™">
      </div>

      <div class="form-group">
        <label>×©× ××©×¤×—×”</label>
        <input type="text" id="lastName" placeholder="×©× ××©×¤×—×”">
      </div>

      <div class="form-group">
        <label>××¡×¤×¨ ×–×”×•×ª</label>
        <input type="text" id="idNumber" placeholder="××¡×¤×¨ ×–×”×•×ª">
      </div>

      <div class="form-group">
        <label>×”×™×§×£ ××©×¨×”</label>
        <input type="text" id="jobScope" placeholder="(××•×¤×¦×™×•× ×œ×™)">
      </div>

      <div class="form-group">
        <label>×›×ª×•×‘×ª ×¤×¨×˜×™×ª</label>
        <input type="text" id="address" placeholder="×›×ª×•×‘×ª ××’×•×¨×™×">
      </div>

      <div class="form-group">
        <label>×‘××§×•× ××“×¨×™×š</label>
        <input type="text" id="substituteFor" placeholder="(××•×¤×¦×™×•× ×œ×™)">
      </div>

      <div class="form-group">
        <label>××§×•× ××’×•×¨×™×</label>
        <input type="text" id="homeCity" placeholder="×¢×™×¨ / ×™×™×©×•×‘">
      </div>

      <div class="form-group">
        <label>××§×•× ×¢×‘×•×“×”</label>
        <input type="text" id="workplace" placeholder="×¢×™×¨ / ×™×™×©×•×‘">
      </div>

      <div class="form-group full section-title">×‘×™×ª ×”×¡×¤×¨</div>

      <div class="form-group">
        <label>×©× ×‘×™×ª ×”×¡×¤×¨</label>
        <input type="text" id="schoolName" placeholder="×©× ×‘×™×ª ×”×¡×¤×¨">
      </div>

      <div class="form-group">
        <label>××—×•×–</label>
        <input type="text" id="district" placeholder="××—×•×–">
      </div>

      <div class="form-group full section-title">×©×¢×•×ª ×¢×‘×•×“×” ×©×‘×•×¢×™×•×ª â€” ××¡×œ ×©×œ"×—</div>

      <div class="hours-grid">
        <div class="day-label">×'</div>
        <div class="day-label">×‘'</div>
        <div class="day-label">×’'</div>
        <div class="day-label">×“'</div>
        <div class="day-label">×”'</div>
        <div class="day-label">×•'</div>
        <input type="number" id="shelach_sun" min="0" max="12" placeholder="0">
        <input type="number" id="shelach_mon" min="0" max="12" placeholder="0">
        <input type="number" id="shelach_tue" min="0" max="12" placeholder="0">
        <input type="number" id="shelach_wed" min="0" max="12" placeholder="0">
        <input type="number" id="shelach_thu" min="0" max="12" placeholder="0">
        <input type="number" id="shelach_fri" min="0" max="12" placeholder="0">
      </div>

      <div class="form-group full section-title">×©×¢×•×ª ×¢×‘×•×“×” ×©×‘×•×¢×™×•×ª â€” ××¡×œ ×‘×™"×¡</div>

      <div class="hours-grid">
        <div class="day-label">×'</div>
        <div class="day-label">×‘'</div>
        <div class="day-label">×’'</div>
        <div class="day-label">×“'</div>
        <div class="day-label">×”'</div>
        <div class="day-label">×•'</div>
        <input type="number" id="school_sun" min="0" max="12" placeholder="0">
        <input type="number" id="school_mon" min="0" max="12" placeholder="0">
        <input type="number" id="school_tue" min="0" max="12" placeholder="0">
        <input type="number" id="school_wed" min="0" max="12" placeholder="0">
        <input type="number" id="school_thu" min="0" max="12" placeholder="0">
        <input type="number" id="school_fri" min="0" max="12" placeholder="0">
      </div>

      <div class="form-group full section-title">×¤×¨×˜×™× × ×•×¡×¤×™× ×œ×˜×•×¤×¡</div>

      <div class="form-group full">
        <label>×”×©×¢×•×ª ×”×©×‘×•×¢×™×•×ª × ×™×ª× ×•×ª ×‘×™××™×</label>
        <input type="text" id="workDays" placeholder="×œ××©×œ: ××³, ×‘×³, ×“×³">
      </div>

    </div>

    <div style="margin-top: 24px;">
      <button class="btn-save" onclick="saveSettings()">×©××•×¨ ×¤×¨×˜×™×</button>
      <span class="save-msg" id="saveMsg">âœ“ × ×©××¨ ×‘×”×¦×œ×—×”!</span>
    </div>
  </div>
</div>

<!-- ×“×£ ×“×•×— ×—×•×“×©×™ -->
<div class="page" id="page-report">
  <div class="report-card">

    <div class="month-selector">
      <label>×—×•×“×©:</label>
      <select id="selectMonth" onchange="updateCalendar()">

        <option value="8">×¡×¤×˜××‘×¨</option>
        <option value="9">××•×§×˜×•×‘×¨</option>
        <option value="10">× ×•×‘××‘×¨</option>
        <option value="11">×“×¦××‘×¨</option>
        <option value="0">×™× ×•××¨</option>
        <option value="1">×¤×‘×¨×•××¨</option>
        <option value="2">××¨×¥</option>
        <option value="3">××¤×¨×™×œ</option>
        <option value="4">×××™</option>
        <option value="5">×™×•× ×™</option>
      </select>
      <label>×©× ×”:</label>
      <select id="selectYear" onchange="updateCalendar()">
        <option value="2025">2025</option>
        <option value="2026">2026</option>
      </select>
      <button class="btn-print" onclick="printReport()">×™×™×¦× PDF â¬‡</button>
      <button class="btn-excel" onclick="exportReportToExcel()">×™×™×¦× ××§×¡×œ â¬‡</button>
      <button class="btn-sign" onclick="createSignatureRequest()">×©×œ×— ×œ×—×ª×™××ª ×× ×”×œ/×ª âœ</button>
      <button class="btn-clear" onclick="clearReport()">× ×§×” × ×ª×•× ×™×</button>
    </div>

    <!-- ×‘×—×™×¨×ª ××¦×‘ ×”×–× ×” -->
    <div class="mode-toggle">
      <button class="mode-btn active" onclick="switchMode('table')">â˜° ×˜×‘×œ×”</button>
      <button class="mode-btn" onclick="switchMode('calendar')">ğŸ“… ×œ×•×— ×©× ×”</button>
    </div>

    <!-- ××¦×‘ ×˜×‘×œ×” (×§×™×™×) -->
    <div id="view-table">
    <div class="report-table-wrap">
      <table class="report-table">
        <thead>
          <tr>
            <th>×”×™×•×<br>×‘×—×•×“×©</th>
            <th>×”×™×•×<br>×‘×©×‘×•×¢</th>
            <th>×©×¢×•×ª<br>×”×™×¢×“×¨×•×ª</th>
            <th>×©"× /<br>×"×</th>
            <th>×”×›×™×ª×”</th>
            <th>×ª×™××•×¨ ×”×¤×¢×•×œ×”</th>
            <th>×¡×™×‘×” ×œ×”×™×¢×“×¨×•×ª<br>××• ×©×¢×•×ª × ×•×¡×¤×•×ª</th>
          </tr>
        </thead>
        <tbody id="reportBody">
          <tr data-day="1"><td>1</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="2"><td>2</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="3"><td>3</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="4"><td>4</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="5"><td>5</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="6"><td>6</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="7"><td>7</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="8"><td>8</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="9"><td>9</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="10"><td>10</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="11"><td>11</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="12"><td>12</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="13"><td>13</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="14"><td>14</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="15"><td>15</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="16"><td>16</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="17"><td>17</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="18"><td>18</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="19"><td>19</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="20"><td>20</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="21"><td>21</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="22"><td>22</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="23"><td>23</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="24"><td>24</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="25"><td>25</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="26"><td>26</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="27"><td>27</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="28"><td>28</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="29"><td>29</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="30"><td>30</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
          <tr data-day="31"><td>31</td><td class="weekday"></td><td><input type="number" min="0"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="3" style="font-weight:bold;border-left:none;">
              <div style="display:flex;justify-content:space-between;align-items:center;padding:0 6px;">
                <span>×¡×”"×› ×©×¢×•×ª × ×•×¡×¤×•×ª:</span>
                <span id="totalHours">0</span>
              </div>
            </td>
            <td colspan="4" style="border-right:none;"></td>
          </tr>
        </tfoot>
      </table>
    </div>
    </div><!-- /view-table -->

    <!-- ××¦×‘ ×œ×•×— ×©× ×” (×™×ª××œ× ×‘×©×œ×‘ ×”×‘×) -->
    <div id="view-calendar" style="display:none;">
      <p style="color:#aaa;padding:40px;text-align:center;">×œ×•×— ×©× ×” â€” ×‘×§×¨×•×‘</p>
    </div>

  </div>

  <!-- ×—×œ×§ ×”×¢×¨×•×ª: × ×•×©××™×, ×“×¨×›×™ ×‘×™×¦×•×¢ -->
  <div class="notes-section">
    <h3>×¤×¨×˜ × ×•×©××™×, ×“×¨×›×™ ×‘×™×¦×•×¢ ×•×“×¨×›×™ ×¤×¢×•×œ×”</h3>
    <div class="notes-grid">
      <div class="notes-item">
        <label for="note-chet">×©×›×‘×ª ×›×™×ª×•×ª ×—</label>
        <textarea id="note-chet" placeholder="×”×›× ×¡ ×ª×•×›×Ÿ..."></textarea>
      </div>
      <div class="notes-item">
        <label for="note-tet">×©×›×‘×ª ×›×™×ª×•×ª ×˜</label>
        <textarea id="note-tet" placeholder="×”×›× ×¡ ×ª×•×›×Ÿ..."></textarea>
      </div>
      <div class="notes-item">
        <label for="note-masaot">××¡×¢×•×ª ×•××¤×¢×œ×™×</label>
        <textarea id="note-masaot" placeholder="×”×›× ×¡ ×ª×•×›×Ÿ..."></textarea>
      </div>
      <div class="notes-item">
        <label for="note-mishatzim">××©"×¦×™×</label>
        <textarea id="note-mishatzim" placeholder="×”×›× ×¡ ×ª×•×›×Ÿ..."></textarea>
      </div>
    </div>
  </div>

  <!-- ×—×ª×™××” ×•×ª××¨×™×š -->
  <div class="notes-section">
    <h3>×—×ª×™××” ×•×ª××¨×™×š</h3>
    <div class="sig-row">
      <div class="sig-date">
        <label for="reportDate">×ª××¨×™×š ××™×œ×•×™</label>
        <input type="date" id="reportDate">
      </div>
      <div class="sig-canvas-wrap">
        <label>×—×ª×™××ª ×”××•×¨×” (×¦×™×™×¨ ×¢× ×”××¦×‘×¢ ××• ×”×¢×›×‘×¨)</label>
        <canvas id="signatureCanvas" width="600" height="110"></canvas>
        <button type="button" class="btn-clear-sig" onclick="clearSignature()">âœ• × ×§×” ×—×ª×™××”</button>
      </div>
    </div>
    <div id="principalSigStatus" style="margin-top:18px;padding-top:16px;border-top:1px solid #eee;"></div>
  </div>

  <div style="display:flex;gap:12px;margin-top:20px;flex-wrap:wrap;">
    <button class="btn-print" onclick="printReport()">×™×™×¦× PDF â¬‡</button>
    <button class="btn-excel" onclick="exportReportToExcel()">×™×™×¦× ××§×¡×œ â¬‡</button>
    <button class="btn-sign" onclick="createSignatureRequest()">×©×œ×— ×œ×—×ª×™××ª ×× ×”×œ/×ª âœ</button>
  </div>

</div>

<!-- ×“×£ ××©"×œ -->
<div class="page" id="page-eshel">

  <!-- ×‘×—×™×¨×ª ×—×•×“×©/×©× ×” -->
  <div class="report-card" style="margin-bottom:20px;">
    <div class="month-selector">
      <label>×—×•×“×©:</label>
      <select id="eshelMonth" onchange="loadEshel(parseInt(this.value), parseInt(document.getElementById('eshelYear').value))">
        <option value="8">×¡×¤×˜××‘×¨</option>
        <option value="9">××•×§×˜×•×‘×¨</option>
        <option value="10">× ×•×‘××‘×¨</option>
        <option value="11">×“×¦××‘×¨</option>
        <option value="0">×™× ×•××¨</option>
        <option value="1">×¤×‘×¨×•××¨</option>
        <option value="2">××¨×¥</option>
        <option value="3">××¤×¨×™×œ</option>
        <option value="4">×××™</option>
        <option value="5">×™×•× ×™</option>
      </select>
      <label>×©× ×”:</label>
      <select id="eshelYear" onchange="loadEshel(parseInt(document.getElementById('eshelMonth').value), parseInt(this.value))">
        <option value="2025">2025</option>
        <option value="2026">2026</option>
      </select>
      <button class="btn-print" onclick="printEshel()">×™×™×¦× PDF â¬‡</button>
      <button class="btn-excel" onclick="exportEshelToExcel()">×™×™×¦× ××§×¡×œ â¬‡</button>
      <button class="btn-clear" onclick="clearEshel()">× ×§×” × ×ª×•× ×™×</button>
    </div>
  </div>

  <!-- ×‘×—×™×¨×ª ××¦×‘ ×”×–× ×” â€” ××©"×œ -->
  <div class="mode-toggle">
    <button class="mode-btn active" onclick="switchEshelMode('table')">â˜° ×˜×‘×œ×”</button>
    <button class="mode-btn" onclick="switchEshelMode('wizard')">â—€â–¶ ×™×•××™</button>
  </div>

  <!-- ×¤×¨×˜×™× ×§×‘×•×¢×™× (××”×’×“×¨×•×ª) -->
  <div class="card" style="margin-bottom:20px;max-width:none;">
    <h2>×¤×¨×˜×™× ×§×‘×•×¢×™×</h2>
    <div class="eshel-info-grid">
      <div class="eshel-info-item">
        <label>××¡×¤×¨ ×–×”×•×ª</label>
        <div class="info-value" id="eshel-info-id"></div>
      </div>
      <div class="eshel-info-item">
        <label>×©× ×¤×¨×˜×™</label>
        <div class="info-value" id="eshel-info-firstname"></div>
      </div>
      <div class="eshel-info-item">
        <label>×©× ××©×¤×—×”</label>
        <div class="info-value" id="eshel-info-lastname"></div>
      </div>
      <div class="eshel-info-item">
        <label>××§×•× ××’×•×¨×™×</label>
        <div class="info-value" id="eshel-info-homecity"></div>
      </div>
      <div class="eshel-info-item">
        <label>××§×•× ×¢×‘×•×“×”</label>
        <div class="info-value" id="eshel-info-workplace"></div>
      </div>
    </div>
  </div>

  <!-- ××¦×‘ ×˜×‘×œ×” â€” ××©"×œ -->
  <div id="eshel-view-table">

  <!-- ×˜×‘×œ×ª ×¤×¢×™×œ×•×ª -->
  <div class="report-card" style="margin-bottom:20px;">
    <div class="eshel-table-wrap">
      <table class="eshel-table">
        <thead>
          <tr>
            <th>×ª××¨×™×š</th>
            <th>×™×•×<br>×‘×©×‘×•×¢</th>
            <th>××©×¢×”</th>
            <th>×¢×“ ×©×¢×”</th>
            <th>×××§×•×</th>
            <th>×œ××§×•×</th>
            <th>××˜×¨×ª ×”×¤×¢×•×œ×”</th>
            <th>×‘×™×Ÿ<br>×¢×™×¨×•× ×™</th>
            <th>×¢×™×¨×•× ×™</th>
            <th>×‘×•×§×¨</th>
            <th>×¦×”×¨×™×™×</th>
            <th>×¢×¨×‘</th>
            <th>×œ×™× ×”<br>×‘××‘× ×”/×©×˜×—</th>
            <th>×¡×”"×›</th>
          </tr>
        </thead>
        <tbody id="eshelBody">
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><select class="eshel-lina"><option value="">â€”</option><option value="××‘× ×”">××‘× ×”</option><option value="×©×˜×—">×©×˜×—</option></select></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><select class="eshel-lina"><option value="">â€”</option><option value="××‘× ×”">××‘× ×”</option><option value="×©×˜×—">×©×˜×—</option></select></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><select class="eshel-lina"><option value="">â€”</option><option value="××‘× ×”">××‘× ×”</option><option value="×©×˜×—">×©×˜×—</option></select></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><select class="eshel-lina"><option value="">â€”</option><option value="××‘× ×”">××‘× ×”</option><option value="×©×˜×—">×©×˜×—</option></select></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><select class="eshel-lina"><option value="">â€”</option><option value="××‘× ×”">××‘× ×”</option><option value="×©×˜×—">×©×˜×—</option></select></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><select class="eshel-lina"><option value="">â€”</option><option value="××‘× ×”">××‘× ×”</option><option value="×©×˜×—">×©×˜×—</option></select></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><select class="eshel-lina"><option value="">â€”</option><option value="××‘× ×”">××‘× ×”</option><option value="×©×˜×—">×©×˜×—</option></select></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><select class="eshel-lina"><option value="">â€”</option><option value="××‘× ×”">××‘× ×”</option><option value="×©×˜×—">×©×˜×—</option></select></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><select class="eshel-lina"><option value="">â€”</option><option value="××‘× ×”">××‘× ×”</option><option value="×©×˜×—">×©×˜×—</option></select></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><select class="eshel-lina"><option value="">â€”</option><option value="××‘× ×”">××‘× ×”</option><option value="×©×˜×—">×©×˜×—</option></select></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><select class="eshel-lina"><option value="">â€”</option><option value="××‘× ×”">××‘× ×”</option><option value="×©×˜×—">×©×˜×—</option></select></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><select class="eshel-lina"><option value="">â€”</option><option value="××‘× ×”">××‘× ×”</option><option value="×©×˜×—">×©×˜×—</option></select></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><select class="eshel-lina"><option value="">â€”</option><option value="××‘× ×”">××‘× ×”</option><option value="×©×˜×—">×©×˜×—</option></select></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><select class="eshel-lina"><option value="">â€”</option><option value="××‘× ×”">××‘× ×”</option><option value="×©×˜×—">×©×˜×—</option></select></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><select class="eshel-lina"><option value="">â€”</option><option value="××‘× ×”">××‘× ×”</option><option value="×©×˜×—">×©×˜×—</option></select></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><select class="eshel-lina"><option value="">â€”</option><option value="××‘× ×”">××‘× ×”</option><option value="×©×˜×—">×©×˜×—</option></select></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><select class="eshel-lina"><option value="">â€”</option><option value="××‘× ×”">××‘× ×”</option><option value="×©×˜×—">×©×˜×—</option></select></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><select class="eshel-lina"><option value="">â€”</option><option value="××‘× ×”">××‘× ×”</option><option value="×©×˜×—">×©×˜×—</option></select></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><select class="eshel-lina"><option value="">â€”</option><option value="××‘× ×”">××‘× ×”</option><option value="×©×˜×—">×©×˜×—</option></select></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
          <tr><td><input type="date" class="eshel-date" oninput="fillEshelDay(this)"></td><td><input type="text" class="eshel-dayname" readonly style="color:#666;width:52px;"></td><td><input type="text" class="eshel-from-time" style="width:48px;"></td><td><input type="text" class="eshel-to-time" style="width:48px;"></td><td><input type="text" class="eshel-from-place"></td><td><input type="text" class="eshel-to-place"></td><td><input type="text" class="eshel-purpose" style="min-width:110px;"></td><td><input type="checkbox" class="eshel-bein-iri"></td><td><input type="checkbox" class="eshel-iri"></td><td><input type="checkbox" class="eshel-boker"></td><td><input type="checkbox" class="eshel-tsaharaim"></td><td><input type="checkbox" class="eshel-erev"></td><td><select class="eshel-lina"><option value="">â€”</option><option value="××‘× ×”">××‘× ×”</option><option value="×©×˜×—">×©×˜×—</option></select></td><td><input type="text" class="eshel-total" style="width:42px;"></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ×—×ª×™××” ×•×ª××¨×™×š -->
  <div class="notes-section" style="margin-bottom:20px;">
    <h3>×—×ª×™××” ×•×ª××¨×™×š</h3>
    <div class="sig-row">
      <div class="sig-date">
        <label for="eshelDate">×ª××¨×™×š ××™×œ×•×™</label>
        <input type="date" id="eshelDate">
      </div>
      <div class="sig-canvas-wrap">
        <label>×—×ª×™××ª ×”×¢×•×‘×“ (×¦×™×™×¨ ×¢× ×”××¦×‘×¢ ××• ×”×¢×›×‘×¨)</label>
        <canvas id="eshelSigCanvas" width="600" height="110"></canvas>
        <button type="button" class="btn-clear-sig" onclick="clearEshelSignature()">âœ• × ×§×” ×—×ª×™××”</button>
      </div>
    </div>
  </div>

  <div style="display:flex;gap:12px;margin-top:20px;flex-wrap:wrap;">
    <button class="btn-print" onclick="printEshel()">×™×™×¦× PDF â¬‡</button>
    <button class="btn-excel" onclick="exportEshelToExcel()">×™×™×¦× ××§×¡×œ â¬‡</button>
  </div>

  </div><!-- /eshel-view-table -->

  <!-- ××¦×‘ ×™×•××™ â€” ××©"×œ -->
  <div id="eshel-view-wizard" style="display:none;">
    <div class="wizard-wrap">
      <div class="wizard-dots" id="wizard-dots"></div>
      <div class="wizard-counter">×¨×©×•××” <span id="wizard-row-num">1 / 20</span></div>
      <div class="wizard-card">
        <div class="wz-2col">
          <div><label>×ª××¨×™×š</label><input id="wz-date" type="date" oninput="fillWizardDay()"></div>
          <div><label>×™×•× ×‘×©×‘×•×¢</label><input id="wz-dayname" type="text" readonly placeholder="××—×•×©×‘ ××•×˜×•××˜×™×ª"></div>
        </div>
        <div class="wz-2col">
          <div><label>××©×¢×”</label><select id="wz-from-time"></select></div>
          <div><label>×¢×“ ×©×¢×”</label><select id="wz-to-time"></select></div>
        </div>
        <div class="wz-3col">
          <div><label>×××§×•×</label><input id="wz-from-place" type="text"></div>
          <div><label>×œ××§×•×</label><input id="wz-to-place" type="text"></div>
          <div><label>××˜×¨×ª ×”×¤×¢×•×œ×”</label><input id="wz-purpose" type="text"></div>
        </div>
        <div class="wz-checkboxes">
          <label><input id="wz-bein-iri" type="checkbox"> ×‘×™×Ÿ ×¢×™×¨×•× ×™</label>
          <label><input id="wz-iri" type="checkbox"> ×¢×™×¨×•× ×™</label>
          <label><input id="wz-boker" type="checkbox"> ×‘×•×§×¨</label>
          <label><input id="wz-tsaharaim" type="checkbox"> ×¦×”×¨×™×™×</label>
          <label><input id="wz-erev" type="checkbox"> ×¢×¨×‘</label>
          <label>×œ×™× ×” <select id="wz-lina"><option value="">â€”</option><option value="××‘× ×”">××‘× ×”</option><option value="×©×˜×—">×©×˜×—</option></select></label>
        </div>
        <div class="wz-field"><label>×¡×”"×›</label><input id="wz-total" type="text" style="max-width:120px;"></div>
      </div>
      <div class="wizard-nav">
        <button id="wz-prev" class="btn-wz-nav" onclick="wizardNav(-1)">×”×§×•×“× â–¶</button>
        <button class="btn-wz-save" onclick="saveWizardRow(); renderWizard(_wizardRow);">×©××•×¨</button>
        <button id="wz-next" class="btn-wz-nav" onclick="wizardNav(1)">â—€ ×”×‘×</button>
      </div>
    </div>
  </div>

</div>

<!-- ×¢××•×“ PDF â€” ××—×•×¥ ×œ××¡×š, × ×•×¦×¨ ×“×™× ××™×ª -->
<div id="pdfPage">

  <!-- ×›×•×ª×¨×ª ×¢×œ×™×•× ×”: ×™××™×Ÿ=×©× ×”××©×¨×“, ×©×××œ=×¤×¨×˜×™ ×‘×™×”"×¡ -->
  <!-- ×‘×˜×‘×œ×ª RTL: ×¢××•×“×” ×¨××©×•× ×” = ×™××™×Ÿ, ×¢××•×“×” ×©× ×™×™×” = ×©×××œ -->
  <table style="width:100%;border-collapse:collapse;border:1px solid #000;">
    <tr>
      <td style="text-align:right;padding:6px 10px;vertical-align:top;line-height:1.8;">
        <div style="font-size:14pt;font-weight:bold;">××©×¨×“ ×”×—×™× ×•×š ×”×ª×¨×‘×•×ª, ×•×”×¡×¤×•×¨×˜</div>
        <div style="font-size:11pt;font-weight:bold;">××™× ×”×œ ×—×‘×¨×” ×•× ×•×¢×¨</div>
        <div style="font-size:11pt;font-weight:bold;">×’×£ ×©×œ"×— ×•×™×“×™×¢×ª ×”××¨×¥</div>
      </td>
      <td style="text-align:right;padding:6px 10px;vertical-align:top;border-right:1px solid #000;width:200px;font-size:9pt;line-height:1.9;">
        <div>××—×•×–: <span id="pdf-district"></span></div>
        <div>×©× ×‘×™×”"×¡: <span id="pdf-school"></span></div>
        <div>×—×•×“×©: <span id="pdf-month"></span></div>
        <div>×©× ×”: <span id="pdf-year"></span></div>
      </td>
    </tr>
  </table>

  <!-- ×›×•×ª×¨×ª ×¨××©×™×ª -->
  <div style="text-align:center;font-weight:bold;font-size:15pt;border:1px solid #000;border-top:none;padding:5px;">
    ×“×•×— ×¤×¢×™×œ×•×ª ×•× ×•×›×—×•×ª ×©×œ ××•×¨×” ×©×œ"×— ×‘×¢×‘×•×“×”
  </div>

  <!-- ×¤×¨×˜×™ ××•×¨×” -->
  <div style="font-weight:bold;font-size:9pt;margin-top:5px;margin-bottom:2px;">×¤×¨×˜×™ ×”××•×¨×”</div>
  <table class="pdf-tbl">
    <tr>
      <th style="width:95px;">××¡×¤×¨ ×–×”×•×ª</th>
      <th>×©× ××©×¤×—×”</th>
      <th>×©× ×¤×¨×˜×™</th>
      <th style="width:95px;">×”×™×§×£ ××©×¨×”</th>
      <td rowspan="4" style="width:88px;font-size:7.5pt;vertical-align:top;text-align:right;padding:3px;">
        ×”××¤×©×¨×•×™×•×ª<br>×‘"×ª×™××•×¨ ×”×¤×¢×•×œ×”":<br>
        ×™×•× ×©×“×”, ×’×™×—×”,<br>
        ×©×™×¨×•×ª ×œ××•××™, ××¡×¢<br>
        ×‘×™×¡"×©
      </td>
    </tr>
    <tr>
      <td id="pdf-id" style="text-align:center;height:22px;"></td>
      <td id="pdf-lastname" style="text-align:center;"></td>
      <td id="pdf-firstname" style="text-align:center;"></td>
      <td id="pdf-jobscope" style="text-align:center;"></td>
    </tr>
    <tr>
      <th colspan="2">×›×ª×•×‘×ª ×¤×¨×˜×™×ª</th>
      <th>×‘××§×•× ××“×¨×™×š</th>
      <th></th>
    </tr>
    <tr>
      <td colspan="2" id="pdf-address" style="height:22px;"></td>
      <td id="pdf-substitute"></td>
      <td></td>
    </tr>
  </table>

  <!-- ×©×¢×•×ª ×¢×‘×•×“×” -->
  <table class="pdf-tbl">
    <tr>
      <td style="text-align:right;width:210px;">×©×¢×•×ª ×”×¢×‘×•×“×” ××¡×œ ×©×œ"×— (×›×•×œ×œ ×©×”×™×™×” ×•×¤×¨×˜× ×™)</td>
      <th style="width:38px;text-align:center;">×</th>
      <th style="width:38px;text-align:center;">×‘</th>
      <th style="width:38px;text-align:center;">×’</th>
      <th style="width:38px;text-align:center;">×“</th>
      <th style="width:38px;text-align:center;">×”</th>
      <th style="width:38px;text-align:center;">×•</th>
      <td rowspan="2" style="font-size:7.5pt;text-align:right;vertical-align:top;padding:3px;">×”×©×¢×•×ª ×”×©×‘×•×¢×™×•×ª × ×™×ª× ×•×ª ×‘×™××™×:<br><span id="pdf-workdays"></span></td>
    </tr>
    <tr>
      <td style="height:20px;"></td>
      <td id="pdf-sh0" style="text-align:center;"></td>
      <td id="pdf-sh1" style="text-align:center;"></td>
      <td id="pdf-sh2" style="text-align:center;"></td>
      <td id="pdf-sh3" style="text-align:center;"></td>
      <td id="pdf-sh4" style="text-align:center;"></td>
      <td id="pdf-sh5" style="text-align:center;"></td>
    </tr>
    <tr>
      <td style="text-align:right;">×©×¢×•×ª ×”×¢×‘×•×“×” ××¡×œ ×‘×™×”"×¡ (×›×•×œ×œ ×©×”×™×™×” ×•×¤×¨×˜× ×™)</td>
      <td id="pdf-sc0" style="text-align:center;"></td>
      <td id="pdf-sc1" style="text-align:center;"></td>
      <td id="pdf-sc2" style="text-align:center;"></td>
      <td id="pdf-sc3" style="text-align:center;"></td>
      <td id="pdf-sc4" style="text-align:center;"></td>
      <td id="pdf-sc5" style="text-align:center;"></td>
      <td></td>
    </tr>
  </table>

  <!-- ×˜×‘×œ×ª ×™××™× -->
  <table class="pdf-tbl" style="margin-top:4px;table-layout:fixed;direction:rtl;">
    <colgroup>
      <col style="width:50px;">
      <col style="width:47px;">
      <col style="width:56px;">
      <col style="width:32px;">
      <col style="width:53px;">
      <col style="width:86px;">
      <col style="width:107px;">
      <col>
    </colgroup>
    <thead>
      <tr style="background:#e0e0e0;">
        <th style="text-align:center;">×”×™×•×<br>×‘×—×•×“×©</th>
        <th style="text-align:center;">×”×™×•×<br>×‘×©×‘×•×¢</th>
        <th style="text-align:center;">×©×¢×•×ª<br>×”×™×¢×“×¨×•×ª</th>
        <th style="text-align:center;">×©"× /<br>×"×</th>
        <th style="text-align:center;">×”×›×™×ª×”</th>
        <th style="text-align:center;">×ª×™××•×¨<br>×”×¤×¢×•×œ×”</th>
        <th style="text-align:center;">×¡×™×‘×” ×œ×”×™×¢×“×¨×•×ª<br>××• ×©×¢×•×ª × ×•×¡×¤×•×ª</th>
        <th style="text-align:center;"></th>
      </tr>
    </thead>
    <tbody id="pdf-body"></tbody>
    <tfoot>
      <tr>
        <td colspan="2" style="font-weight:bold;text-align:right;">×¡×”"×› ×©×¢×•×ª:</td>
        <td id="pdf-total" style="text-align:center;"></td>
        <td id="pdf-principal-sig" colspan="4" style="text-align:right;">×—×ª×™××ª ×”×× ×”×œ: ___________________________</td>
        <td></td>
      </tr>
    </tfoot>
  </table>

  <!-- ×›×•×ª×¨×ª ×ª×—×ª×•× ×” -->
  <div style="margin-top:8px;font-size:8.5pt;line-height:2;">
    <div>××¦"×‘ ×”××¡××›×™× ×”×‘××™×: ×.__________________ ×‘.__________________ ×’.__________________</div>
    <div>×× ×™ ××¦×”×™×¨ ×‘×–×” ×©×”×¤×¨×˜×™× ×œ×¢×™×œ × ×›×•× ×™×.</div>
  </div>
  <!-- ×©×•×¨×ª ×—×ª×™××” â€” ×˜×‘×œ×” ×›×“×™ ×œ×”×™×× ×¢ ××‘×¢×™×•×ª RTL/flex -->
  <table style="width:100%;margin-top:10px;font-size:8.5pt;">
    <tr>
      <!-- ×™××™×Ÿ: ×—×ª×™××ª ×”××•×¨×” (×¢××•×“×” ×¨××©×•× ×” = ×™××™×Ÿ ×‘-RTL) -->
      <td style="text-align:right;vertical-align:middle;" id="pdf-sig-cell">×—×ª×™××ª ×”××•×¨×”: ____________________</td>
      <!-- ×©×××œ: ×ª××¨×™×š -->
      <td style="text-align:left;width:160px;" id="pdf-date-cell">×ª××¨×™×š: ___________</td>
    </tr>
  </table>

</div>

<!-- ×¢××•×“ PDF ××©"×œ â€” ×œ×¨×•×—×‘ (Landscape A4 = 1122Ã—794px), ××—×•×¥ ×œ××¡×š -->
<div id="eshelPdfPage">

  <!-- ×©×•×¨×ª ×›×•×ª×¨×ª + ×¤×¨×˜×™ ×¢×•×‘×“ (×”×›×œ ×‘×©×•×¨×” ××—×ª) -->
  <table style="width:100%;border-collapse:collapse;margin-bottom:32px;table-layout:fixed;">
    <colgroup>
      <col style="width:170px;">
      <col style="width:110px;">
      <col style="width:148px;">
      <col style="width:110px;">
      <col style="width:200px;">
      <col style="width:200px;">
      <col style="width:178px;">
    </colgroup>
    <tr>
      <td rowspan="2" style="border:2px solid #000;padding:4px 6px;text-align:center;background:#e8e8e8;vertical-align:middle;">
        <div style="font-size:10pt;font-weight:bold;line-height:1.3;">×˜×•×¤×¡ ××©"×œ</div>
        <div style="font-size:7pt;margin-top:2px;">××©×¨×“ ×”×—×™× ×•×š / ××™× ×”×œ ×—×‘×¨×” ×•× ×•×¢×¨ / ××•×¨×™ ×©×œ"×—</div>
      </td>
      <th style="border:1px solid #000;padding:2px 4px;text-align:center;font-size:7.5pt;background:#e8e8e8;">×.×–×”×•×ª</th>
      <th style="border:1px solid #000;padding:2px 4px;text-align:center;font-size:7.5pt;background:#e8e8e8;">×©× ××©×¤×—×”</th>
      <th style="border:1px solid #000;padding:2px 4px;text-align:center;font-size:7.5pt;background:#e8e8e8;">×©× ×¤×¨×˜×™</th>
      <th style="border:1px solid #000;padding:2px 4px;text-align:center;font-size:7.5pt;background:#e8e8e8;">××§×•× ××’×•×¨×™×</th>
      <th style="border:1px solid #000;padding:2px 4px;text-align:center;font-size:7.5pt;background:#e8e8e8;">××§×•× ×¢×‘×•×“×”</th>
      <th style="border:1px solid #000;padding:2px 4px;text-align:center;font-size:7.5pt;background:#e8e8e8;">×—×•×“×© / ×©× ×”</th>
    </tr>
    <tr>
      <td id="eshel-pdf-id"        style="border:1px solid #000;padding:3px 4px;text-align:center;font-size:9pt;height:24px;background:#fff;"></td>
      <td id="eshel-pdf-lastname"  style="border:1px solid #000;padding:3px 4px;text-align:center;font-size:9pt;background:#fff;"></td>
      <td id="eshel-pdf-firstname" style="border:1px solid #000;padding:3px 4px;text-align:center;font-size:9pt;background:#fff;"></td>
      <td id="eshel-pdf-homecity"  style="border:1px solid #000;padding:3px 4px;text-align:center;font-size:9pt;background:#fff;"></td>
      <td id="eshel-pdf-workplace" style="border:1px solid #000;padding:3px 4px;text-align:center;font-size:9pt;background:#fff;"></td>
      <td style="border:1px solid #000;padding:3px 4px;text-align:center;font-size:9pt;background:#fff;">
        <span id="eshel-pdf-month"></span> / <span id="eshel-pdf-year"></span>
      </td>
    </tr>
  </table>

  <!-- ×˜×‘×œ×ª ×¤×¢×•×œ×•×ª â€” 20 ×©×•×¨×•×ª ×¡×˜×˜×™×•×ª (× ××œ××•×ª ×‘-JS) -->
  <table style="width:calc(100% - 64px);margin:0 32px;border-collapse:collapse;table-layout:fixed;">
    <colgroup>
      <col style="width:80px;">
      <col style="width:36px;">
      <col style="width:40px;">
      <col style="width:40px;">
      <col style="width:108px;">
      <col style="width:108px;">
      <col style="width:255px;">
      <col style="width:48px;">
      <col style="width:42px;">
      <col style="width:38px;">
      <col style="width:44px;">
      <col style="width:38px;">
      <col style="width:53px;">
      <col style="width:38px;">
    </colgroup>
    <thead>
      <tr style="background:#d0d0d0;">
        <th style="border:1px solid #000;padding:3px 2px;text-align:center;font-size:7.5pt;">×ª××¨×™×š</th>
        <th style="border:1px solid #000;padding:3px 1px;text-align:center;font-size:7.5pt;">×™×•×</th>
        <th style="border:1px solid #000;padding:3px 1px;text-align:center;font-size:7.5pt;">××©×¢×”</th>
        <th style="border:1px solid #000;padding:3px 1px;text-align:center;font-size:7.5pt;">×¢×“ ×©×¢×”</th>
        <th style="border:1px solid #000;padding:3px 2px;text-align:center;font-size:7.5pt;">×××§×•×</th>
        <th style="border:1px solid #000;padding:3px 2px;text-align:center;font-size:7.5pt;">×œ××§×•×</th>
        <th style="border:1px solid #000;padding:3px 2px;text-align:center;font-size:7.5pt;">××˜×¨×ª ×”×¤×¢×•×œ×”</th>
        <th style="border:1px solid #000;padding:3px 1px;text-align:center;font-size:6.5pt;">×‘×™×Ÿ ×¢×™×¨×•× ×™</th>
        <th style="border:1px solid #000;padding:3px 1px;text-align:center;font-size:7.5pt;">×¢×™×¨×•× ×™</th>
        <th style="border:1px solid #000;padding:3px 1px;text-align:center;font-size:7.5pt;">×‘×•×§×¨</th>
        <th style="border:1px solid #000;padding:3px 1px;text-align:center;font-size:7.5pt;">×¦×”×¨×™×™×</th>
        <th style="border:1px solid #000;padding:3px 1px;text-align:center;font-size:7.5pt;">×¢×¨×‘</th>
        <th style="border:1px solid #000;padding:3px 1px;text-align:center;font-size:6.5pt;">×œ×™× ×” ×‘××‘× ×”/ ×©×˜×—</th>
        <th style="border:1px solid #000;padding:3px 1px;text-align:center;font-size:7.5pt;">×¡×”"×›</th>
      </tr>
    </thead>
    <tbody>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
      <tr class="epd-row"><td class="epd-c epd-dt">&nbsp;</td><td class="epd-c epd-dy">&nbsp;</td><td class="epd-c epd-ft">&nbsp;</td><td class="epd-c epd-tt">&nbsp;</td><td class="epd-c epd-fp">&nbsp;</td><td class="epd-c epd-tp">&nbsp;</td><td class="epd-c-l epd-pu">&nbsp;</td><td class="epd-c epd-bi">&nbsp;</td><td class="epd-c epd-ir">&nbsp;</td><td class="epd-c epd-bk">&nbsp;</td><td class="epd-c epd-ts">&nbsp;</td><td class="epd-c epd-ev">&nbsp;</td><td class="epd-c epd-ln">&nbsp;</td><td class="epd-c epd-tot">&nbsp;</td></tr>
    </tbody>
  </table>

  <!-- ×ª×—×ª×™×ª: ×”×¦×”×¨×” + ×—×ª×™××•×ª + 3 ×¨×™×‘×•×¢×™ ××™×©×•×¨ (×–×” ×œ×¦×“ ×–×”) -->
  <table style="width:calc(100% - 64px);margin:4px 32px 0 32px;border-collapse:collapse;">
    <tr>
      <!-- ×”×¦×”×¨×ª ×¢×•×‘×“ -->
      <td style="border:1px solid #000;padding:5px 7px;width:32%;vertical-align:top;background:#fff;">
        <div style="font-weight:bold;font-size:8pt;text-align:center;margin-bottom:3px;">×”×¦×”×¨×ª ×¢×•×‘×“</div>
        <div style="font-size:7pt;line-height:1.4;">×× ×™ ×”×—"× ××¦×”×™×¨/×” ×‘×–×” ×›×™ ×¢×‘×“×ª×™ ×‘×©×¢×•×ª ×•×œ× ×ª×™ ×‘××§×•××•×ª ×”××¤×•×¨×˜×™× ×œ×¢×™×œ ×•×›×™ ×”×¤×¨×˜×™× ×”× "×œ × ×›×•× ×™× ×•××“×•×™×§×™×. ×™×“×•×¢ ×œ×™ ×›×™ ×× ×××¡×•×¨ ×¤×¨×˜×™× ×›×•×–×‘×™× ××”×™×” ×¦×¤×•×™/×” ×œ××—×¨×™×•×ª ×¤×œ×™×œ×™×ª.</div>
        <div id="eshel-pdf-sig-cell" style="margin-top:8px;font-size:7.5pt;">×—×ª×™××ª ×”×¢×•×‘×“: ____________________________</div>
        <div id="eshel-pdf-date-cell" style="margin-top:5px;font-size:7.5pt;">×ª××¨×™×š: _______________</div>
      </td>
      <!-- ××™×©×•×¨ ×××•× ×” ×™×©×™×¨ -->
      <td style="border:1px solid #000;padding:5px 7px;width:26%;vertical-align:top;background:#fff;">
        <div style="font-weight:bold;font-size:8pt;text-align:center;margin-bottom:3px;">××™×©×•×¨ ×××•× ×” ×™×©×™×¨</div>
        <div style="font-size:7pt;line-height:1.4;">×”×¨×™× ×™ ×××©×¨/×ª ×‘×–×” ×›×™:</div>
        <div style="font-size:7pt;margin-top:3px;">â˜ ×”×¤×¢×•×œ×•×ª ×”××¤×•×¨×˜×•×ª ×œ×¢×™×œ ×‘×•×¦×¢×• ×‘×¤×•×¢×œ ×¢"×™ ×”×¢×•×‘×“/×ª</div>
        <div style="font-size:7pt;margin-top:2px;">â˜ ×‘×™×¦×•×¢ ×”×¤×¢×•×œ×•×ª ×”×™×” ×”×›×¨×—×™ ×œ×¦×•×¨×š ×”×ª×¤×§×™×“</div>
        <div style="margin-top:6px;font-size:7.5pt;">×©×: ____________________</div>
        <div style="margin-top:4px;font-size:7.5pt;">×—×ª×™××”: _________________</div>
        <div style="margin-top:4px;font-size:7.5pt;">×ª××¨×™×š: _______________</div>
      </td>
      <!-- ××™×©×•×¨ ×××¨×›×œ ×”×™×—×™×“×” -->
      <td style="border:1px solid #000;padding:5px 7px;width:26%;vertical-align:top;background:#fff;">
        <div style="font-weight:bold;font-size:8pt;text-align:center;margin-bottom:3px;">××™×©×•×¨ ×××¨×›×œ ×”×™×—×™×“×”</div>
        <div style="font-size:7pt;line-height:1.4;">×‘×“×§×ª×™ ××ª ×”×¨×™×©×•××™× ×•××¦××ª×™ ××•×ª× ×ª×•×××™× ××ª ×”×“×™×•×•×—.</div>
        <div style="font-size:7pt;margin-top:3px;line-height:1.4;">×œ×¢×•×‘×“/×ª ××•×©×¨ ×œ×ª×©×œ×•×: _________ â‚ª</div>
        <div style="margin-top:6px;font-size:7.5pt;">×©×: ____________________</div>
        <div style="margin-top:4px;font-size:7.5pt;">×—×ª×™××”: _________________</div>
        <div style="margin-top:4px;font-size:7.5pt;">×ª××¨×™×š: _______________</div>
      </td>
      <!-- ××™×©×•×¨ ×‘×•×—×Ÿ ×—×©×‘×•×ª -->
      <td style="border:1px solid #000;padding:5px 7px;width:16%;vertical-align:top;background:#fff;">
        <div style="font-weight:bold;font-size:8pt;text-align:center;margin-bottom:3px;">××™×©×•×¨ ×‘×•×—×Ÿ ×—×©×‘×•×ª</div>
        <div style="margin-top:8px;font-size:7.5pt;">×©×: ____________________</div>
        <div style="margin-top:4px;font-size:7.5pt;">×—×ª×™××”: _________________</div>
        <div style="margin-top:4px;font-size:7.5pt;">×ª××¨×™×š: _______________</div>
      </td>
    </tr>
  </table>

</div>

<script>
  // --- Firebase Auth ---
  const firebaseConfig = {
    apiKey: "AIzaSyDpmHADZLmgJsPBUmpa3_lfeMjtVE1f8Ws",
    authDomain: "shelach-reports.firebaseapp.com",
    projectId: "shelach-reports",
    storageBucket: "shelach-reports.firebasestorage.app",
    messagingSenderId: "890845711067",
    appId: "1:890845711067:web:746dde4901125d1acf9afe"
  };
  // Local preview bypass â€” hide login immediately before Firebase loads
  const _isLocal = window.location.protocol === 'file:' || window.location.hostname === 'localhost';
  if (_isLocal) {
    document.getElementById('loginOverlay').style.display = 'none';
  }

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const provider = new firebase.auth.GoogleAuthProvider();
  const db = firebase.firestore();

  auth.onAuthStateChanged(function(user) {
    if (user) {
      document.getElementById('loginOverlay').style.display = 'none';
      document.getElementById('userInfo').style.display = 'flex';
      document.getElementById('userName').textContent = user.displayName || '';
      const avatar = document.getElementById('userAvatar');
      if (user.photoURL) {
        avatar.src = user.photoURL;
        avatar.style.display = 'block';
      } else {
        avatar.style.display = 'none';
      }
      // Load user data from Firestore after sign-in
      loadSettings();
    } else {
      // Don't show login screen if this is a principal signing link
      const isPrincipalMode = new URLSearchParams(window.location.search).has('sign');
      if (!isPrincipalMode && !_isLocal) {
        document.getElementById('loginOverlay').style.display = 'flex';
      }
      if (_isLocal) { loadSettings(); } // load from localStorage when local
      document.getElementById('userInfo').style.display = 'none';
    }
  });

  function handleSignIn() {
    document.getElementById('loginError').style.display = 'none';
    auth.signInWithPopup(provider).catch(function(error) {
      console.error('Sign-in error:', error);
      document.getElementById('loginError').style.display = 'block';
    });
  }

  function handleSignOut() {
    auth.signOut();
  }

  // --- Firestore helpers ---
  async function saveToCloud(collection, docId, data) {
    if (!auth.currentUser) return;
    const uid = auth.currentUser.uid;
    await db.collection('users').doc(uid).collection(collection).doc(docId).set(data);
  }

  async function loadFromCloud(collection, docId) {
    if (!auth.currentUser) return null;
    const uid = auth.currentUser.uid;
    const snap = await db.collection('users').doc(uid).collection(collection).doc(docId).get();
    return snap.exists ? snap.data() : null;
  }

  // ××¢×‘×¨ ×‘×™×Ÿ ×“×¤×™×
  function showPage(name) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('page-' + name).classList.add('active');
    event.target.classList.add('active');
    if (name === 'eshel') refreshEshelInfo();
  }

  // ×©××™×¨×” ×‘-localStorage
  function saveSettings() {
    const data = {
      firstName:     document.getElementById('firstName').value,
      lastName:      document.getElementById('lastName').value,
      idNumber:      document.getElementById('idNumber').value,
      jobScope:      document.getElementById('jobScope').value,
      address:       document.getElementById('address').value,
      substituteFor: document.getElementById('substituteFor').value,
      homeCity:      document.getElementById('homeCity').value,
      workplace:     document.getElementById('workplace').value,
      schoolName:    document.getElementById('schoolName').value,
      district:      document.getElementById('district').value,
      shelach: [
        document.getElementById('shelach_sun').value,
        document.getElementById('shelach_mon').value,
        document.getElementById('shelach_tue').value,
        document.getElementById('shelach_wed').value,
        document.getElementById('shelach_thu').value,
        document.getElementById('shelach_fri').value,
      ],
      school: [
        document.getElementById('school_sun').value,
        document.getElementById('school_mon').value,
        document.getElementById('school_tue').value,
        document.getElementById('school_wed').value,
        document.getElementById('school_thu').value,
        document.getElementById('school_fri').value,
      ],
      workDays: document.getElementById('workDays').value,
    };

    localStorage.setItem('shelach_settings', JSON.stringify(data));
    saveToCloud('settings', 'main', data);

    const msg = document.getElementById('saveMsg');
    msg.classList.add('show');
    setTimeout(() => msg.classList.remove('show'), 2500);
  }

  // ×‘×¨×™×¨×•×ª ××—×“×œ
  const DEFAULTS = {
    firstName:     '',
    lastName:      '',
    idNumber:      '',
    jobScope:      '',
    address:       '',
    substituteFor: '',
    homeCity:      '',
    workplace:     '',
    schoolName:    '',
    district:      '',
    shelach:       ['', '', '', '', '', ''],
    school:        ['', '', '', '', '', ''],
  };

  function applySettings(d) {
    document.getElementById('firstName').value     = d.firstName     ?? '';
    document.getElementById('lastName').value      = d.lastName      ?? '';
    document.getElementById('idNumber').value      = d.idNumber      ?? '';
    document.getElementById('jobScope').value      = d.jobScope      ?? '';
    document.getElementById('address').value       = d.address       ?? '';
    document.getElementById('substituteFor').value = d.substituteFor ?? '';
    document.getElementById('homeCity').value      = d.homeCity      ?? '';
    document.getElementById('workplace').value     = d.workplace     ?? '';
    document.getElementById('schoolName').value    = d.schoolName    ?? '';
    document.getElementById('district').value      = d.district      ?? '';

    const days = ['sun','mon','tue','wed','thu','fri'];
    days.forEach((day, i) => {
      document.getElementById('shelach_' + day).value = d.shelach?.[i] ?? '';
      document.getElementById('school_'  + day).value = d.school?.[i]  ?? '';
    });
    document.getElementById('workDays').value = d.workDays ?? '';
  }

  async function loadSettings() {
    // Try Firestore first; fall back to localStorage
    const cloud = await loadFromCloud('settings', 'main');
    if (cloud) {
      applySettings(cloud);
      localStorage.setItem('shelach_settings', JSON.stringify(cloud));
    } else {
      const raw = localStorage.getItem('shelach_settings');
      applySettings(raw ? JSON.parse(raw) : DEFAULTS);
    }
  }

  // ×©××•×ª ×™××™ ×©×‘×•×¢ ×‘×¢×‘×¨×™×ª (0=×¨××©×•×Ÿ, 6=×©×‘×ª)
  const dayNames = ['×', '×‘', '×’', '×“', '×”', '×•', '×©'];

  // ×—×•×¤×©×•×ª ××©×¨×“ ×”×—×™× ×•×š ×ª×©×¤"×• â€” ×—×˜×™×‘×•×ª ×¢×œ×™×•× ×•×ª
  const VACATIONS = [
    { start: new Date(2025,  8, 22), end: new Date(2025,  8, 24), label: '×¨××© ×”×©× ×”' },
    { start: new Date(2025,  9,  1), end: new Date(2025,  9,  2), label: '×™×•× ×›×™×¤×•×¨' },
    { start: new Date(2025,  9,  3), end: new Date(2025,  9,  5), label: '×’×©×¨' },
    { start: new Date(2025,  9,  6), end: new Date(2025,  9, 14), label: '×¡×•×›×•×ª' },
    { start: new Date(2025,  9, 15), end: new Date(2025,  9, 15), label: '××¡×¨×• ×—×’ ×¡×•×›×•×ª' },
    { start: new Date(2025, 11, 16), end: new Date(2025, 11, 22), label: '×—× ×•×›×”' },
    { start: new Date(2026,  2,  3), end: new Date(2026,  2,  4), label: '×¤×•×¨×™×' },
    { start: new Date(2026,  2, 24), end: new Date(2026,  3,  8), label: '×¤×¡×—' },
    { start: new Date(2026,  3, 22), end: new Date(2026,  3, 22), label: '×™×•× ×”×¢×¦×××•×ª' },
    { start: new Date(2026,  4,  5), end: new Date(2026,  4,  5), label: '×œ"×’ ×‘×¢×•××¨' },
    { start: new Date(2026,  4, 21), end: new Date(2026,  4, 22), label: '×©×‘×•×¢×•×ª' },
    { start: new Date(2026,  5, 20), end: new Date(2026,  7, 31), label: '×—×•×¤×©×ª ×§×™×¥' },
  ];

  function getVacationLabel(date) {
    const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    for (const v of VACATIONS) {
      if (d >= v.start && d <= v.end) return v.label;
    }
    return null;
  }

  function updateCalendar() {
    const month = parseInt(document.getElementById('selectMonth').value);
    const year  = parseInt(document.getElementById('selectYear').value);

    const daysInMonth = new Date(year, month + 1, 0).getDate();

    document.querySelectorAll('#reportBody tr').forEach(row => {
      const day = parseInt(row.dataset.day);

      if (day > daysInMonth) { row.style.display = 'none'; return; }

      const date    = new Date(year, month, day);
      const weekday = date.getDay();

      if (weekday === 6) { row.style.display = 'none'; return; }

      row.style.display = '';
      row.querySelector('.weekday').textContent = dayNames[weekday];
      weekday === 5 ? row.classList.add('row-week-end') : row.classList.remove('row-week-end');

      const vacation = getVacationLabel(date);
      const inputs   = row.querySelectorAll('input');
      const descInput = inputs[3]; // ×¢××•×“×ª "×ª×™××•×¨ ×”×¤×¢×•×œ×”" (××—×¨×™ ×©×¢×•×ª, ×©"× , ×›×™×ª×”)

      if (vacation) {
        row.classList.add('row-vacation');
        row.dataset.vacationLabel = vacation;
      } else {
        row.classList.remove('row-vacation');
        row.dataset.vacationLabel = '';
      }
    });

    loadReport(month, year);
  }

  // --- ×©××™×¨×” ×•×˜×¢×™× ×” ×©×œ × ×ª×•× ×™ ×”×“×•×— ×”×—×•×“×©×™ ---

  function reportKey(month, year) {
    return 'shelach_report_' + year + '_' + month;
  }

  function saveReport() {
    const month = parseInt(document.getElementById('selectMonth').value);
    const year  = parseInt(document.getElementById('selectYear').value);
    const data  = {};

    document.querySelectorAll('#reportBody tr').forEach(row => {
      if (row.style.display === 'none') return;
      const day    = row.dataset.day;
      const inputs = row.querySelectorAll('input');
      data[day] = {
        hours:       inputs[0].value,
        substitute:  inputs[1].value,
        kita:        inputs[2].value,
        description: inputs[3].value,
        reason:      inputs[4].value,
      };
    });

    data['_notes'] = {
      chet:      document.getElementById('note-chet').value,
      tet:       document.getElementById('note-tet').value,
      masaot:    document.getElementById('note-masaot').value,
      mishatzim: document.getElementById('note-mishatzim').value,
    };
    data['_date']      = document.getElementById('reportDate').value;
    data['_signature'] = sigIsEmpty() ? '' : sigCanvas.toDataURL();

    localStorage.setItem(reportKey(month, year), JSON.stringify(data));
    saveToCloud('reports', reportKey(month, year), data);
  }

  function clearReport() {
    const month = parseInt(document.getElementById('selectMonth').value);
    const year  = parseInt(document.getElementById('selectYear').value);
    const monthName = document.getElementById('selectMonth').selectedOptions[0].text;
    if (!confirm('×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×©×œ ' + monthName + ' ' + year + '?')) return;
    localStorage.removeItem(reportKey(month, year));
    if (auth.currentUser) {
      const uid = auth.currentUser.uid;
      db.collection('users').doc(uid).collection('reports').doc(reportKey(month, year)).delete();
    }
    loadReport(month, year);
  }

  function applyReport(data) {
    document.querySelectorAll('#reportBody tr').forEach(row => {
      const day = row.dataset.day;
      if (!data[day]) return;
      const inputs = row.querySelectorAll('input');
      inputs[0].value = data[day].hours       || '';
      inputs[1].value = data[day].substitute  || '';
      inputs[2].value = data[day].kita        || '';
      inputs[3].value = data[day].description || (row.dataset.vacationLabel || '');
      inputs[4].value = data[day].reason      || '';
    });
    if (data['_notes']) {
      document.getElementById('note-chet').value      = data['_notes'].chet      || '';
      document.getElementById('note-tet').value       = data['_notes'].tet       || '';
      document.getElementById('note-masaot').value    = data['_notes'].masaot    || '';
      document.getElementById('note-mishatzim').value = data['_notes'].mishatzim || '';
    }
    if (data['_date']) document.getElementById('reportDate').value = data['_date'];
    if (data['_signature']) {
      const img = new Image();
      img.onload = () => sigCtx.drawImage(img, 0, 0);
      img.src = data['_signature'];
    }
    updateTotal();
  }

  async function loadReport(month, year) {
    // Clear everything first
    document.querySelectorAll('#reportBody tr').forEach(row => {
      row.querySelectorAll('input').forEach(inp => { inp.value = ''; });
      if (row.dataset.vacationLabel) row.querySelectorAll('input')[3].value = row.dataset.vacationLabel;
    });
    document.getElementById('note-chet').value      = '';
    document.getElementById('note-tet').value       = '';
    document.getElementById('note-masaot').value    = '';
    document.getElementById('note-mishatzim').value = '';
    document.getElementById('reportDate').value     = '';
    sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);

    // Try Firestore first, fall back to localStorage
    const cloud = await loadFromCloud('reports', reportKey(month, year));
    if (cloud) {
      localStorage.setItem(reportKey(month, year), JSON.stringify(cloud));
      applyReport(cloud);
    } else {
      const raw = localStorage.getItem(reportKey(month, year));
      if (!raw) { updateTotal(); }
      else applyReport(JSON.parse(raw));
    }

    // Load principal signature status for this month
    loadPrincipalSignature(month, year);

    // Refresh calendar if in calendar mode
    if (_currentMode === 'calendar') renderCalendar();
  }

  // ×¢×“×›×•×Ÿ ×¡×”"×› ×©×¢×•×ª â€” ××¡×›× ××ª ×¢××•×“×ª ×©"× /×"×
  function updateTotal() {
    let total = 0;
    document.querySelectorAll('#reportBody tr').forEach(row => {
      if (row.style.display === 'none') return;
      const v = parseFloat(row.querySelectorAll('input')[1].value) || 0;
      total += v;
    });
    document.getElementById('totalHours').textContent = total || 0;
  }

  // ×©××™×¨×” ××•×˜×•××˜×™×ª + ×¢×“×›×•×Ÿ ×¡×”"×› ×‘×›×œ ×©×™× ×•×™
  document.getElementById('reportBody').addEventListener('input', () => {
    saveReport();
    updateTotal();
  });

  // ×©××™×¨×” ××•×˜×•××˜×™×ª ×©×œ ×”×¢×¨×•×ª ×”× ×•×©××™×
  ['note-chet', 'note-tet', 'note-masaot', 'note-mishatzim'].forEach(id => {
    document.getElementById(id).addEventListener('input', saveReport);
  });

  // ×©××™×¨×” ××•×˜×•××˜×™×ª ×©×œ ×ª××¨×™×š
  document.getElementById('reportDate').addEventListener('change', saveReport);

  // --- ×—×ª×™××” ---
  const sigCanvas = document.getElementById('signatureCanvas');
  const sigCtx    = sigCanvas.getContext('2d');
  let isDrawing = false, lastX = 0, lastY = 0;

  function sigPos(e) {
    const rect = sigCanvas.getBoundingClientRect();
    const src  = e.touches ? e.touches[0] : e;
    return {
      x: (src.clientX - rect.left) * (sigCanvas.width  / rect.width),
      y: (src.clientY - rect.top)  * (sigCanvas.height / rect.height),
    };
  }

  function sigIsEmpty() {
    return !sigCtx.getImageData(0, 0, sigCanvas.width, sigCanvas.height).data.some(v => v !== 0);
  }

  function clearSignature() {
    sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
    saveReport();
  }

  sigCanvas.addEventListener('mousedown',  e => { isDrawing = true;  const p = sigPos(e); lastX = p.x; lastY = p.y; });
  sigCanvas.addEventListener('mousemove',  e => {
    if (!isDrawing) return;
    const p = sigPos(e);
    sigCtx.beginPath(); sigCtx.moveTo(lastX, lastY); sigCtx.lineTo(p.x, p.y);
    sigCtx.strokeStyle = '#000'; sigCtx.lineWidth = 2; sigCtx.lineCap = 'round';
    sigCtx.stroke();
    lastX = p.x; lastY = p.y;
  });
  sigCanvas.addEventListener('mouseup',    () => { if (isDrawing) { isDrawing = false; saveReport(); } });
  sigCanvas.addEventListener('mouseleave', () => { if (isDrawing) { isDrawing = false; saveReport(); } });

  sigCanvas.addEventListener('touchstart', e => { e.preventDefault(); isDrawing = true;  const p = sigPos(e); lastX = p.x; lastY = p.y; }, { passive: false });
  sigCanvas.addEventListener('touchmove',  e => {
    e.preventDefault();
    if (!isDrawing) return;
    const p = sigPos(e);
    sigCtx.beginPath(); sigCtx.moveTo(lastX, lastY); sigCtx.lineTo(p.x, p.y);
    sigCtx.strokeStyle = '#000'; sigCtx.lineWidth = 2.5; sigCtx.lineCap = 'round';
    sigCtx.stroke();
    lastX = p.x; lastY = p.y;
  }, { passive: false });
  sigCanvas.addEventListener('touchend', () => { if (isDrawing) { isDrawing = false; saveReport(); } });

  // × ×™×•×•×˜ ××§×œ×“×ª ×‘×˜×‘×œ×”
  document.getElementById('reportBody').addEventListener('keydown', function(e) {
    if (!['Enter','ArrowDown','ArrowUp','ArrowLeft','ArrowRight'].includes(e.key)) return;

    // ×›×œ ×”-inputs ×”× ×¨××™× ×•×œ× ××•×©×‘×ª×™× â€” ×œ×¤×™ ×¡×“×¨ ×”×˜××‘
    const allInputs = Array.from(
      document.querySelectorAll('#reportBody tr:not(.row-vacation) input:not(:disabled)')
    ).filter(inp => inp.closest('tr').style.display !== 'none');

    const idx = allInputs.indexOf(e.target);
    if (idx === -1) return;

    // ---- ×—×¥ ×©×××œ: ×¢×‘×•×¨ ×œ×ª× ×”×‘× (×©×××œ×” ×‘×“×£ RTL) ×¨×§ ×× ×”×¡××Ÿ ×‘×¡×•×£ ×”×˜×§×¡×˜ ----
    if (e.key === 'ArrowLeft') {
      const atEnd = e.target.selectionStart === e.target.value.length
                 && e.target.selectionEnd   === e.target.value.length;
      if (!atEnd) return;
      e.preventDefault();
      const next = allInputs[idx + 1];
      if (next) { next.focus(); next.select(); }
      return;
    }

    // ---- ×—×¥ ×™××™×Ÿ: ×¢×‘×•×¨ ×œ×ª× ×”×§×•×“× (×™××™× ×” ×‘×“×£ RTL) ×¨×§ ×× ×”×¡××Ÿ ×‘×ª×—×™×œ×ª ×”×˜×§×¡×˜ ----
    if (e.key === 'ArrowRight') {
      const atStart = e.target.selectionStart === 0
                   && e.target.selectionEnd   === 0;
      if (!atStart) return;
      e.preventDefault();
      const prev = allInputs[idx - 1];
      if (prev) { prev.focus(); prev.select(); }
      return;
    }

    // ---- Enter: ×ª× ×”×‘× ----
    if (e.key === 'Enter') {
      e.preventDefault();
      const next = allInputs[idx + 1];
      if (next) next.focus();
      return;
    }

    // ---- ×—×¥ ×œ××˜×” / ×œ××¢×œ×”: ××•×ª×” ×¢××•×“×” ×‘×©×•×¨×” ×”×¡××•×›×” ----
    e.preventDefault();
    const currentRow = e.target.closest('tr');
    const colIdx     = Array.from(currentRow.querySelectorAll('input')).indexOf(e.target);

    const visibleRows = Array.from(document.querySelectorAll('#reportBody tr'))
      .filter(r => r.style.display !== 'none' && !r.classList.contains('row-vacation'));
    const rowIdx       = visibleRows.indexOf(currentRow);
    const targetRowIdx = e.key === 'ArrowDown' ? rowIdx + 1 : rowIdx - 1;

    if (targetRowIdx < 0 || targetRowIdx >= visibleRows.length) return;
    const destInputs = Array.from(
      visibleRows[targetRowIdx].querySelectorAll('input:not(:disabled)')
    );
    const dest = destInputs[Math.min(colIdx, destInputs.length - 1)];
    if (dest) { dest.focus(); dest.select(); }
  });

  // --- ××¦×‘ ×”×–× ×” (×˜×‘×œ×” / ×œ×•×— ×©× ×” / ×™×•××™) ---

  let _currentMode = 'table';

  function switchMode(mode) {
    _currentMode = mode;
    document.getElementById('view-table').style.display    = mode === 'table'    ? '' : 'none';
    document.getElementById('view-calendar').style.display = mode === 'calendar' ? '' : 'none';
    const btns = document.querySelectorAll('#page-report .mode-btn');
    btns.forEach(btn => btn.classList.remove('active'));
    const idx = ['table','calendar'].indexOf(mode);
    if (btns[idx]) btns[idx].classList.add('active');
    if (mode === 'calendar') renderCalendar();
  }

  let _currentEshelMode = 'table';

  function switchEshelMode(mode) {
    _currentEshelMode = mode;
    document.getElementById('eshel-view-table').style.display  = mode === 'table'  ? '' : 'none';
    document.getElementById('eshel-view-wizard').style.display = mode === 'wizard' ? '' : 'none';
    const btns = document.querySelectorAll('#page-eshel .mode-btn');
    btns.forEach(btn => btn.classList.remove('active'));
    const idx = ['table','wizard'].indexOf(mode);
    if (btns[idx]) btns[idx].classList.add('active');
    if (mode === 'wizard') renderWizard(0);
  }

  // ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ××©×•×ª×¤×•×ª â€” ×›×•×ª×‘×•×ª ×™×©×™×¨×•×ª ×œ×ª×•×š ×©×•×¨×•×ª ×”×˜×‘×œ×” ×”×§×™×™××ª
  function setDayData(day, { hours, substitute, kita, description, reason }) {
    const row = document.querySelector(`#reportBody tr[data-day="${day}"]`);
    if (!row || row.style.display === 'none') return;
    const inputs = row.querySelectorAll('input');
    inputs[0].value = hours       ?? inputs[0].value;
    inputs[1].value = substitute  ?? inputs[1].value;
    inputs[2].value = kita        ?? inputs[2].value;
    inputs[3].value = description ?? inputs[3].value;
    inputs[4].value = reason      ?? inputs[4].value;
    updateTotal();
    saveReport();
  }

  function getDayData(day) {
    const row = document.querySelector(`#reportBody tr[data-day="${day}"]`);
    if (!row) return { hours:'', substitute:'', kita:'', description:'', reason:'' };
    const inputs = row.querySelectorAll('input');
    return {
      hours:       inputs[0].value,
      substitute:  inputs[1].value,
      kita:        inputs[2].value,
      description: inputs[3].value,
      reason:      inputs[4].value,
    };
  }

  // --- Calendar view ---

  let _calMultiSelect = false;
  let _calSelected    = new Set();
  let _panelDay       = null;
  let _panelIsBulk    = false;

  function renderCalendar() {
    const month       = parseInt(document.getElementById('selectMonth').value);
    const year        = parseInt(document.getElementById('selectYear').value);
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const container   = document.getElementById('view-calendar');
    container.innerHTML = '';

    // Multi-select bar
    const bar = document.createElement('div');
    bar.className = 'cal-multiselect-bar';
    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'btn-multiselect' + (_calMultiSelect ? ' active' : '');
    toggleBtn.textContent = _calMultiSelect ? 'âœ“ ×‘×—×™×¨×” ××¨×•×‘×” â€” ×¤×¢×™×œ' : '×‘×—×™×¨×” ××¨×•×‘×”';
    toggleBtn.onclick = toggleCalMultiSelect;
    bar.appendChild(toggleBtn);
    if (_calMultiSelect && _calSelected.size > 0) {
      const countSpan = document.createElement('span');
      countSpan.id = 'multiselect-count';
      countSpan.textContent = _calSelected.size + ' ×™××™× × ×‘×—×¨×•';
      bar.appendChild(countSpan);
      const applyBtn = document.createElement('button');
      applyBtn.className = 'btn-multiselect-apply';
      applyBtn.textContent = '××œ× ×œ×›×œ ×”× ×‘×—×¨×™× â–¸';
      applyBtn.onclick = openBulkPanel;
      bar.appendChild(applyBtn);
    }
    container.appendChild(bar);

    // Grid
    const grid = document.createElement('div');
    grid.className = 'cal-grid';

    // Headers (RTL: ×¨××©×•×Ÿ on right = column 1)
    ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™'].forEach(name => {
      const h = document.createElement('div');
      h.className = 'cal-header';
      h.textContent = name;
      grid.appendChild(h);
    });

    // Day cells
    for (let day = 1; day <= daysInMonth; day++) {
      const date    = new Date(year, month, day);
      const weekday = date.getDay();
      if (weekday === 6) continue; // skip Shabbat

      const vacation  = getVacationLabel(date);
      const data      = getDayData(day);
      const hasData   = !!(data.hours || data.substitute || data.kita || data.description || data.reason);
      const isSelected = _calSelected.has(day);

      const cell = document.createElement('div');
      cell.className = 'cal-day' +
        (vacation   ? ' vacation'  : '') +
        (hasData && !vacation ? ' has-data' : '') +
        (isSelected ? ' selected'  : '');
      cell.style.gridColumn = weekday + 1;

      cell.innerHTML =
        `<div class="cal-day-num">${day}</div>` +
        (vacation ? `<div class="cal-vacation-label">${vacation}</div>` : '') +
        (hasData && !vacation ? '<div class="cal-day-dot"></div>' : '');

      cell.onclick = () => _calMultiSelect ? toggleCalDay(day) : openDayPanel(day);
      grid.appendChild(cell);
    }
    container.appendChild(grid);
  }

  function toggleCalMultiSelect() {
    _calMultiSelect = !_calMultiSelect;
    _calSelected.clear();
    renderCalendar();
  }

  function toggleCalDay(day) {
    _calSelected.has(day) ? _calSelected.delete(day) : _calSelected.add(day);
    renderCalendar();
  }

  // --- Day panel ---

  function openDayPanel(day) {
    _panelDay    = day;
    _panelIsBulk = false;
    const month = parseInt(document.getElementById('selectMonth').value);
    const year  = parseInt(document.getElementById('selectYear').value);
    const date  = new Date(year, month, day);
    const wName = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™'][date.getDay()];
    document.getElementById('day-panel-title').textContent = wName + ', ' + day + ' ×‘' + MONTH_NAMES[month];
    const d = getDayData(day);
    document.getElementById('dp-hours').value       = d.hours       || '';
    document.getElementById('dp-substitute').value  = d.substitute  || '';
    document.getElementById('dp-kita').value        = d.kita        || '';
    document.getElementById('dp-description').value = d.description || '';
    document.getElementById('dp-reason').value      = d.reason      || '';
    document.getElementById('day-panel').classList.add('open');
    setTimeout(() => document.getElementById('dp-hours').focus(), 80);
  }

  function openBulkPanel() {
    if (_calSelected.size === 0) return;
    _panelDay    = null;
    _panelIsBulk = true;
    document.getElementById('day-panel-title').textContent = '××œ× ×¢×‘×•×¨ ' + _calSelected.size + ' ×™××™× × ×‘×—×¨×™×';
    ['dp-hours','dp-substitute','dp-kita','dp-description','dp-reason']
      .forEach(id => { document.getElementById(id).value = ''; });
    document.getElementById('day-panel').classList.add('open');
  }

  function closeDayPanel() {
    document.getElementById('day-panel').classList.remove('open');
    _panelDay    = null;
    _panelIsBulk = false;
  }

  function saveDayPanel() {
    const data = {
      hours:       document.getElementById('dp-hours').value,
      substitute:  document.getElementById('dp-substitute').value,
      kita:        document.getElementById('dp-kita').value,
      description: document.getElementById('dp-description').value,
      reason:      document.getElementById('dp-reason').value,
    };
    const days = _panelIsBulk ? Array.from(_calSelected) : [_panelDay];
    days.forEach(d => setDayData(d, data));
    closeDayPanel();
    if (_panelIsBulk) { _calSelected.clear(); }
    renderCalendar();
  }

  function clearDayPanel() {
    if (!_panelDay) return;
    setDayData(_panelDay, { hours:'', substitute:'', kita:'', description:'', reason:'' });
    closeDayPanel();
    renderCalendar();
  }

  // --- ××©"×œ Wizard ---

  let _wizardRow = 0;

  function getEshelRowData(idx) {
    const rows = document.querySelectorAll('#eshelBody tr');
    if (idx < 0 || idx >= rows.length) return null;
    const r = rows[idx];
    return {
      date:      r.querySelector('.eshel-date').value,
      dayname:   r.querySelector('.eshel-dayname').value,
      fromTime:  r.querySelector('.eshel-from-time').value,
      toTime:    r.querySelector('.eshel-to-time').value,
      fromPlace: r.querySelector('.eshel-from-place').value,
      toPlace:   r.querySelector('.eshel-to-place').value,
      purpose:   r.querySelector('.eshel-purpose').value,
      beinIri:   r.querySelector('.eshel-bein-iri').checked,
      iri:       r.querySelector('.eshel-iri').checked,
      boker:     r.querySelector('.eshel-boker').checked,
      tsaharaim: r.querySelector('.eshel-tsaharaim').checked,
      erev:      r.querySelector('.eshel-erev').checked,
      lina:      r.querySelector('.eshel-lina').value,
      total:     r.querySelector('.eshel-total').value,
    };
  }

  function setEshelRowData(idx, data) {
    const rows = document.querySelectorAll('#eshelBody tr');
    if (idx < 0 || idx >= rows.length) return;
    const r = rows[idx];
    r.querySelector('.eshel-date').value        = data.date      ?? r.querySelector('.eshel-date').value;
    r.querySelector('.eshel-from-time').value   = data.fromTime  ?? r.querySelector('.eshel-from-time').value;
    r.querySelector('.eshel-to-time').value     = data.toTime    ?? r.querySelector('.eshel-to-time').value;
    r.querySelector('.eshel-from-place').value  = data.fromPlace ?? r.querySelector('.eshel-from-place').value;
    r.querySelector('.eshel-to-place').value    = data.toPlace   ?? r.querySelector('.eshel-to-place').value;
    r.querySelector('.eshel-purpose').value     = data.purpose   ?? r.querySelector('.eshel-purpose').value;
    r.querySelector('.eshel-bein-iri').checked  = data.beinIri   ?? r.querySelector('.eshel-bein-iri').checked;
    r.querySelector('.eshel-iri').checked       = data.iri       ?? r.querySelector('.eshel-iri').checked;
    r.querySelector('.eshel-boker').checked     = data.boker     ?? r.querySelector('.eshel-boker').checked;
    r.querySelector('.eshel-tsaharaim').checked = data.tsaharaim ?? r.querySelector('.eshel-tsaharaim').checked;
    r.querySelector('.eshel-erev').checked      = data.erev      ?? r.querySelector('.eshel-erev').checked;
    r.querySelector('.eshel-lina').value        = data.lina      ?? '';
    r.querySelector('.eshel-total').value       = data.total     ?? r.querySelector('.eshel-total').value;
    // Trigger day-name auto-fill if date changed
    if (data.date !== undefined) fillEshelDay(r.querySelector('.eshel-date'));
    saveEshel();
  }

  function renderWizard(idx) {
    const totalRows = document.querySelectorAll('#eshelBody tr').length;
    _wizardRow = Math.max(0, Math.min(idx, totalRows - 1));
    const data = getEshelRowData(_wizardRow);

    // Progress dots
    const dotsEl = document.getElementById('wizard-dots');
    dotsEl.innerHTML = '';
    for (let i = 0; i < totalRows; i++) {
      const d = getEshelRowData(i);
      const filled = !!(d && (d.date || d.purpose || d.total));
      const dot = document.createElement('div');
      dot.className = 'wizard-dot' + (filled ? ' filled' : '') + (i === _wizardRow ? ' current' : '');
      dot.title = '×¨×©×•××” ' + (i + 1);
      dot.onclick = (function(ri) { return function() { saveWizardRow(); renderWizard(ri); }; })(i);
      dotsEl.appendChild(dot);
    }

    document.getElementById('wizard-row-num').textContent = (_wizardRow + 1) + ' / ' + totalRows;

    // Fill fields
    document.getElementById('wz-date').value       = data.date      || '';
    document.getElementById('wz-dayname').value    = data.dayname   || '';
    document.getElementById('wz-from-time').value  = data.fromTime  || '';
    document.getElementById('wz-to-time').value    = data.toTime    || '';
    document.getElementById('wz-from-place').value = data.fromPlace || '';
    document.getElementById('wz-to-place').value   = data.toPlace   || '';
    document.getElementById('wz-purpose').value    = data.purpose   || '';
    document.getElementById('wz-bein-iri').checked  = data.beinIri   || false;
    document.getElementById('wz-iri').checked       = data.iri       || false;
    document.getElementById('wz-boker').checked     = data.boker     || false;
    document.getElementById('wz-tsaharaim').checked = data.tsaharaim || false;
    document.getElementById('wz-erev').checked      = data.erev      || false;
    document.getElementById('wz-lina').value        = data.lina      || '';
    document.getElementById('wz-total').value       = data.total     || '';

    document.getElementById('wz-prev').disabled = _wizardRow === 0;
    document.getElementById('wz-next').disabled = _wizardRow === totalRows - 1;
  }

  function saveWizardRow() {
    setEshelRowData(_wizardRow, {
      date:      document.getElementById('wz-date').value,
      fromTime:  document.getElementById('wz-from-time').value,
      toTime:    document.getElementById('wz-to-time').value,
      fromPlace: document.getElementById('wz-from-place').value,
      toPlace:   document.getElementById('wz-to-place').value,
      purpose:   document.getElementById('wz-purpose').value,
      beinIri:   document.getElementById('wz-bein-iri').checked,
      iri:       document.getElementById('wz-iri').checked,
      boker:     document.getElementById('wz-boker').checked,
      tsaharaim: document.getElementById('wz-tsaharaim').checked,
      erev:      document.getElementById('wz-erev').checked,
      lina:      document.getElementById('wz-lina').value,
      total:     document.getElementById('wz-total').value,
    });
  }

  function wizardNav(dir) {
    saveWizardRow();
    renderWizard(_wizardRow + dir);
  }

  function fillWizardDay() {
    const val = document.getElementById('wz-date').value;
    if (!val) { document.getElementById('wz-dayname').value = ''; return; }
    const names = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];
    document.getElementById('wz-dayname').value = names[new Date(val).getDay()];
  }

  // Populate time dropdowns (06:00â€“22:00, 30-min steps)
  (function initTimeSelects() {
    const opts = ['<option value="">â€” ×©×¢×” â€”</option>'];
    for (let h = 6; h <= 22; h++) {
      ['00','30'].forEach(m => {
        if (h === 22 && m === '30') return;
        const t = String(h).padStart(2,'0') + ':' + m;
        opts.push(`<option value="${t}">${t}</option>`);
      });
    }
    const html = opts.join('');
    document.getElementById('wz-from-time').innerHTML = html;
    document.getElementById('wz-to-time').innerHTML   = html;
  })();

  // --- ×™×™×¦×•× PDF ---

  const MONTH_NAMES = {
    8:'×¡×¤×˜××‘×¨', 9:'××•×§×˜×•×‘×¨', 10:'× ×•×‘××‘×¨', 11:'×“×¦××‘×¨',
    0:'×™× ×•××¨', 1:'×¤×‘×¨×•××¨', 2:'××¨×¥', 3:'××¤×¨×™×œ', 4:'×××™', 5:'×™×•× ×™'
  };

  // ×”×¢×¨×•×ª ×¦×“ ×™××™×Ÿ ×œ×¤×™ ××¡×¤×¨ ×™×•×
  const RIGHT_NOTES = {
    1:  '×¤×¨×˜ × ×•×©××™×, ×“×¨×›×™ ×‘×™×¦×•×¢ ×•×“×¨×›×™ ×¤×¢×•×œ×”',
    2:  '×©×›×‘×ª ×›×ª×•×ª: ×—',
    7:  '×©×›×‘×ª ×›×ª×•×ª: ×˜',
    11: '×©×›×‘×ª ×›×ª×•×ª: ___',
    16: '××¡×¢×•×ª ×•××¤×¢×œ×™×',
    21: '××©"×¦×™×',
    24: '×”×¢×¨×•×ª ×”×× ×—×” _______________________',
    27: '×—×ª×™××” ___________________________',
    28: '×”×¢×¨×•×ª ×××•× ×” ××—×•×–×™ ________________',
    30: '×—×ª×™××” ___________________________',
  };

  async function printReport() {
    const btn = document.querySelector('.btn-print');
    btn.textContent = 'â³ ××›×™×Ÿ...';
    btn.disabled = true;

    try {
      const month = parseInt(document.getElementById('selectMonth').value);
      const year  = parseInt(document.getElementById('selectYear').value);
      const raw   = localStorage.getItem('shelach_settings');
      const s     = raw ? JSON.parse(raw) : DEFAULTS;

      // ××™×œ×•×™ ×›×•×ª×¨×ª
      document.getElementById('pdf-district').textContent  = s.district   || '';
      document.getElementById('pdf-school').textContent    = s.schoolName || '';
      document.getElementById('pdf-month').textContent     = MONTH_NAMES[month];
      document.getElementById('pdf-year').textContent      = year;

      // ×¤×¨×˜×™ ××•×¨×”
      document.getElementById('pdf-id').textContent         = s.idNumber      || '';
      document.getElementById('pdf-lastname').textContent   = s.lastName      || '';
      document.getElementById('pdf-firstname').textContent  = s.firstName     || '';
      document.getElementById('pdf-jobscope').textContent   = s.jobScope      || '';
      document.getElementById('pdf-address').textContent    = s.address       || '';
      document.getElementById('pdf-substitute').textContent = s.substituteFor || '';
      document.getElementById('pdf-workdays').textContent   = s.workDays      || '___________________________';

      // ×©×¢×•×ª
      [0,1,2,3,4,5].forEach(i => {
        document.getElementById('pdf-sh' + i).textContent = s.shelach?.[i] || '';
        document.getElementById('pdf-sc' + i).textContent = s.school?.[i]  || '';
      });

      // ×—×ª×™××” ×•×ª××¨×™×š
      const sigDataUrl  = sigIsEmpty() ? '' : sigCanvas.toDataURL();
      const rawDate     = document.getElementById('reportDate').value;
      const dateDisplay = rawDate
        ? new Date(rawDate + 'T00:00:00').toLocaleDateString('he-IL')
        : '___________';

      // ×§×¨×™××ª ×”×¢×¨×•×ª ×”× ×•×©××™×
      const pdfNotes = {
        chet:      document.getElementById('note-chet').value,
        tet:       document.getElementById('note-tet').value,
        masaot:    document.getElementById('note-masaot').value,
        mishatzim: document.getElementById('note-mishatzim').value,
      };

      // ×‘× ×™×™×ª ×©×•×¨×•×ª ×”×˜×‘×œ×”
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const tbody = document.getElementById('pdf-body');
      tbody.innerHTML = '';
      let totalHours = 0;

      for (let day = 1; day <= daysInMonth; day++) {
        const date    = new Date(year, month, day);
        const weekday = date.getDay();
        if (weekday === 6) continue;

        const vacation  = getVacationLabel(date);
        const reportRow = document.querySelector(`#reportBody tr[data-day="${day}"]`);
        const inputs    = reportRow ? reportRow.querySelectorAll('input') : [];

        const hours   = inputs[0]?.value || '';
        const shanan  = inputs[1]?.value || '';
        const kita    = inputs[2]?.value || '';
        const desc    = inputs[3]?.value || '';
        const reason  = inputs[4]?.value || '';
        let note = RIGHT_NOTES[day] || '';
        // ×”×•×¡×£ ×ª×•×›×Ÿ ×”×¢×¨×•×ª ×©××•×œ× ×¢×œ ×™×“×™ ×”××©×ª××©
        if (day === 2  && pdfNotes.chet)      note += '<br>' + pdfNotes.chet;
        if (day === 7  && pdfNotes.tet)       note += '<br>' + pdfNotes.tet;
        if (day === 16 && pdfNotes.masaot)    note += '<br>' + pdfNotes.masaot;
        if (day === 21 && pdfNotes.mishatzim) note += '<br>' + pdfNotes.mishatzim;

        if (shanan) totalHours += parseFloat(shanan) || 0;

        const bg = vacation ? '#f0f0f0' : 'transparent';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="border:1px solid #000;padding:1px 2px;text-align:center;background:${bg};">${day}</td>
          <td style="border:1px solid #000;padding:1px 2px;text-align:center;background:${bg};">${dayNames[weekday]}</td>
          <td style="border:1px solid #000;padding:1px 2px;text-align:center;background:${bg};">${hours}</td>
          <td style="border:1px solid #000;padding:1px 2px;text-align:center;background:${bg};">${shanan}</td>
          <td style="border:1px solid #000;padding:1px 2px;text-align:center;background:${bg};">${kita}</td>
          <td colspan="2" style="border:1px solid #000;padding:1px 4px;text-align:right;background:${bg};">${desc}${reason ? ' â€” ' + reason : ''}</td>
          <td style="border:1px solid #000;padding:1px 4px;text-align:right;font-size:7pt;background:${bg};vertical-align:top;">${note}</td>
        `;
        tbody.appendChild(tr);
      }

      document.getElementById('pdf-total').textContent = totalHours || 0;

      // ×—×ª×™××” ×•×ª××¨×™×š ×‘×ª×—×ª×™×ª ×”-PDF
      const sigCell  = document.getElementById('pdf-sig-cell');
      const dateCell = document.getElementById('pdf-date-cell');
      if (sigDataUrl) {
        sigCell.textContent = '×—×ª×™××ª ×”××•×¨×”: ';
        const _sigImg = document.createElement('img');
        _sigImg.src = sigDataUrl;
        _sigImg.style.cssText = 'height:70px;vertical-align:middle;margin-right:4px;';
        sigCell.appendChild(_sigImg);
      } else {
        sigCell.textContent = '×—×ª×™××ª ×”××•×¨×”: ____________________';
      }
      dateCell.textContent = '×ª××¨×™×š: ' + dateDisplay;

      // ×—×ª×™××ª ×× ×”×œ/×ª â€” ×˜×¢×Ÿ ××—×“×© ×™×©×™×¨×•×ª ×-Firestore ×œ×¤× ×™ ×”×¤×§×ª ×”-PDF
      await loadPrincipalSignature(month, year);
      const principalCell = document.getElementById('pdf-principal-sig');
      if (_principalSigData) {
        principalCell.textContent = '×—×ª×™××ª ×”×× ×”×œ: ';
        const _prinImg = document.createElement('img');
        _prinImg.src = _principalSigData;
        _prinImg.style.cssText = 'height:56px;vertical-align:middle;margin-right:4px;';
        principalCell.appendChild(_prinImg);
      } else {
        principalCell.textContent = '×—×ª×™××ª ×”×× ×”×œ: ___________________________';
      }

      // ×¦×™×œ×•× ×¢× html2canvas
      const canvas = await html2canvas(document.getElementById('pdfPage'), {
        scale: 2,
        useCORS: true,
        logging: false,
        backgroundColor: '#ffffff',
      });

      // ×™×¦×™×¨×ª PDF
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
      pdf.addImage(imgData, 'PNG', 0, 0, 210, 297);
      _pdfPreviewShow(imgData, () => pdf.save(`×“×•×—-×©×œ×—-${MONTH_NAMES[month]}-${year}.pdf`));

    } catch(e) {
      alert('×©×’×™××” ×‘×™×™×¦×•× PDF: ' + e.message);
    } finally {
      btn.textContent = '×™×™×¦× PDF â¬‡';
      btn.disabled = false;
    }
  }


  // ×”×¤×¢×œ×” ×¨××©×•× ×™×ª ×‘×˜×¢×™× ×ª ×”×“×£
  updateCalendar();

  // ===== ××©"×œ =====

  function eshelKey(month, year) {
    return 'eshel_report_' + year + '_' + month;
  }

  // ×¢×“×›×•×Ÿ ×ª×¦×•×’×ª ×¤×¨×˜×™× ×§×‘×•×¢×™× ××”×”×’×“×¨×•×ª
  function refreshEshelInfo() {
    document.getElementById('eshel-info-id').textContent        = document.getElementById('idNumber').value;
    document.getElementById('eshel-info-firstname').textContent = document.getElementById('firstName').value;
    document.getElementById('eshel-info-lastname').textContent  = document.getElementById('lastName').value;
    document.getElementById('eshel-info-homecity').textContent  = document.getElementById('homeCity').value;
    document.getElementById('eshel-info-workplace').textContent = document.getElementById('workplace').value;
  }

  function saveEshel() {
    const month = parseInt(document.getElementById('eshelMonth').value);
    const year  = parseInt(document.getElementById('eshelYear').value);
    const rows  = [];
    document.querySelectorAll('#eshelBody tr').forEach(row => {
      rows.push({
        date:      row.querySelector('.eshel-date').value,
        dayname:   row.querySelector('.eshel-dayname').value,
        fromTime:  row.querySelector('.eshel-from-time').value,
        toTime:    row.querySelector('.eshel-to-time').value,
        fromPlace: row.querySelector('.eshel-from-place').value,
        toPlace:   row.querySelector('.eshel-to-place').value,
        purpose:   row.querySelector('.eshel-purpose').value,
        beinIri:   row.querySelector('.eshel-bein-iri').checked,
        iri:       row.querySelector('.eshel-iri').checked,
        boker:     row.querySelector('.eshel-boker').checked,
        tsaharaim: row.querySelector('.eshel-tsaharaim').checked,
        erev:      row.querySelector('.eshel-erev').checked,
        lina:      row.querySelector('.eshel-lina').value,
        total:     row.querySelector('.eshel-total').value,
      });
    });
    const data = {
      rows,
      date:      document.getElementById('eshelDate').value,
      signature: eshelSigIsEmpty() ? '' : eshelSigCanvas.toDataURL(),
    };
    localStorage.setItem(eshelKey(month, year), JSON.stringify(data));
    saveToCloud('eshel', eshelKey(month, year), data);
  }

  function applyEshel(data) {
    const rows = document.querySelectorAll('#eshelBody tr');
    (data.rows || []).forEach((rd, i) => {
      if (i >= rows.length) return;
      const row = rows[i];
      row.querySelector('.eshel-date').value        = rd.date      || '';
      row.querySelector('.eshel-dayname').value     = rd.dayname   || '';
      row.querySelector('.eshel-from-time').value   = rd.fromTime  || '';
      row.querySelector('.eshel-to-time').value     = rd.toTime    || '';
      row.querySelector('.eshel-from-place').value  = rd.fromPlace || '';
      row.querySelector('.eshel-to-place').value    = rd.toPlace   || '';
      row.querySelector('.eshel-purpose').value     = rd.purpose   || '';
      row.querySelector('.eshel-bein-iri').checked  = rd.beinIri   || false;
      row.querySelector('.eshel-iri').checked       = rd.iri       || false;
      row.querySelector('.eshel-boker').checked     = rd.boker     || false;
      row.querySelector('.eshel-tsaharaim').checked = rd.tsaharaim || false;
      row.querySelector('.eshel-erev').checked      = rd.erev      || false;
      row.querySelector('.eshel-lina').value        = rd.lina      || '';
      row.querySelector('.eshel-total').value       = rd.total     || '';
    });
    if (data.date) document.getElementById('eshelDate').value = data.date;
    if (data.signature) {
      const img = new Image();
      img.onload = () => eshelSigCtx.drawImage(img, 0, 0);
      img.src = data.signature;
    }
  }

  async function loadEshel(month, year) {
    // Clear everything first
    document.querySelectorAll('#eshelBody tr').forEach(row => {
      row.querySelector('.eshel-date').value        = '';
      row.querySelector('.eshel-dayname').value     = '';
      row.querySelector('.eshel-from-time').value   = '';
      row.querySelector('.eshel-to-time').value     = '';
      row.querySelector('.eshel-from-place').value  = '';
      row.querySelector('.eshel-to-place').value    = '';
      row.querySelector('.eshel-purpose').value     = '';
      row.querySelector('.eshel-bein-iri').checked  = false;
      row.querySelector('.eshel-iri').checked       = false;
      row.querySelector('.eshel-boker').checked     = false;
      row.querySelector('.eshel-tsaharaim').checked = false;
      row.querySelector('.eshel-erev').checked      = false;
      row.querySelector('.eshel-lina').value        = '';
      row.querySelector('.eshel-total').value       = '';
    });
    document.getElementById('eshelDate').value = '';
    eshelSigCtx.clearRect(0, 0, eshelSigCanvas.width, eshelSigCanvas.height);

    // Try Firestore first, fall back to localStorage
    const cloud = await loadFromCloud('eshel', eshelKey(month, year));
    if (cloud) {
      localStorage.setItem(eshelKey(month, year), JSON.stringify(cloud));
      applyEshel(cloud);
    } else {
      const raw = localStorage.getItem(eshelKey(month, year));
      if (!raw) return;
      applyEshel(JSON.parse(raw));
    }

    // Refresh wizard if active
    if (_currentEshelMode === 'wizard') renderWizard(0);
  }

  function clearEshel() {
    const month = parseInt(document.getElementById('eshelMonth').value);
    const year  = parseInt(document.getElementById('eshelYear').value);
    const monthName = document.getElementById('eshelMonth').selectedOptions[0].text;
    if (!confirm('×œ××—×•×§ ××ª ×›×œ × ×ª×•× ×™ ×”××©"×œ ×©×œ ' + monthName + ' ' + year + '?')) return;
    localStorage.removeItem(eshelKey(month, year));
    if (auth.currentUser) {
      const uid = auth.currentUser.uid;
      db.collection('users').doc(uid).collection('eshel').doc(eshelKey(month, year)).delete();
    }
    loadEshel(month, year);
  }

  // ××™×œ×•×™ ××•×˜×•××˜×™ ×©×œ ×™×•× ×‘×©×‘×•×¢ ×œ×¤×™ ×ª××¨×™×š
  function fillEshelDay(dateInput) {
    const row = dateInput.closest('tr');
    const dayField = row.querySelector('.eshel-dayname');
    if (!dateInput.value) { dayField.value = ''; saveEshel(); return; }
    const d = new Date(dateInput.value + 'T00:00:00');
    dayField.value = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'][d.getDay()];
    saveEshel();
  }

  // --- ×—×ª×™××” â€” ××©"×œ ---
  const eshelSigCanvas = document.getElementById('eshelSigCanvas');
  const eshelSigCtx    = eshelSigCanvas.getContext('2d');
  let eshelIsDrawing = false, eshelLastX = 0, eshelLastY = 0;

  function eshelSigPos(e) {
    const rect = eshelSigCanvas.getBoundingClientRect();
    const src  = e.touches ? e.touches[0] : e;
    return {
      x: (src.clientX - rect.left) * (eshelSigCanvas.width  / rect.width),
      y: (src.clientY - rect.top)  * (eshelSigCanvas.height / rect.height),
    };
  }

  function eshelSigIsEmpty() {
    return !eshelSigCtx.getImageData(0, 0, eshelSigCanvas.width, eshelSigCanvas.height).data.some(v => v !== 0);
  }

  function clearEshelSignature() {
    eshelSigCtx.clearRect(0, 0, eshelSigCanvas.width, eshelSigCanvas.height);
    saveEshel();
  }

  eshelSigCanvas.addEventListener('mousedown',  e => { eshelIsDrawing = true; const p = eshelSigPos(e); eshelLastX = p.x; eshelLastY = p.y; });
  eshelSigCanvas.addEventListener('mousemove',  e => {
    if (!eshelIsDrawing) return;
    const p = eshelSigPos(e);
    eshelSigCtx.beginPath(); eshelSigCtx.moveTo(eshelLastX, eshelLastY); eshelSigCtx.lineTo(p.x, p.y);
    eshelSigCtx.strokeStyle = '#000'; eshelSigCtx.lineWidth = 2; eshelSigCtx.lineCap = 'round';
    eshelSigCtx.stroke();
    eshelLastX = p.x; eshelLastY = p.y;
  });
  eshelSigCanvas.addEventListener('mouseup',    () => { if (eshelIsDrawing) { eshelIsDrawing = false; saveEshel(); } });
  eshelSigCanvas.addEventListener('mouseleave', () => { if (eshelIsDrawing) { eshelIsDrawing = false; saveEshel(); } });

  eshelSigCanvas.addEventListener('touchstart', e => { e.preventDefault(); eshelIsDrawing = true; const p = eshelSigPos(e); eshelLastX = p.x; eshelLastY = p.y; }, { passive: false });
  eshelSigCanvas.addEventListener('touchmove',  e => {
    e.preventDefault();
    if (!eshelIsDrawing) return;
    const p = eshelSigPos(e);
    eshelSigCtx.beginPath(); eshelSigCtx.moveTo(eshelLastX, eshelLastY); eshelSigCtx.lineTo(p.x, p.y);
    eshelSigCtx.strokeStyle = '#000'; eshelSigCtx.lineWidth = 2.5; eshelSigCtx.lineCap = 'round';
    eshelSigCtx.stroke();
    eshelLastX = p.x; eshelLastY = p.y;
  }, { passive: false });
  eshelSigCanvas.addEventListener('touchend', () => { if (eshelIsDrawing) { eshelIsDrawing = false; saveEshel(); } });

  // ×©××™×¨×” ××•×˜×•××˜×™×ª ×‘×›×œ ×©×™× ×•×™
  document.getElementById('eshelBody').addEventListener('input', saveEshel);
  document.getElementById('eshelBody').addEventListener('change', saveEshel);
  document.getElementById('eshelDate').addEventListener('change', saveEshel);

  // --- ×™×™×¦×•× PDF â€” ××©"×œ ---
  async function printEshel() {
    const btn = document.querySelector('#page-eshel .btn-print');
    btn.textContent = 'â³ ××›×™×Ÿ...';
    btn.disabled = true;

    try {
      const month = parseInt(document.getElementById('eshelMonth').value);
      const year  = parseInt(document.getElementById('eshelYear').value);
      const raw   = localStorage.getItem('shelach_settings');
      const s     = raw ? JSON.parse(raw) : {};

      // ××™×œ×•×™ ×¤×¨×˜×™ ×¢×•×‘×“
      document.getElementById('eshel-pdf-id').textContent        = s.idNumber  || '';
      document.getElementById('eshel-pdf-lastname').textContent  = s.lastName  || '';
      document.getElementById('eshel-pdf-firstname').textContent = s.firstName || '';
      document.getElementById('eshel-pdf-homecity').textContent  = s.homeCity  || '';
      document.getElementById('eshel-pdf-workplace').textContent = s.workplace || '';
      document.getElementById('eshel-pdf-month').textContent     = MONTH_NAMES[month];
      document.getElementById('eshel-pdf-year').textContent      = year;

      // ××™×œ×•×™ ×©×•×¨×•×ª ×”×˜×‘×œ×” ×”×¡×˜×˜×™×•×ª
      const pdfRows    = document.querySelectorAll('#eshelPdfPage .epd-row');
      const screenRows = document.querySelectorAll('#eshelBody tr');
      pdfRows.forEach((pdfRow, i) => {
        const screenRow = screenRows[i];
        let dt='', dy='', ft='', tt='', fp='', tp='', pu='', bi='', ir='', bk='', ts='', ev='', ln='', tot='';
        if (screenRow) {
          const dateVal = screenRow.querySelector('.eshel-date').value;
          if (dateVal) {
            const d = new Date(dateVal + 'T00:00:00');
            dt = d.toLocaleDateString('he-IL');
          }
          dy  = screenRow.querySelector('.eshel-dayname').value;
          ft  = screenRow.querySelector('.eshel-from-time').value;
          tt  = screenRow.querySelector('.eshel-to-time').value;
          fp  = screenRow.querySelector('.eshel-from-place').value;
          tp  = screenRow.querySelector('.eshel-to-place').value;
          pu  = screenRow.querySelector('.eshel-purpose').value;
          bi  = screenRow.querySelector('.eshel-bein-iri').checked  ? 'âœ“' : '';
          ir  = screenRow.querySelector('.eshel-iri').checked        ? 'âœ“' : '';
          bk  = screenRow.querySelector('.eshel-boker').checked      ? 'âœ“' : '';
          ts  = screenRow.querySelector('.eshel-tsaharaim').checked  ? 'âœ“' : '';
          ev  = screenRow.querySelector('.eshel-erev').checked       ? 'âœ“' : '';
          ln  = screenRow.querySelector('.eshel-lina').value || '';
          tot = screenRow.querySelector('.eshel-total').value;
        }
        pdfRow.querySelector('.epd-dt').textContent  = dt  || '\u00A0';
        pdfRow.querySelector('.epd-dy').textContent  = dy  || '\u00A0';
        pdfRow.querySelector('.epd-ft').textContent  = ft  || '\u00A0';
        pdfRow.querySelector('.epd-tt').textContent  = tt  || '\u00A0';
        pdfRow.querySelector('.epd-fp').textContent  = fp  || '\u00A0';
        pdfRow.querySelector('.epd-tp').textContent  = tp  || '\u00A0';
        pdfRow.querySelector('.epd-pu').textContent  = pu  || '\u00A0';
        pdfRow.querySelector('.epd-bi').textContent  = bi  || '\u00A0';
        pdfRow.querySelector('.epd-ir').textContent  = ir  || '\u00A0';
        pdfRow.querySelector('.epd-bk').textContent  = bk  || '\u00A0';
        pdfRow.querySelector('.epd-ts').textContent  = ts  || '\u00A0';
        pdfRow.querySelector('.epd-ev').textContent  = ev  || '\u00A0';
        pdfRow.querySelector('.epd-ln').textContent  = ln  || '\u00A0';
        pdfRow.querySelector('.epd-tot').textContent = tot || '\u00A0';
      });

      // ×—×ª×™××” ×•×ª××¨×™×š
      const sigDataUrl  = eshelSigIsEmpty() ? '' : eshelSigCanvas.toDataURL();
      const rawDate     = document.getElementById('eshelDate').value;
      const dateDisplay = rawDate
        ? new Date(rawDate + 'T00:00:00').toLocaleDateString('he-IL')
        : '_______________';

      const sigCell  = document.getElementById('eshel-pdf-sig-cell');
      const dateCell = document.getElementById('eshel-pdf-date-cell');
      if (sigDataUrl) {
        sigCell.textContent = '×—×ª×™××ª ×”×¢×•×‘×“: ';
        const _eshelSigImg = document.createElement('img');
        _eshelSigImg.src = sigDataUrl;
        _eshelSigImg.style.cssText = 'height:70px;vertical-align:middle;margin-right:4px;';
        sigCell.appendChild(_eshelSigImg);
      } else {
        sigCell.textContent = '×—×ª×™××ª ×”×¢×•×‘×“: ________________________________';
      }
      dateCell.textContent = '×ª××¨×™×š: ' + dateDisplay;

      // ×¦×™×œ×•× ×¢× html2canvas (×”×“×™×‘ ×”×•× 1122Ã—794px â€” A4 ×œ×¨×•×—×‘)
      const canvas = await html2canvas(document.getElementById('eshelPdfPage'), {
        scale: 2,
        useCORS: true,
        logging: false,
        backgroundColor: '#ffffff',
        width:  1122,
        height: 794,
      });

      // ×™×¦×™×¨×ª PDF ×œ×¨×•×—×‘ (Landscape A4 = 297Ã—210mm)
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
      pdf.addImage(imgData, 'PNG', 0, 0, 297, 210);
      _pdfPreviewShow(imgData, () => pdf.save(`××©×œ-${MONTH_NAMES[month]}-${year}.pdf`));

    } catch(e) {
      alert('×©×’×™××” ×‘×™×™×¦×•× PDF: ' + e.message);
    } finally {
      btn.textContent = '×™×™×¦× PDF â¬‡';
      btn.disabled = false;
    }
  }

  // --- ×™×™×¦×•× ××§×¡×œ ---

  function exportReportToExcel() {
    const month = parseInt(document.getElementById('selectMonth').value);
    const year  = parseInt(document.getElementById('selectYear').value);
    const monthName = MONTH_NAMES[month];

    const s = {
      firstName:  document.getElementById('firstName').value,
      lastName:   document.getElementById('lastName').value,
      idNumber:   document.getElementById('idNumber').value,
      schoolName: document.getElementById('schoolName').value,
    };

    const rows = [['×™×•× ×‘×—×•×“×©','×™×•× ×‘×©×‘×•×¢','×©×¢×•×ª ×”×™×¢×“×¨×•×ª','×©"× /×"×','×›×™×ª×”','×ª×™××•×¨ ×¤×¢×™×œ×•×ª','×¡×™×‘×ª ×”×™×¢×“×¨×•×ª']];
    document.querySelectorAll('#reportBody tr').forEach(row => {
      if (row.style.display === 'none') return;
      const inputs = row.querySelectorAll('input');
      rows.push([
        row.dataset.day,
        row.cells[1]?.textContent || '',
        inputs[0]?.value || '',
        inputs[1]?.value || '',
        inputs[2]?.value || '',
        inputs[3]?.value || '',
        inputs[4]?.value || '',
      ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(rows);
    ws['!cols'] = [8,10,14,10,10,30,20].map(w => ({ wch: w }));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, monthName);
    XLSX.writeFile(wb, `×“×•×—-×©×œ×—-${monthName}-${year}.xlsx`);
  }

  function exportEshelToExcel() {
    const month = parseInt(document.getElementById('eshelMonth').value);
    const year  = parseInt(document.getElementById('eshelYear').value);
    const monthName = MONTH_NAMES[month];

    const rows = [['×ª××¨×™×š','×™×•×','××©×¢×”','×¢×“ ×©×¢×”','×××§×•×','×œ××§×•×','××˜×¨×ª ×”×¤×¢×•×œ×”','×‘×™×Ÿ-×¢×™×¨×•× ×™','×¢×™×¨×•× ×™','×‘×•×§×¨','×¦×”×¨×™×™×','×¢×¨×‘','×œ×™× ×”','×¡×”"×›']];
    document.querySelectorAll('#eshelBody tr').forEach(row => {
      rows.push([
        row.querySelector('.eshel-date').value,
        row.querySelector('.eshel-dayname').value,
        row.querySelector('.eshel-from-time').value,
        row.querySelector('.eshel-to-time').value,
        row.querySelector('.eshel-from-place').value,
        row.querySelector('.eshel-to-place').value,
        row.querySelector('.eshel-purpose').value,
        row.querySelector('.eshel-bein-iri').checked  ? '×›×Ÿ' : '',
        row.querySelector('.eshel-iri').checked        ? '×›×Ÿ' : '',
        row.querySelector('.eshel-boker').checked      ? '×›×Ÿ' : '',
        row.querySelector('.eshel-tsaharaim').checked  ? '×›×Ÿ' : '',
        row.querySelector('.eshel-erev').checked       ? '×›×Ÿ' : '',
        row.querySelector('.eshel-lina').value || '',
        row.querySelector('.eshel-total').value,
      ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(rows);
    ws['!cols'] = [12,8,8,8,14,14,24,10,8,8,8,8,8,8].map(w => ({ wch: w }));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, monthName);
    XLSX.writeFile(wb, `××©×œ-${monthName}-${year}.xlsx`);
  }

  // --- ×—×ª×™××ª ×× ×”×œ â€” ×˜×¢×™× ×” ×œ×“×•×— ---

  let _principalSigData = null; // base64 of principal signature, or null

  async function loadPrincipalSignature(month, year) {
    _principalSigData = null;
    const statusDiv = document.getElementById('principalSigStatus');
    if (!statusDiv) return;

    if (!auth.currentUser) {
      statusDiv.innerHTML = '';
      return;
    }

    statusDiv.innerHTML = '<span style="color:#aaa;font-size:13px;">×‘×•×“×§ ×—×ª×™××ª ×× ×”×œ/×ª...</span>';

    try {
      const uid   = auth.currentUser.uid;
      const docId = uid + '_' + year + '_' + month;
      const snap  = await db.collection('signature_requests').doc(docId).get();

      if (!snap.exists) {
        statusDiv.innerHTML = '<span style="color:#aaa;font-size:13px;">×—×ª×™××ª ×× ×”×œ/×ª: ×˜×¨× × ×©×œ×—×” ×œ×—×ª×™××”</span>';
        return;
      }

      const data = snap.data();
      if (data.status !== 'signed') {
        statusDiv.innerHTML = '<span style="color:#b7860b;font-size:13px;">â³ ×××ª×™×Ÿ ×œ×—×ª×™××ª ×× ×”×œ/×ª</span>';
        return;
      }

      _principalSigData = data.principalSignature;
      statusDiv.innerHTML = `
        <div style="font-size:13px;font-weight:600;color:#155724;margin-bottom:8px;text-align:center;">âœ“ ×—×ª×™××ª ×× ×”×œ/×ª ×”×ª×§×‘×œ×”</div>
        <div style="text-align:center;"><img src="${data.principalSignature}" style="max-height:60px;border:1px solid #ddd;border-radius:6px;padding:4px;background:#fff;"></div>
      `;
    } catch(e) {
      statusDiv.innerHTML = '<span style="color:#aaa;font-size:13px;">×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×¡×˜×˜×•×¡ ×—×ª×™××”</span>';
      console.error('loadPrincipalSignature error:', e);
    }
  }

  // --- ×—×ª×™××ª ×× ×”×œ ---

  async function createSignatureRequest() {
    if (!auth.currentUser) { alert('×™×© ×œ×”×ª×—×‘×¨ ×ª×—×™×œ×”'); return; }

    const month = parseInt(document.getElementById('selectMonth').value);
    const year  = parseInt(document.getElementById('selectYear').value);
    const monthName = MONTH_NAMES[month];

    const teacherName = [
      document.getElementById('firstName').value,
      document.getElementById('lastName').value,
    ].filter(Boolean).join(' ') || '××•×¨×”';
    const schoolName = document.getElementById('schoolName').value || '';

    // Save current report state first
    saveReport();

    // Collect a snapshot of the report rows for the principal to review
    const reportSnapshot = {};
    const hebDays = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];
    document.querySelectorAll('#reportBody tr').forEach(row => {
      if (row.style.display === 'none') return;
      const day = row.dataset.day;
      const inputs = row.querySelectorAll('input');
      const hours = inputs[0]?.value || '';
      const sub   = inputs[1]?.value || '';
      const kita  = inputs[2]?.value || '';
      const desc  = inputs[3]?.value || '';
      const rsn   = inputs[4]?.value || '';
      if (!hours && !sub && !kita && !desc && !rsn) return; // skip empty rows
      const weekday = new Date(year, month, parseInt(day)).getDay();
      reportSnapshot[day] = { hours, substitute: sub, kita, description: desc, reason: rsn, weekday: hebDays[weekday] };
    });

    // Use deterministic docId â€” no composite index needed
    const uid   = auth.currentUser.uid;
    const docId = uid + '_' + year + '_' + month;
    const ref   = db.collection('signature_requests').doc(docId);
    const snap  = await ref.get();

    if (snap.exists) {
      // Update snapshot + teacher info, preserve existing status/signature
      await ref.update({ teacherName, schoolName, reportSnapshot });
    } else {
      await ref.set({
        teacherUid:  uid,
        teacherName: teacherName,
        schoolName:  schoolName,
        month:       month,
        year:        year,
        status:      'pending',
        principalSignature: '',
        reportSnapshot,
        createdAt:   firebase.firestore.FieldValue.serverTimestamp(),
      });
    }

    const link = window.location.origin + window.location.pathname + '?sign=' + docId;
    document.getElementById('signLink').value = link;

    const status = snap.exists ? snap.data().status : 'pending';
    const badge = document.getElementById('signStatusWrap');
    if (status === 'signed') {
      badge.innerHTML = '<span class="sign-status-badge signed">âœ“ ×”×“×•×— × ×—×ª× ×¢×œ ×™×“×™ ×”×× ×”×œ/×ª</span>';
    } else {
      badge.innerHTML = '<span class="sign-status-badge pending">×××ª×™×Ÿ ×œ×—×ª×™××”</span>';
    }

    document.getElementById('signModal').classList.add('open');
  }

  // --- PDF Preview Modal ---
  let _pdfPreviewCallback = null;
  function _pdfPreviewShow(imgData, downloadFn) {
    _pdfPreviewCallback = downloadFn;
    document.getElementById('pdfPreviewImg').src = imgData;
    document.getElementById('pdfPreviewModal').classList.add('open');
  }
  function _pdfPreviewDownload() {
    if (_pdfPreviewCallback) _pdfPreviewCallback();
    _pdfPreviewClose();
  }
  function _pdfPreviewClose() {
    document.getElementById('pdfPreviewModal').classList.remove('open');
    document.getElementById('pdfPreviewImg').src = '';
    _pdfPreviewCallback = null;
  }
  // Close on backdrop click
  document.getElementById('pdfPreviewModal').addEventListener('click', function(e) {
    if (e.target === this) _pdfPreviewClose();
  });

  function closeSignModal() {
    document.getElementById('signModal').classList.remove('open');
    document.getElementById('signCopyBtn').textContent = '×”×¢×ª×§ ×œ×™× ×§';
  }

  function copySignLink() {
    const link = document.getElementById('signLink').value;
    navigator.clipboard.writeText(link).then(() => {
      document.getElementById('signCopyBtn').textContent = 'âœ“ ×”×•×¢×ª×§!';
      setTimeout(() => {
        document.getElementById('signCopyBtn').textContent = '×”×¢×ª×§ ×œ×™× ×§';
      }, 2000);
    });
  }

  function shareViaWhatsApp() {
    const link = document.getElementById('signLink').value;
    const text = encodeURIComponent('×©×œ×•×, ×× × ×¤×ª×—/×™ ××ª ×”×œ×™× ×§ ×”×‘× ×œ×—×ª×™××” ×¢×œ ×“×•×— ×¤×¢×™×œ×•×ª ×©×œ"×—:\n' + link);
    window.open('https://wa.me/?text=' + text, '_blank');
  }

  function shareViaGmail() {
    const link = document.getElementById('signLink').value;
    const subject = encodeURIComponent('×‘×§×©×” ×œ×—×ª×™××” ×¢×œ ×“×•×— ×¤×¢×™×œ×•×ª ×©×œ"×—');
    const body = encodeURIComponent('×©×œ×•×,\n\n×× × ×¤×ª×—/×™ ××ª ×”×œ×™× ×§ ×”×‘× ×œ×—×ª×™××” ×¢×œ ×”×“×•×—:\n' + link + '\n\n×ª×•×“×”');
    window.open('https://mail.google.com/mail/?view=cm&fs=1&su=' + subject + '&body=' + body, '_blank');
  }

  // --- ×¢××•×“ ×—×ª×™××ª ×× ×”×œ ---

  let _principalDocId = null;
  let _principalIsDrawing = false, _principalLastX = 0, _principalLastY = 0;

  function principalSigPos(e) {
    const canvas = document.getElementById('principalSigCanvas');
    const rect = canvas.getBoundingClientRect();
    const src  = e.touches ? e.touches[0] : e;
    return {
      x: (src.clientX - rect.left) * (canvas.width  / rect.width),
      y: (src.clientY - rect.top)  * (canvas.height / rect.height),
    };
  }

  function principalSigIsEmpty() {
    const canvas = document.getElementById('principalSigCanvas');
    return !canvas.getContext('2d').getImageData(0, 0, canvas.width, canvas.height).data.some(v => v !== 0);
  }

  function clearPrincipalSig() {
    const canvas = document.getElementById('principalSigCanvas');
    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
  }

  function initPrincipalSigCanvas() {
    const canvas = document.getElementById('principalSigCanvas');
    const ctx = canvas.getContext('2d');

    canvas.addEventListener('mousedown', e => {
      _principalIsDrawing = true;
      const p = principalSigPos(e); _principalLastX = p.x; _principalLastY = p.y;
    });
    canvas.addEventListener('mousemove', e => {
      if (!_principalIsDrawing) return;
      const p = principalSigPos(e);
      ctx.beginPath(); ctx.moveTo(_principalLastX, _principalLastY); ctx.lineTo(p.x, p.y);
      ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.stroke();
      _principalLastX = p.x; _principalLastY = p.y;
    });
    canvas.addEventListener('mouseup',    () => { _principalIsDrawing = false; });
    canvas.addEventListener('mouseleave', () => { _principalIsDrawing = false; });
    canvas.addEventListener('touchstart', e => {
      e.preventDefault(); _principalIsDrawing = true;
      const p = principalSigPos(e); _principalLastX = p.x; _principalLastY = p.y;
    }, { passive: false });
    canvas.addEventListener('touchmove', e => {
      e.preventDefault();
      if (!_principalIsDrawing) return;
      const p = principalSigPos(e);
      ctx.beginPath(); ctx.moveTo(_principalLastX, _principalLastY); ctx.lineTo(p.x, p.y);
      ctx.strokeStyle = '#000'; ctx.lineWidth = 2.5; ctx.lineCap = 'round'; ctx.stroke();
      _principalLastX = p.x; _principalLastY = p.y;
    }, { passive: false });
    canvas.addEventListener('touchend', () => { _principalIsDrawing = false; });
  }

  async function initPrincipalPage(docId) {
    _principalDocId = docId;

    // Hide normal app UI, show principal page
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('principalPage').classList.add('active');
    const header = document.querySelector('header');
    const tabs   = document.querySelector('.tabs');
    if (header) header.style.display = 'none';
    if (tabs)   tabs.style.display   = 'none';
    document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
    // Allow vertical scrolling (overrides the mobile overflow-x:hidden fix)
    document.documentElement.style.overflowY = 'auto';
    document.body.style.overflowY = 'auto';

    initPrincipalSigCanvas();

    // Load the request from Firestore
    const snap = await db.collection('signature_requests').doc(docId).get();
    if (!snap.exists) {
      document.getElementById('principalInfo').innerHTML =
        '<div style="color:#c00;">×”×œ×™× ×§ ××™× ×• ×ª×§×£ ××• ×¤×’ ×ª×•×§×£.</div>';
      document.getElementById('principalSubmitBtn').style.display = 'none';
      return;
    }

    const data = snap.data();
    const monthName = ['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'][data.month];

    // Safely render teacher info using textContent (prevents XSS)
    const infoDiv = document.getElementById('principalInfo');
    infoDiv.innerHTML = '';
    [['××•×¨×”', data.teacherName], ['×‘×™×ª ×¡×¤×¨', data.schoolName], ['×—×•×“×©', monthName + ' ' + data.year]].forEach(([label, val]) => {
      const row = document.createElement('div');
      row.className = 'principal-info-row';
      const strong = document.createElement('strong');
      strong.textContent = val || '';
      row.append(label + ': ', strong);
      infoDiv.appendChild(row);
    });

    // Safely render report snapshot table using DOM (prevents XSS)
    const snapshot = data.reportSnapshot || {};
    const days = Object.keys(snapshot).map(Number).sort((a, b) => a - b);
    if (days.length > 0) {
      const table = document.createElement('table');
      const thead = table.createTHead();
      const hRow = thead.insertRow();
      ['×™×•×','×™×•× ×‘×©×‘×•×¢','×©×¢×•×ª ×”×™×¢×“×¨×•×ª','×©"× /×"×','×›×™×ª×”','×ª×™××•×¨ ×¤×¢×•×œ×”','×¡×™×‘×”'].forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        hRow.appendChild(th);
      });
      const tbody = table.createTBody();
      days.forEach(day => {
        const r = snapshot[day];
        const tr = tbody.insertRow();
        [day, r.weekday, r.hours, r.substitute, r.kita, r.description, r.reason].forEach((val, i) => {
          const td = tr.insertCell();
          td.textContent = val || '';
          if (i >= 5) td.style.textAlign = 'right';
        });
      });
      const reportEl = document.getElementById('principalReport');
      reportEl.innerHTML = '';
      reportEl.appendChild(table);
      document.getElementById('principalReportCard').style.display = 'block';
    }

    // If already signed, show the existing signature
    if (data.status === 'signed' && data.principalSignature) {
      const canvas = document.getElementById('principalSigCanvas');
      const img = new Image();
      img.onload = () => canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
      img.src = data.principalSignature;
      document.getElementById('principalSubmitBtn').textContent = '×¢×“×›×Ÿ ×—×ª×™××” âœ“';
    }
  }

  async function submitPrincipalSignature() {
    if (principalSigIsEmpty()) {
      alert('×™×© ×œ×—×ª×•× ×œ×¤× ×™ ×”×©×œ×™×—×”');
      return;
    }

    const canvas = document.getElementById('principalSigCanvas');
    const sigData = canvas.toDataURL();
    const btn = document.getElementById('principalSubmitBtn');
    btn.textContent = 'â³ ×©×•×œ×—...';
    btn.disabled = true;

    try {
      await db.collection('signature_requests').doc(_principalDocId).update({
        principalSignature: sigData,
        status:    'signed',
        signedAt:  firebase.firestore.FieldValue.serverTimestamp(),
      });

      // Show success
      document.querySelector('.principal-card:first-of-type').style.display = 'none';
      document.getElementById('principalSuccess').style.display = 'block';
    } catch(e) {
      alert('×©×’×™××” ×‘×©×œ×™×—×”: ' + e.message);
      btn.textContent = '×—×ª×•× ×•×©×œ×— âœ“';
      btn.disabled = false;
    }
  }

  // Check URL for ?sign= param
  (function() {
    const params = new URLSearchParams(window.location.search);
    const signId = params.get('sign');
    if (signId) {
      // Wait for DOM then init principal page (no auth needed)
      document.addEventListener('DOMContentLoaded', () => initPrincipalPage(signId));
      // If DOM is already ready
      if (document.readyState !== 'loading') initPrincipalPage(signId);
    }
  })();

  // ×”×¤×¢×œ×” ×¨××©×•× ×™×ª ×©×œ ××©"×œ
  loadEshel(
    parseInt(document.getElementById('eshelMonth').value),
    parseInt(document.getElementById('eshelYear').value)
  );
</script>

<!-- ×¤×× ×œ ×™×•× â€” ××¦×‘ ×œ×•×— ×©× ×” -->
<div id="day-panel">
  <div class="day-panel-box">
    <div class="day-panel-header">
      <h3 id="day-panel-title"></h3>
      <button class="day-panel-close" onclick="closeDayPanel()">âœ•</button>
    </div>
    <div class="day-panel-fields">
      <div><label>×©×¢×•×ª ×”×™×¢×“×¨×•×ª</label><input id="dp-hours" type="number" min="0" placeholder="0"></div>
      <div><label>×©"×  / ×"×</label><input id="dp-substitute" type="text" placeholder="×©"×  ××• ×"×"></div>
      <div><label>×›×™×ª×”</label><input id="dp-kita" type="text" placeholder="×©× ×”×›×™×ª×”"></div>
      <div><label>×ª×™××•×¨ ×”×¤×¢×•×œ×”</label><input id="dp-description" type="text" placeholder="×ª×™××•×¨..."></div>
      <div><label>×¡×™×‘×” ×œ×”×™×¢×“×¨×•×ª / ×©×¢×•×ª × ×•×¡×¤×•×ª</label><input id="dp-reason" type="text" placeholder="×¡×™×‘×”..."></div>
    </div>
    <div class="day-panel-actions">
      <button class="btn-panel-save" onclick="saveDayPanel()">×©××•×¨</button>
      <button class="btn-panel-clear" onclick="clearDayPanel()">× ×§×” ×™×•×</button>
      <button class="btn-panel-close" onclick="closeDayPanel()">×¡×’×•×¨</button>
    </div>
  </div>
</div>

<!-- ××•×“×œ ×ª×¦×•×’×” ××§×“×™××” ×©×œ PDF -->
<div id="pdfPreviewModal">
  <div class="pdf-preview-box">
    <img id="pdfPreviewImg" src="" alt="×ª×¦×•×’×” ××§×“×™××”">
    <div class="pdf-preview-btns">
      <button class="btn-pdf-download" onclick="_pdfPreviewDownload()">×”×•×¨×“ PDF â¬‡</button>
      <button class="btn-pdf-cancel" onclick="_pdfPreviewClose()">×¡×’×•×¨</button>
    </div>
  </div>
</div>

<!-- ××•×“×œ ×©×™×ª×•×£ ×œ×™× ×§ ×—×ª×™××ª ×× ×”×œ -->
<div id="signModal">
  <div class="sign-modal-box">
    <h2>âœ ×©×œ×— ×œ×—×ª×™××ª ×× ×”×œ/×ª</h2>
    <p>×©×œ×— ××ª ×”×œ×™× ×§ ×”×‘× ×œ×× ×”×œ/×ª. ×”× ×™×•×›×œ×• ×œ×¤×ª×•×— ××•×ª×•, ×œ×¨××•×ª ××ª ×”×“×•×— ×•×œ×—×ª×•×.</p>
    <div id="signStatusWrap" style="margin-bottom:14px;"></div>
    <input id="signLink" type="text" readonly>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button id="signCopyBtn" onclick="copySignLink()">×”×¢×ª×§ ×œ×™× ×§</button>
      <button onclick="closeSignModal()"
        style="background:#eee;border:none;border-radius:8px;padding:10px 18px;font-size:14px;cursor:pointer;font-family:inherit;">
        ×¡×’×•×¨
      </button>
    </div>
    <div class="sign-share-row">
      <span>×©×ª×£ ×“×¨×š:</span>
      <button class="btn-share-wa" onclick="shareViaWhatsApp()">
        <svg viewBox="0 0 32 32" width="18" height="18" fill="white"><path d="M16 2C8.28 2 2 8.28 2 16c0 2.44.64 4.73 1.76 6.72L2 30l7.48-1.73A13.93 13.93 0 0016 30c7.72 0 14-6.28 14-14S23.72 2 16 2zm0 25.4a11.36 11.36 0 01-5.8-1.59l-.42-.25-4.44 1.03 1.06-4.33-.27-.44A11.36 11.36 0 014.6 16c0-6.29 5.12-11.4 11.4-11.4S27.4 9.71 27.4 16 22.29 27.4 16 27.4zm6.24-8.52c-.34-.17-2.02-1-2.33-1.11-.32-.12-.54-.17-.77.17-.23.34-.88 1.11-1.08 1.34-.2.23-.4.26-.74.09-.34-.17-1.44-.53-2.74-1.69-1.01-.9-1.7-2.01-1.9-2.35-.2-.34-.02-.52.15-.69.15-.15.34-.4.51-.6.17-.2.23-.34.34-.57.12-.23.06-.43-.03-.6-.09-.17-.77-1.85-1.05-2.54-.28-.67-.56-.58-.77-.59h-.65c-.23 0-.6.09-.91.43-.31.34-1.19 1.16-1.19 2.83s1.22 3.28 1.39 3.51c.17.23 2.4 3.66 5.82 5.14.81.35 1.44.56 1.94.72.81.26 1.55.22 2.14.13.65-.1 2.02-.83 2.3-1.62.29-.8.29-1.48.2-1.62-.08-.14-.3-.23-.64-.4z"/></svg>
        WhatsApp
      </button>
      <button class="btn-share-gmail" onclick="shareViaGmail()">
        <svg viewBox="0 0 32 32" width="18" height="18" fill="white"><path d="M28 6H4a2 2 0 00-2 2v16a2 2 0 002 2h24a2 2 0 002-2V8a2 2 0 00-2-2zm0 2v.51l-12 7.74L4 8.51V8h24zM4 24V11.13l11.45 7.38a1 1 0 001.1 0L28 11.13V24H4z"/></svg>
        Gmail
      </button>
    </div>
  </div>
</div>

</body>
</html>
